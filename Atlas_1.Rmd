---
title: "Vison"
author: "Suzanne Bonamour"
output:
  html_document:
    df_print: paged
    toc: true # table of content true
    toc_float: true
    number_sections: true
    toc_depth: 6
    theme: journal
  pdf_document: default
  date: "2024-09-04"
---

\newpage <!-- # adds new page after title -->
\tableofcontents <!-- # adds table of contents -->
\listoffigures
\listoftables
\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, message=FALSE}
library(readxl)
library(dplyr)
library(ggplot2)
library(lubridate)
library(scales)
library(writexl)
library(tidyverse)
library(DT)
library(forcats)
library(broom)
library(lme4)
library(glmmTMB)
library(sjPlot)
library(gridExtra)
library(MuMIn)
library(car)
library(reshape)
library(RCT)
library(ggpubr)
library(ggsignif)
library(distillery)

# {.tabset}
```

# Jeux de données d'origine

```{r, message=FALSE}
detection <- read_excel("C:/Users/Suzanne.Bonamour/OneDrive - LPO/2) Data/1) Vison/0) Origin/BDD_Détection_Vison_Brouage_Seudre_v11_sans_taupe.xlsx")
piege <- read_excel("C:/Users/Suzanne.Bonamour/OneDrive - LPO/2) Data/1) Vison/0) Origin/Data_fiches_terrain_Vison Brouage_Seudre_v8.xlsx")
RefEsp <- read_excel("C:/Users/Suzanne.Bonamour/OneDrive - LPO/2) Data/1) Vison/1) Analyses/Referenciel_Espece_Vison.xlsx")
```
# Pré-traitement des données 

## Noms de colonnes 

Changement nom de colonnes pour plus de praticité (noms courts, sans accent ni espace).

```{r}
# detection 
detection_2 <- detection %>% 
  dplyr::rename(ID_piege = "ID_piège-photo", 
         ID_unique = "ID numero point unique", 
         date_obs = "Date_Obs", 
         heure = "Heure (hiver)", 
         temp = "Température (°C)", 
         espece = "Espèce",
         nb_ind = "Nb_d'individus", 
         DAC = "Présence_DAC", 
         DAC_interaction = "Interaction_DAC", 
         remarques_detection = "Remarques", 
         nb_detection = "Nb_detection")

# piege
piege_2 <- piege %>% 
  dplyr::rename(ID_unique = "Numéro point (unique)", 
         operateur_pose = "opérateur de pose", 
         ID_piege = "PP (id interne)", 
         date_pose = "Date de pose",
         date_retrait = "Date de retrait", 
         distance_eau = "Distance à l'eau (permanente) du PP (en cm)", 
         hauteur =  "Hauteur de fixation (en cm)",
         support = "Support de pose", 
         DAC_piege = "Présence DAC", 
         coulee = "Présence coulée bien marquée", 
         remarques_piege = "Remarques générales",
         habitat = "Habitat structurant", 
         date_fin_obs = "PressObs - date dernier jour valide de suivi",
         duree_obs = "PressObs - durée",
         dysfonctionnement = "PressObs - raison dysfonctionnement/decl parasite", 
         saisie = "Saisie Data", 
         operateur_saisie = "Opérateur saisie", 
         saisie_faune17 = "Saisie Faune17", 
         proprio_prevenu = "proprio prévenu",
         nb_photo_valide = "Nb photos valide", 
         nb_photo_total = "Nb photos total", 
         nb_decl = "Nb décl")
```

## Catégories habitat

Changement nom de la variable habitat :

"Fourrés (ronciers, prunelliers, etc.)" -> Fourrés

"Ripisylves à sous-étage clair" -> Ripisylves

"Roselière" -> Roselière

"Herbacées hautes, joncs" -> Herbacées

"Berge sous pont" -> Berge sous pont

"Absence de végétation" -> Absence de végétation

```{r, echo=FALSE}
piege_2$habitat[piege_2$habitat=="Fourrés (ronciers, prunelliers, etc.)"] <- "Fourrés"
piege_2$habitat[piege_2$habitat=="Ripisylves à sous-étage clair"] <- "Ripisylves"
piege_2$habitat[piege_2$habitat=="Herbacées hautes, joncs"] <- "Herbacées"
```

```{r, echo=FALSE}
# detection 
detection_3 <- detection_2 %>% 
  select(ID_piege,ID_unique,date_obs,heure,temp,espece,DAC,DAC_interaction,nb_detection)

# piege
piege_3 <- piege_2[!is.na(piege_2$ID_unique),]
piege_4 <- piege_3 %>% 
  select(ID_unique,ID_piege,date_pose,date_retrait,distance_eau,hauteur,support,DAC_piege,coulee,habitat,
         date_fin_obs,duree_obs,nb_photo_valide,nb_photo_total,nb_decl)
```

## Piege photo à retirer 

Retirer les piege photo avec un problème.

```{r, warning=FALSE, message=FALSE}
piege_5 <- piege_4[piege_4$ID_unique!=90 &
                    piege_4$ID_unique!=107 &
                    piege_4$ID_unique!=108 &
                    piege_4$ID_unique!=147 &
                    piege_4$ID_unique!=415,]
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Jointure des deux jeux de données ------------------------------- 

data_1 <- left_join(detection_3, piege_5)
```
## Année, jour & heure

year_obs = année 

month_obs = mois (1 = janvier, 2 = fevrier, ...)

day_obs = jour de l'année (1 = 1 er janvier, 2 = 2 janvier, ...)

```{r, echo=FALSE}
data_1$year_obs <- year(data_1$date_obs)
data_1$month_obs <- month(data_1$date_obs)
data_1$day_obs <- yday(data_1$date_obs)
# data_1$day_obs <- yday(data_1$date_obs) - yday(start)
data_1$hour_obs <- hour(data_1$heure)

# startdate <- as.Date("2000/09/01", "%Y/%m/%d")
# date_test <- as.Date("2000/08/05", "%Y/%m/%d")
# NumDays  <- difftime(date_test, startdate, units="days") + 1 ; NumDays
# 
# df$Date2 <-  as.Date(df$Date,"%d/%m/%Y")
```

## Doublons ?

Si 0, alors pas de doublons -> RAS !

```{r, echo=FALSE}
nb_observation_focal <- dim(distinct(data_1))[1] #; nb_observation_focal
nb_lignes_doublons <- dim(data_1)[1] - nb_observation_focal #; nb_lignes_doublons

doublons <- duplicated(data_1)
data_2 <- cbind(data_1, doublons)
data_doublons <- data_2[data_2$doublons == T,]
data_doublons

# Doublons retiré dans le ficher excel par Sylvain.
# Fichier ok, plus de doublons.
```

## Espèces à retirer 

```{r}
data_3 <- data_2[data_2$espece!="Humain",]
```

```{r, echo=FALSE}
# liste des noms d'espèce utilisées pour montrer le référentiel espèce du projet

espece <- data_3 %>% 
  select(espece) %>% 
  distinct() 

write_xlsx(espece, 'espece.xlsx')
```

```{r echo=FALSE, message=FALSE}
# Nettoyage noms d'espèce

data_3$espece <- as.character(data_3$espece)

data_3$espece[data_3$espece=="canard colvert"] = "Canard colvert"
data_3$espece[data_3$espece=="chien"] = "Chien"
data_3$espece[data_3$espece=="indéterminé"] = "Indéterminé"
data_3$espece[data_3$espece=="Loutre d'Europe"] = "Loutre d’Europe"
data_3$espece[data_3$espece=="mésange à longue queue"] = "Mésange à longue queue"
data_3$espece[data_3$espece=="mésange charbonnière"] = "Mésange charbonnière"
data_3$espece[data_3$espece=="mulot/souris"] = "Mulot/souris"
data_3$espece[data_3$espece=="rat musqué"] = "Rat musqué"
data_3$espece[data_3$espece=="rougequeue à front blanc"] = "Rougequeue à front blanc"
data_3$espece[data_3$espece=="troglodyte mignon"] = "Troglodyte mignon"
data_3$espece[data_3$espece=="Bouscarle de Cetti"] = "Bouscarle de cetti"
data_3$espece[data_3$espece=="campagnol amphibie"] = "Campagnol amphibie"
data_3$espece[data_3$espece=="Rousserole effarvate"] = "Rousserolle effarvatte"
data_3$espece[data_3$espece=="Lapin/Lievre"] = "Lapin/Lièvre"
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# ajout des infos espèces

RefEsp$nom_espece_projet[RefEsp$nom_espece_projet=="Lapin/Lievre"] = "Lapin/Lièvre"

RefEsp$espece <- RefEsp$nom_espece_projet

RefEsp <- RefEsp %>% select(list_1, espece)

data_4 <- left_join(data_3, RefEsp)

# data_4 <- data_4 %>% 
#   select(ID_unique,date_obs,temp,espece,DAC,DAC_interaction,DAC_piege,nb_detection,date_pose,distance_eau,hauteur,support,coulee,habitat,date_fin_obs,
#   duree_obs,nb_photo_valide,nb_photo_total,year_obs,month_obs,day_obs,hour_obs,list_1)

# colnames(data_4)
```

## Couleurs

```{r echo=FALSE, message=FALSE, fig.width=1, fig.height=1}
cols <- c("Mammifères" = "#E4002B", 
          "Micromammifères" = "#E35205",
          "Mammifères domestiques" = "#D9C756",
          "Oiseaux nidicoles" = "#147bd1", 
          "Oiseaux marcheurs nidifuges" = "#6CACE4",
          "Amphibiens/Reptiles" = "#2f6f7a",
          na.value = "#C8C9C7")

show_col("#147bd1")
show_col("#1D252D")
show_col("#E35205")
show_col("#4e4b48")
show_col("#E4002B")
show_col("#5B6770")
show_col("#C6893F")
show_col("#005F86")
show_col("#489fdf")
show_col("#C8C9C7")
show_col("#D9C756")
show_col("#2f6f7a")
show_col("#6CACE4")
```

# Vérification de cohérence

```{r echo=FALSE, message=FALSE}
summary(data_4)
```

# Listes espèces 

## Toutes les espèces observées

Listes des espèces observées et leur groupe associé.

```{r echo=FALSE, message=FALSE}
espece_all_corrigees <- data_4 %>% 
  select(espece, list_1) %>% 
  distinct() %>% 
  arrange(list_1, espece)

# Click table
espece_all_corrigees %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```


```{r eval=FALSE, message=FALSE, include=FALSE}
# tous les noms 

data_4$list_2[data_4$list_2 == "Accenteur mouchet" |
                data_4$list_2 == "Aigrette garzette" |
                data_4$list_2 == "Alouette des champs" |
                data_4$list_2 == "Amphibien sp" |
                data_4$list_2 == "Bécassine des marais" |
                data_4$list_2 == "Belette d'Europe" |
                data_4$list_2 == "Bergeronnette des ruisseaux" |
                data_4$list_2 == "Bergeronnette grise" |
                data_4$list_2 == "Bihoreau gris" |
                data_4$list_2 == "Blaireau européen" |
                data_4$list_2 == "Bouscarle de cetti" |
                data_4$list_2 == "Bruant des roseaux" |
                data_4$list_2 == "Bruant zizi" |
                data_4$list_2 == "Buse variable" |
                data_4$list_2 == "Campagnol amphibie" |
                data_4$list_2 == "Campagnol sp" |
                data_4$list_2 == "Canard colvert" |
                data_4$list_2 == "Canard pilet" |
                data_4$list_2 == "Canard sp" |
                data_4$list_2 == "Chardonneret élégant" |
                data_4$list_2 == "Chat domestique" |
                data_4$list_2 == "Chevalier culblanc" |
                data_4$list_2 == "Chèvre" |
                data_4$list_2 == "Chevreuil européen" |
                data_4$list_2 == "Chien" |
                data_4$list_2 == "Chouette hulotte" |
                data_4$list_2 == "Cisticole des joncs" |
                data_4$list_2 == "Cistude d'Europe" |
                data_4$list_2 == "Couleuvre helvétique" |
                data_4$list_2 == "Couleuvre sp" |
                data_4$list_2 == "Couleuvre verte et jaune" |
                data_4$list_2 == "Crapaud épineux" |
                data_4$list_2 == "Crossope aquatique" |
                data_4$list_2 == "Cygne tuberculé" |
                data_4$list_2 == "Ecureuil roux" |
                data_4$list_2 == "Effraie des clochers" |
                data_4$list_2 == "Epervier d'Europe" |
                data_4$list_2 == "Etourneau sansonnet" |
                data_4$list_2 == "Faisan de Colchide" |
                data_4$list_2 == "Faisan sp" |
                data_4$list_2 == "Faucon crécerelle" |
                data_4$list_2 == "Fauvette à tête noire" |
                data_4$list_2 == "Fauvette grisette" |
                data_4$list_2 == "Fouine" |
                data_4$list_2 == "Fouine/Martre" |
                data_4$list_2 == "Foulque macroule" |
                data_4$list_2 == "Gallinule poule d'eau" |
                data_4$list_2 == "Geai des chênes" |
                data_4$list_2 == "Genette commune" |
                data_4$list_2 == "Gobemouche noir" |
                data_4$list_2 == "Gorgebleue à miroir" |
                data_4$list_2 == "Grand cormoran" |
                data_4$list_2 == "Grande aigrette" |
                data_4$list_2 == "Grenouille verte indéterminée" |
                data_4$list_2 == "Grimpereau des jardins" |
                data_4$list_2 == "Grive litorne" |
                data_4$list_2 == "Grive mauvis" |
                data_4$list_2 == "Grive musicienne" |
                data_4$list_2 == "Gros-bec casse-noyaux" |
                data_4$list_2 == "Hérisson d'Europe" |
                data_4$list_2 == "Héron cendré" |
                data_4$list_2 == "Hibou moyen-duc" |
                data_4$list_2 == "indéterminé" |
                data_4$list_2 == "Lapin de Garenne" |
                data_4$list_2 == "Lapin/Lièvre" |
                data_4$list_2 == "Lérot" |
                data_4$list_2 == "Lézard à deux raies" |
                data_4$list_2 == "Lézard des murailles" |
                data_4$list_2 == "Lièvre européen" |
                data_4$list_2 == "Loutre d’Europe" |
                data_4$list_2 == "Mammifère indéterminé" |
                data_4$list_2 == "Martin-pêcheur d'Europe" |
                data_4$list_2 == "Martre des Pins" |
                data_4$list_2 == "Merle à plastron" |
                data_4$list_2 == "Merle noir" |
                data_4$list_2 == "Mésange à longue queue" |
                data_4$list_2 == "Mésange bleue" |
                data_4$list_2 == "Mésange charbonnière" |
                data_4$list_2 == "Micromammifère sp" |
                data_4$list_2 == "Moineau domestique" |
                data_4$list_2 == "Mouton" |
                data_4$list_2 == "Mulot/souris" |
                data_4$list_2 == "Musaraigne sp" |
                data_4$list_2 == "Mustélidé indéterminé" |
                data_4$list_2 == "Oiseau indéterminé" |
                data_4$list_2 == "Perdrix rouge" |
                data_4$list_2 == "Phragmite des joncs" |
                data_4$list_2 == "Pic épeiche" |
                data_4$list_2 == "Pic vert" |
                data_4$list_2 == "Pie bavarde" |
                data_4$list_2 == "Pigeon biset" |
                data_4$list_2 == "Pigeon ramier" |
                data_4$list_2 == "Pinson des arbres" |
                data_4$list_2 == "Pipit farlouse" |
                data_4$list_2 == "Pouillot fitis" |
                data_4$list_2 == "Pouillot véloce" |
                data_4$list_2 == "Putois d'Europe" |
                data_4$list_2 == "Ragondin" |
                data_4$list_2 == "Râle d'eau" |
                data_4$list_2 == "Rat des moissons" |
                data_4$list_2 == "Rat musqué" |
                data_4$list_2 == "Rat surmulot" |
                data_4$list_2 == "Raton laveur" |
                data_4$list_2 == "Renard roux" |
                data_4$list_2 == "Roitelet à triple bandeaux" |
                data_4$list_2 == "Rossignol philomèle" |
                data_4$list_2 == "Rougegorge familier" |
                data_4$list_2 == "Rougequeue à front blanc" |
                data_4$list_2 == "Rousserole effarvate" |
                data_4$list_2 == "Sanglier" |
                data_4$list_2 == "Sarcelle d'hiver" |
                data_4$list_2 == "Serpent sp" |
                data_4$list_2 == "Spatule blanche" |
                data_4$list_2 == "Tadorne de Belon" |
                data_4$list_2 == "Tarier pâtre" |
                data_4$list_2 == "Tarin des aulnes" |
                data_4$list_2 == "Taupe d'Europe" |
                data_4$list_2 == "Torcol fourmilier" |
                data_4$list_2 == "Tourterelle des bois" |
                data_4$list_2 == "Traquet motteux" |
                data_4$list_2 == "Troglodyte mignon" |
                data_4$list_2 == "Urodèle sp" |
                data_4$list_2 == "Vache domestique" |
                data_4$list_2 == "Verdier d'Europe"] 
```

## Liste 1 

Groupe d'espèce, description très large.

```{r echo=FALSE, message=FALSE}
list_1_dt <- data_4 %>% 
  select(list_1, espece) %>% 
  distinct() %>% 
  arrange(list_1, espece)

list_1_cat_dt <- as.data.frame(table(list_1_dt$list_1))

list_1_cat_dt <- list_1_cat_dt %>% 
  dplyr::rename("Catégorie" = Var1, "Nombre d'espèce" = Freq)

# Click table
list_1_cat_dt %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
list_1_dt <- list_1_dt %>% 
  dplyr::rename("Catégorie liste 1" = list_1, "Espèce" = espece)
```

## Liste 2 

Liste ressérée mammifères. 

Espèce d'amphibiens et reptiles regroupées, oiseaux regroupés.

```{r echo=FALSE, message=FALSE}
data_4$list_2 <- data_4$espece

data_4$list_2[data_4$list_2 == "Accenteur mouchet" |
                data_4$list_2 == "Aigrette garzette" |
                data_4$list_2 == "Alouette des champs" |
                data_4$list_2 == "Amphibien sp" |
                data_4$list_2 == "Bécassine des marais" |
                data_4$list_2 == "Belette d'Europe" |
                data_4$list_2 == "Bergeronnette des ruisseaux" |
                data_4$list_2 == "Bergeronnette grise" |
                data_4$list_2 == "Bihoreau gris" |
                data_4$list_2 == "Blaireau européen" |
                data_4$list_2 == "Bouscarle de cetti" |
                data_4$list_2 == "Bruant des roseaux" |
                data_4$list_2 == "Bruant zizi" |
                data_4$list_2 == "Buse variable" |
                data_4$list_2 == "Campagnol amphibie" |
                data_4$list_2 == "Canard colvert" |
                data_4$list_2 == "Canard pilet" |
                data_4$list_2 == "Canard sp" |
                data_4$list_2 == "Chardonneret élégant" |
                data_4$list_2 == "Chat domestique" |
                data_4$list_2 == "Chevalier culblanc" |
                data_4$list_2 == "Chien" |
                data_4$list_2 == "Chouette hulotte" |
                data_4$list_2 == "Cisticole des joncs" |
                data_4$list_2 == "Cistude d'Europe" |
                data_4$list_2 == "Couleuvre helvétique" |
                data_4$list_2 == "Couleuvre sp" |
                data_4$list_2 == "Couleuvre verte et jaune" |
                data_4$list_2 == "Crapaud épineux" |
                data_4$list_2 == "Crossope aquatique" |
                data_4$list_2 == "Cygne tuberculé" |
                data_4$list_2 == "Ecureuil roux" |
                data_4$list_2 == "Effraie des clochers" |
                data_4$list_2 == "Epervier d'Europe" |
                data_4$list_2 == "Etourneau sansonnet" |
                data_4$list_2 == "Faisan de Colchide" |
                data_4$list_2 == "Faisan sp" |
                data_4$list_2 == "Faucon crécerelle" |
                data_4$list_2 == "Fauvette à tête noire" |
                data_4$list_2 == "Fauvette grisette" |
                data_4$list_2 == "Fouine" |
                data_4$list_2 == "Fouine/Martre" |
                data_4$list_2 == "Foulque macroule" |
                data_4$list_2 == "Gallinule poule d'eau" |
                data_4$list_2 == "Geai des chênes" |
                data_4$list_2 == "Genette commune" |
                data_4$list_2 == "Gobemouche noir" |
                data_4$list_2 == "Gorgebleue à miroir" |
                data_4$list_2 == "Grand cormoran" |
                data_4$list_2 == "Grande aigrette" |
                data_4$list_2 == "Grenouille verte indéterminée" |
                data_4$list_2 == "Grimpereau des jardins" |
                data_4$list_2 == "Grive litorne" |
                data_4$list_2 == "Grive mauvis" |
                data_4$list_2 == "Grive musicienne" |
                data_4$list_2 == "Gros-bec casse-noyaux" |
                data_4$list_2 == "Hérisson d'Europe" |
                data_4$list_2 == "Héron cendré" |
                data_4$list_2 == "Hibou moyen-duc" |
                data_4$list_2 == "Lapin de Garenne" |
                data_4$list_2 == "Lapin/Lièvre" |
                data_4$list_2 == "Lérot" |
                data_4$list_2 == "Lézard à deux raies" |
                data_4$list_2 == "Lézard des murailles" |
                data_4$list_2 == "Lièvre européen" |
                data_4$list_2 == "Loutre d’Europe" |
                data_4$list_2 == "Martin-pêcheur d'Europe" |
                data_4$list_2 == "Martre des Pins" |
                data_4$list_2 == "Merle à plastron" |
                data_4$list_2 == "Merle noir" |
                data_4$list_2 == "Mésange à longue queue" |
                data_4$list_2 == "Mésange bleue" |
                data_4$list_2 == "Mésange charbonnière" |
                data_4$list_2 == "Moineau domestique" |
                data_4$list_2 == "Musaraigne sp" |
                data_4$list_2 == "Oiseau indéterminé" |
                data_4$list_2 == "Perdrix rouge" |
                data_4$list_2 == "Phragmite des joncs" |
                data_4$list_2 == "Pic épeiche" |
                data_4$list_2 == "Pic vert" |
                data_4$list_2 == "Pie bavarde" |
                data_4$list_2 == "Pigeon biset" |
                data_4$list_2 == "Pigeon ramier" |
                data_4$list_2 == "Pinson des arbres" |
                data_4$list_2 == "Pipit farlouse" |
                data_4$list_2 == "Pouillot fitis" |
                data_4$list_2 == "Pouillot véloce" |
                data_4$list_2 == "Putois d'Europe" |
                data_4$list_2 == "Ragondin" |
                data_4$list_2 == "Râle d'eau" |
                data_4$list_2 == "Rat des moissons" |
                data_4$list_2 == "Rat musqué" |
                data_4$list_2 == "Rat surmulot" |
                data_4$list_2 == "Raton laveur" |
                data_4$list_2 == "Renard roux" |
                data_4$list_2 == "Roitelet à triple bandeaux" |
                data_4$list_2 == "Rossignol philomèle" |
                data_4$list_2 == "Rougegorge familier" |
                data_4$list_2 == "Rougequeue à front blanc" |
                data_4$list_2 == "Rousserole effarvate" |
                data_4$list_2 == "Sarcelle d'hiver" |
                data_4$list_2 == "Serpent sp" |
                data_4$list_2 == "Spatule blanche" |
                data_4$list_2 == "Tadorne de Belon" |
                data_4$list_2 == "Tarier pâtre" |
                data_4$list_2 == "Tarin des aulnes" |
                data_4$list_2 == "Torcol fourmilier" |
                data_4$list_2 == "Tourterelle des bois" |
                data_4$list_2 == "Traquet motteux" |
                data_4$list_2 == "Troglodyte mignon" |
                data_4$list_2 == "Urodèle sp" |
                data_4$list_2 == "Verdier d'Europe"] <- "oui"

data_4$list_2[data_4$list_2 != "oui"] <- "non"
                
tt <- as.data.frame(table(data_4$list_2))                

# jeu de données uniquement avec les espèces de la liste 2
data_4_list_2 <- data_4[data_4$list_2 == "oui",]               

# regroupement des amphibiens et reptiles 
data_4_list_2$espece[data_4_list_2$espece == "Amphibien sp" |
                data_4_list_2$espece == "Cistude d'Europe" |
                data_4_list_2$espece == "Couleuvre helvétique" |
                data_4_list_2$espece == "Couleuvre sp" |
                data_4_list_2$espece == "Couleuvre verte et jaune" |
                data_4_list_2$espece == "Crapaud épineux" |
                data_4_list_2$espece == "Grenouille verte indéterminée" |
                data_4_list_2$espece == "Lézard à deux raies" |
                data_4_list_2$espece == "Lézard des murailles" |
                data_4_list_2$espece == "Serpent sp"|
                data_4_list_2$espece == "Urodèle sp"] <- "Amphibiens/Reptiles"

# regroupement des oiseaux
data_4_list_2$espece[data_4_list_2$espece == "Accenteur mouchet" |
                data_4_list_2$espece == "Aigrette garzette" |
                data_4_list_2$espece == "Alouette des champs" |
                data_4_list_2$espece == "Bécassine des marais" |
                data_4_list_2$espece == "Bergeronnette des ruisseaux" |
                data_4_list_2$espece == "Bergeronnette grise" |
                data_4_list_2$espece == "Bihoreau gris" |
                data_4_list_2$espece == "Bouscarle de cetti" |
                data_4_list_2$espece == "Bruant des roseaux" |
                data_4_list_2$espece == "Bruant zizi" |
                data_4_list_2$espece == "Buse variable" |
                data_4_list_2$espece == "Canard colvert" |
                data_4_list_2$espece == "Canard pilet" |
                data_4_list_2$espece == "Canard sp" |
                data_4_list_2$espece == "Chardonneret élégant" |
                data_4_list_2$espece == "Chevalier culblanc" |
                data_4_list_2$espece == "Chouette hulotte" |
                data_4_list_2$espece == "Cisticole des joncs" |
                data_4_list_2$espece == "Cygne tuberculé" |
                data_4_list_2$espece == "Effraie des clochers" |
                data_4_list_2$espece == "Epervier d'Europe" |
                data_4_list_2$espece == "Etourneau sansonnet" |
                data_4_list_2$espece == "Faisan de Colchide" |
                data_4_list_2$espece == "Faisan sp" |
                data_4_list_2$espece == "Faucon crécerelle" |
                data_4_list_2$espece == "Fauvette à tête noire" |
                data_4_list_2$espece == "Fauvette grisette" |
                data_4_list_2$espece == "Foulque macroule" |
                data_4_list_2$espece == "Gallinule poule d'eau" |
                data_4_list_2$espece == "Geai des chênes" |
                data_4_list_2$espece == "Gobemouche noir" |
                data_4_list_2$espece == "Gorgebleue à miroir" |
                data_4_list_2$espece == "Grand cormoran" |
                data_4_list_2$espece == "Grande aigrette" |
                data_4_list_2$espece == "Grimpereau des jardins" |
                data_4_list_2$espece == "Grive litorne" |
                data_4_list_2$espece == "Grive mauvis" |
                data_4_list_2$espece == "Grive musicienne" |
                data_4_list_2$espece == "Gros-bec casse-noyaux" |
                data_4_list_2$espece == "Héron cendré" |
                data_4_list_2$espece == "Hibou moyen-duc" |
                data_4_list_2$espece == "Martin-pêcheur d'Europe" |
                data_4_list_2$espece == "Merle à plastron" |
                data_4_list_2$espece == "Merle noir" |
                data_4_list_2$espece == "Mésange à longue queue" |
                data_4_list_2$espece == "Mésange bleue" |
                data_4_list_2$espece == "Mésange charbonnière" |
                data_4_list_2$espece == "Moineau domestique" |
                data_4_list_2$espece == "Oiseau indéterminé" |
                data_4_list_2$espece == "Perdrix rouge" |
                data_4_list_2$espece == "Phragmite des joncs" |
                data_4_list_2$espece == "Pic épeiche" |
                data_4_list_2$espece == "Pic vert" |
                data_4_list_2$espece == "Pie bavarde" |
                data_4_list_2$espece == "Pigeon biset" |
                data_4_list_2$espece == "Pigeon ramier" |
                data_4_list_2$espece == "Pinson des arbres" |
                data_4_list_2$espece == "Pipit farlouse" |
                data_4_list_2$espece == "Pouillot fitis" |
                data_4_list_2$espece == "Pouillot véloce" |
                data_4_list_2$espece == "Râle d'eau" |
                data_4_list_2$espece == "Roitelet à triple bandeaux" |
                data_4_list_2$espece == "Rossignol philomèle" |
                data_4_list_2$espece == "Rougegorge familier" |
                data_4_list_2$espece == "Rougequeue à front blanc" |
                data_4_list_2$espece == "Rousserole effarvate" |
                data_4_list_2$espece == "Sarcelle d'hiver" |
                data_4_list_2$espece == "Spatule blanche" |
                data_4_list_2$espece == "Tadorne de Belon" |
                data_4_list_2$espece == "Tarier pâtre" |
                data_4_list_2$espece == "Tarin des aulnes" |
                data_4_list_2$espece == "Torcol fourmilier" |
                data_4_list_2$espece == "Tourterelle des bois" |
                data_4_list_2$espece == "Traquet motteux" |
                data_4_list_2$espece == "Troglodyte mignon" |
                data_4_list_2$espece == "Verdier d'Europe"] <- "Oiseaux"

# zz <- as.data.frame(table(data_4_list_2$espece))

list_2_dt <- data_4_list_2 %>% 
  select(espece, list_1) %>% 
  distinct() %>% 
  arrange(espece)

# list_2_cat_dt <- as.data.frame(table(list_2_dt$espece))

list_2_dt <- list_2_dt %>% 
  dplyr::rename("Espèce" = espece, "groupe" = list_1)

# Click table
list_2_dt %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

## Liste 3

Liste ressérée pour estimation diversité spécifique (ragondin retiré). 

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_4$list_3 <- data_4$espece

data_4$list_3[data_4$list_3 == "Belette d'Europe" |
                data_4$list_3 == "Blaireau européen" |
                data_4$list_3 == "Fouine" |
                data_4$list_3 == "Fouine/Martre" |
                data_4$list_3 == "Genette commune" |
                data_4$list_3 == "Loutre d’Europe" |
                data_4$list_3 == "Martre des Pins" |
                data_4$list_3 == "Putois d'Europe" |
                data_4$list_3 == "Raton laveur" |
                data_4$list_3 == "Renard roux"] <- "oui"

data_4$list_3[data_4$list_3 != "oui"] <- "non"
                
# tt <- as.data.frame(table(data_4$list_3))                

# jeu de données uniquement avec les espèces de la liste 2
data_4_list_3 <- data_4[data_4$list_3 == "oui",]  

list_3_dt <- data_4_list_3 %>% 
  select(espece, list_1) %>% 
  distinct() %>% 
  arrange(espece)

list_3_dt <- list_3_dt %>% 
  dplyr::rename("Espèce" = espece, "groupe" = list_1)

# Click table
list_3_dt %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# traitement Martre/Fouine ----------------------------

# Liste de piège où il y a eu des identifications "Fouine/Martre"
both_only <- data_4_list_3[data_4_list_3$espece=="Fouine/Martre",]
both_only <- both_only %>% 
  select(ID_unique) %>% 
  distinct() # 26 pièges

# recupération des infos d'obs pour les piège qui ont eu du "Fouine/Martre"
info_both_only <- left_join(both_only,data_4_list_3)
# length(unique(info_both_only$ID_unique)) # 26 pièges

# On garde les lignes seulement des pièges où il y a eu du "Fouine/Martre", et les lignes qui correspondent à ces deux espèces
info_both_only <- info_both_only[info_both_only$espece=="Fouine/Martre" |
                                               info_both_only$espece=="Fouine" |
                                               info_both_only$espece=="Martre des Pins",]

# On change "Fouine/Martre" pour "both"
info_both_only$espece[info_both_only$espece=="Fouine/Martre"] <- "both"

# comptage occurences de Martre et Fouine
tt <- info_both_only %>% 
  select(ID_unique, espece) %>% 
  group_by(ID_unique) %>% 
  mutate(count_both = sum(str_count(espece, "both"))) %>% 
  mutate(count_F = sum(str_count(espece, "Fouine"))) %>%
  mutate(count_M = sum(str_count(espece, "Martre des Pins"))) 

# laquelle est la plus présente sur le piège?
tt$more_of <- tt$count_F-tt$count_M
tt$more_of_sign <- as.character(sign(tt$more_of))
tt$more_of_esp[tt$more_of_sign=="-1"] <- "Martre des Pins"
tt$more_of_esp[tt$more_of_sign=="1"] <- "Fouine"

# changement Martre/Fouine dans data_4_list_3
tt_just <- tt %>%
  select(ID_unique, more_of_esp) %>% 
  distinct()

data_4_list_3 <- left_join(data_4_list_3, tt_just)

data_4_list_3$espece_FM_ok <- data_4_list_3$espece

data_4_list_3$espece_FM_ok[data_4_list_3$espece == "Fouine/Martre" & data_4_list_3$more_of_esp == "Fouine"] <- "Fouine"
data_4_list_3$espece_FM_ok[data_4_list_3$espece == "Fouine/Martre" & data_4_list_3$more_of_esp == "Martre des Pins"] <- "Martre des Pins"


```

```{r echo=FALSE, message=FALSE, warning=FALSE}
list_3_dt <- data_4_list_3 %>% 
  select(espece) %>% 
  distinct() %>% 
  arrange(espece)

# list_2_cat_dt <- as.data.frame(table(list_2_dt$espece))

list_3_dt <- list_3_dt %>% 
  dplyr::rename("Espèce" = espece)

# Click table
# list_3_dt %>%
#   datatable(extensions = 'Buttons',
#             options = list(dom = 'Blfrtip',
#                            buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
#                            lengthMenu = list(c(10,25,50,-1),
#                                              c(10,25,50,"All"))))
```

# Survey effort

From Rovero & Zimmermann 2016 :
 
Survey effort is typically measured as camera days, i.e. the number of camera traps used multiplied by the number of days they were in operation (taking into account malfunctioning cameras if necessary). Hence, the unit of the camera trapping rate is events per day of sampling.

```{r echo=FALSE, message=FALSE, warning=FALSE}
effort_dt <- data_4 %>% 
  select(ID_unique, duree_obs) %>% 
  distinct()

effort_day <- sum(effort_dt$duree_obs, na.rm=T)
effort_week <- sum(effort_dt$duree_obs, na.rm=T) / 7
```

Nombre de jour d'observation sommés sur l'ensemble des pièges photo :

= effort d'échantillonnage global (unité = jour)

```{r echo=FALSE, message=FALSE, warning=FALSE}
effort_day
```

Nombre de semaine d'observation sommées sur l'ensemble des pièges photo :

= effort d'échantillonnage global (unité = semaine)

```{r echo=FALSE, message=FALSE, warning=FALSE}
effort_week
```

# Temps de fonctionnement

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=3.5, fig.height=3.5}
tps_dt <- data_4 %>% 
  select(ID_unique, date_pose, date_retrait, duree_obs) %>% 
  distinct() %>% 
  na.omit()

tps_dt <- tps_dt %>% 
  mutate(duree_pose = as.numeric(difftime(ymd(date_retrait),ymd(date_pose), units = "days"))) %>% 
  mutate(pourc_tps = (duree_obs/duree_pose)*100) 
```

Pourcentage moyen de temps de fonctionnement sur le temps de pose des pièges photo :

```{r, echo=FALSE, message=FALSE, fig.width=3.5, fig.height=3.5}
mean(tps_dt$pourc_tps)
```
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=3.5, fig.height=3.5}
# plot
tps_plot <- ggplot(tps_dt, aes(duree_pose, duree_obs)) +
  geom_point(shape = 21, fill = "white", size = 2) +
  geom_abline(intercept = 0, slope = 1, color="yellow", linewidth=1)+
  geom_smooth(method = lm) +
  theme_classic() +
  labs(title="",
        x ="Temps de pose", y = "Temps de fonctionnement"); tps_plot
```

\

```{r eval=FALSE, fig.height=3.5, fig.width=3.5, message=FALSE, warning=FALSE, include=FALSE}
tab_model(lm(duree_obs ~ duree_pose, 
             data = tps_dt),
             title = "Durée de fonctionnement d'un piège photo en fonction de sa durée de pose")
```

# Distributions temporelles des observations 

Distribution des dates d'observation en fonction du jour (1=1er janvier) de l'année.

```{r echo=FALSE, fig.height=8, fig.width=12, message=FALSE}
data_3$day_obs_order <- factor(data_3$day_obs, levels = c(245:365, 1:244))

obs_day_plot <- ggplot(data_3, aes(x=as.factor(day_obs_order))) + 
  geom_bar(colour="white", fill="black") +
  theme_classic(base_size = 22) +
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  # scale_x_discrete(breaks = c(even(c(245:365, 1:244)))) +
  scale_x_discrete(breaks = c(c(1,31,60,91,121,152,182,213,244,274,305,335,366))) +
  labs(title="",
        x ="Jour d'observation", y = "Fréquence d'observation") ; obs_day_plot
```

Distribution des dates d'observation en fonction du mois de l'année.
(sans les observations multiples)

NEWNEWNEWNEW

```{r echo=FALSE, fig.height=5, fig.width=6, message=FALSE}
data_3$month_obs_order <- factor(data_3$month_obs, levels = c(9:12, 1:8))

nb_obs_month_dt <- data_3 %>% 
  group_by(month_obs_order) %>% 
  count() %>% 
  dplyr::rename(Mois = month_obs_order, nb_observation = n)

# Click table
nb_obs_month_dt %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

obs_month_plot <- ggplot(data_3, aes(x=as.factor(month_obs_order))) + 
  geom_bar(colour="white", fill="black") +
  theme_classic(base_size = 22) +
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  # scale_x_continuous(breaks=seq(1, 12, 1)) +
  labs(title="",
        x ="Mois d'observation", y = "Nombre d'observation") ; obs_month_plot


# all_distrib <- grid.arrange(arrangeGrob(obs_day_plot, ncol=1, nrow=1),
#                             arrangeGrob(obs_month_plot, obs_year_plot, ncol=2, nrow=1), 
#                             ncol = 1,
#                             heights=c(1,1), widths=c(1))
```


```{r, echo=FALSE, message=FALSE, fig.width=12, fig.height=8}
# Distribution des dates d'observation pour chaque espèce (couleurs) en fonction du jour (1=1er janvier) de l'année.
# 
# Version 1
# 
# data_4_list_3$day_obs_order <- factor(data_4_list_3$day_obs, levels = c(245:365, 1:244))
# 
# obs_day_esp_plot2 <- ggplot(data_4_list_3, aes(x=as.factor(day_obs_order), fill = espece)) +
#   geom_bar(color = "white", position="fill") +
#   theme_classic(base_size = 22) +
#   # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
#   # scale_x_discrete(breaks = c(even(c(245:365, 1:244)))) +
#   scale_fill_manual(values = c("#147bd1","#AAFAC8","#F7AEF8","#E4002B","#5E0035","#C6893F","#659157","#1D252D","#D9C756","#E35205")) +
#   scale_x_discrete(breaks = c(c(1,31,60,91,121,152,182,213,244,274,305,335,366))) +
#   labs(title="", fill = "Espèce",
#         x ="Jour d'observation", y = "Fréquence d'observation") ; obs_day_esp_plot2
```


```{r, echo=FALSE, message=FALSE, fig.width=18, fig.height=8}
# Version 2
# 
# obs_day_esp_plot3 <- ggplot(data_4_list_3, aes(x=as.factor(day_obs_order), fill = espece)) + 
#   geom_bar(color = "white") +
#   theme_classic(base_size = 22) +
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
#   # scale_x_discrete(breaks = c(even(c(245:365, 1:244)))) +
#   scale_fill_manual(values = c("#147bd1","#AAFAC8","#F7AEF8","#E4002B","#5E0035","#C6893F","#659157","#1D252D","#D9C756","#E35205")) +
#   scale_x_discrete(breaks = c(c(1,31,60,91,121,152,182,213,244,274,305,335,366))) +
#   facet_wrap(espece ~ ., ncol = 5) +
#   labs(title="", fill = "Espèce",
#         x ="Jour d'observation", y = "Nombre d'observation") ; obs_day_esp_plot3
```

Distribution des dates d'observation pour chaque espèce (couleurs) en fonction du mois de l'année.

Version 1

```{r, echo=FALSE, message=FALSE, fig.width=10, fig.height=6}
data_4_list_3$month_obs_order <- factor(data_4_list_3$month_obs, levels = c(9:12, 1:8))

obs_month_esp_plot2 <- ggplot(data_4_list_3, aes(x=as.factor(month_obs_order), fill = espece)) + 
  geom_bar(colour="white", position="fill") +
  theme_classic(base_size = 22) +
  scale_fill_manual(values = c("#147bd1","#AAFAC8","#F7AEF8","#E4002B","#5E0035","#C6893F","#659157","#1D252D","#D9C756","#E35205")) +
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  # scale_x_continuous(breaks=seq(1, 12, 1)) +
  labs(title="", fill = "Espèce",
        x ="Mois d'observation", y = "Nombre d'observation") ; obs_month_esp_plot2
```

Version 2

```{r, echo=FALSE, message=FALSE, fig.width=18, fig.height=8}
nb_obs_data_4_list_3 <- data_4_list_3 %>% 
  group_by(espece, month_obs_order) %>% 
  count() %>% 
  dplyr::rename("Espèce" = espece, "Mois" = month_obs_order, "Nb obs" = n)


# Click table
nb_obs_data_4_list_3 %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))


obs_month_esp_plot3 <- ggplot(data_4_list_3, aes(x=as.factor(month_obs_order), fill = espece)) + 
  geom_bar(colour="white") +
  theme_classic(base_size = 22) +
  scale_fill_manual(values = c("#147bd1","#AAFAC8","#F7AEF8","#E4002B","#5E0035","#C6893F","#659157","#1D252D","#D9C756","#E35205")) +
  facet_wrap(espece ~., ncol = 5) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  # scale_x_continuous(breaks=seq(1, 12, 1)) +
  labs(title="", fill = "Espèce",
        x ="Mois d'observation", y = "Nombre d'observation") ; obs_month_esp_plot3
```

# Photos valides 

Nombre de photo valide (divisé par 4).

```{r, echo=FALSE}
data_3$nb_photo_valide <- as.numeric(data_3$nb_photo_valide)/4
data_3$nb_photo_total <- as.numeric(data_3$nb_photo_total)/4
data_3$pourcentage_photo_valide <- (data_3$nb_photo_valide/data_3$nb_photo_total)*100
```

```{r, echo=FALSE}
nb_photo_dt <- data_3 %>% 
  select(ID_unique, nb_photo_valide, nb_photo_total, pourcentage_photo_valide, hauteur, habitat, distance_eau, date_pose, support) %>% 
  distinct()
```

Nombre total de photos valides :

```{r, echo=FALSE}
nb_photo_valide_all <- sum(nb_photo_dt$nb_photo_valide, na.rm=T) ; nb_photo_valide_all
```

Nombre total de photos :

```{r, echo=FALSE}
nb_photo_all <- sum(nb_photo_dt$nb_photo_total, na.rm=T) ; nb_photo_all
```

Pourcentage global de photo valide : 

```{r, echo=FALSE}
pourcentage_photo_valide_all <- (nb_photo_valide_all/nb_photo_all)*100 ; pourcentage_photo_valide_all
```

## ~ hauteur

### Nombre

Nombre de photos valides moyen par point d'observation en fonction de la hauteur.

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# data
# nb_photo_valide_moy_hauteur_dt <- nb_photo_dt %>% 
#   group_by(hauteur) %>% 
#   mutate(mean_photo_valide = mean(nb_photo_valide)) %>% 
#   mutate(sd_photo_valide = sd(nb_photo_valide)) %>% 
#   mutate(mean_pourc_photo_valide = mean(pourcentage_photo_valide)) %>%
#   mutate(sd_pourc_photo_valide = sd(pourcentage_photo_valide)) %>% 
#   select(hauteur, mean_photo_valide, sd_photo_valide, mean_pourc_photo_valide, sd_pourc_photo_valide) %>% 
#   distinct() %>% 
#   na.omit()
```

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# plot
nb_photo_valide_moy_hauteur_plot <- ggplot(nb_photo_dt, aes(hauteur, nb_photo_valide)) +
  # geom_errorbar(aes(ymin=mean_photo_valide-sd_photo_valide, ymax=mean_photo_valide+sd_photo_valide), width=0) +
  geom_point(shape = 21, fill = "grey", size = 4) +
  geom_smooth(method = lm, linetype = "dotted") +
  ylab("Nombre de photo valide") + xlab("Hauteur") +
  theme_classic(); nb_photo_valide_moy_hauteur_plot

# model
tab_model(lm(nb_photo_valide ~ hauteur, data = nb_photo_dt[!is.na(nb_photo_dt$hauteur),]), 
          title = "Nombre de photo valide en fonction de la hauteur d'installation")
```

### Pourcentage

Pourcentage de photos valides sur le nombre de photo total par point d'observation en fonction de la hauteur.

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# plot
pourc_photo_valide_moy_hauteur_plot <- ggplot(nb_photo_dt, aes(hauteur, pourcentage_photo_valide)) +
  # geom_errorbar(aes(ymin=mean_pourc_photo_valide-sd_pourc_photo_valide, ymax=mean_pourc_photo_valide+sd_pourc_photo_valide), width=0) +
  geom_point(shape = 21, fill = "grey", size = 4) +
  geom_smooth(method = lm, linetype = "dotted") +
  ylab("Pourcentage de photo valide") + xlab("Hauteur") +
  theme_classic(); pourc_photo_valide_moy_hauteur_plot

# model
tab_model(lm(pourcentage_photo_valide ~ hauteur, data = nb_photo_dt[!is.na(nb_photo_dt$hauteur),]), 
          title = "Pourcentage de photo valide en fonction de la hauteur d'installation")
```

## ~ support

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=4, fig.height=4}
# data
# nb_photo_valide_moy_support_dt <- nb_photo_dt %>% 
#   select(ID_unique, support, nb_photo_valide, nb_photo_valide, pourcentage_photo_valide) %>% 
#   group_by(support) %>% 
#   mutate(mean_photo_valide = mean(nb_photo_valide)) %>% 
#   mutate(sd_photo_valide = sd(nb_photo_valide)) %>% 
#   mutate(mean_pourc_photo_valide = mean(pourcentage_photo_valide)) %>%
#   mutate(sd_pourc_photo_valide = sd(pourcentage_photo_valide)) %>% 
#   select(support, mean_photo_valide, sd_photo_valide, mean_pourc_photo_valide, sd_pourc_photo_valide) %>% 
#   distinct()
# 
# nb_photo_valide_moy_support_dt <- nb_photo_valide_moy_support_dt[!is.na(nb_photo_valide_moy_support_dt$support),]
```

### Nombre

Nombre de photos valides moyen par point d'observation en fonction du support.

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=4, fig.height=4}
# plot
nb_photo_valide_moy_support_plot <- ggplot(subset(nb_photo_dt, !is.na(support)), aes(support, nb_photo_valide)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(size = 1, fill = "white", shape = 21) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1, color="red", fill="red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Support", y = "Nombre de photo valide"); nb_photo_valide_moy_support_plot

# model
tab_model(lm(nb_photo_valide ~ support, data = nb_photo_dt[!is.na(nb_photo_dt$support),]), 
          title = "Nombre de photo valide en fonction du support d'installation (ref = Arbre)")
```

### Pourcentage

Pourcentage de photos valides sur le nombre de photo total par point d'observation en fonction du support.

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=4, fig.height=4}
# plot
pourc_photo_valide_moy_support_plot <- ggplot(subset(nb_photo_dt, !is.na(support)), aes(support, pourcentage_photo_valide)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(size = 1, fill = "white", shape = 21) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1, color="red", fill="red") +
  theme_classic() +
  geom_signif(data = subset(nb_photo_dt, !is.na(support)), 
              aes(x=support, y=pourcentage_photo_valide),
              comparisons = list(c("Piquet", "Arbre")),
              map_signif_level=TRUE,
              y_position = 110, color = "black") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Support", y = "Pourcentage de photo valide"); pourc_photo_valide_moy_support_plot

# model
tab_model(lm(pourcentage_photo_valide ~ support, data = nb_photo_dt[!is.na(nb_photo_dt$support),]), 
          title = "Pourcentage de photo valide en fonction du support d'installation (ref = Arbre)")
```

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=4, fig.height=4}
# plot
nb_photo_dt_3 <- nb_photo_dt[nb_photo_dt$support!="Sous pont",]

pourc_photo_valide_moy_support_plot <- ggplot(subset(nb_photo_dt_3, !is.na(support)), aes(support, pourcentage_photo_valide)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(size = 1, fill = "white", shape = 21) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1, color="red", fill="red") +
  theme_classic() +
  geom_signif(data = subset(nb_photo_dt_3, !is.na(support)), 
              aes(x=support, y=pourcentage_photo_valide),
              comparisons = list(c("Piquet", "Arbre")),
              map_signif_level=TRUE,
              y_position = 110, color = "black") +
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Support", y = "Pourcentage de photo valide"); pourc_photo_valide_moy_support_plot

# model
tab_model(lm(pourcentage_photo_valide ~ support, data = nb_photo_dt_3[!is.na(nb_photo_dt_3$support),]), 
          title = "Pourcentage de photo valide en fonction du support d'installation (ref = Arbre)")
```

## ~ habitat

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=4, fig.height=5}
# data
# nb_photo_valide_moy_habitat_dt <- nb_photo_dt %>%
#   select(ID_unique, habitat, nb_photo_valide, nb_photo_valide, pourcentage_photo_valide) %>% 
#   group_by(habitat) %>% 
#   mutate(mean_photo_valide = mean(nb_photo_valide)) %>% 
#   mutate(sd_photo_valide = sd(nb_photo_valide)) %>% 
#   mutate(mean_pourc_photo_valide = mean(pourcentage_photo_valide)) %>%
#   mutate(sd_pourc_photo_valide = sd(pourcentage_photo_valide)) %>% 
#   select(habitat, mean_photo_valide, sd_photo_valide, mean_pourc_photo_valide, sd_pourc_photo_valide) %>% 
#   distinct()
# 
# nb_photo_valide_moy_habitat_dt <- nb_photo_valide_moy_habitat_dt[!is.na(nb_photo_valide_moy_habitat_dt$habitat),]
```

### Nombre

Nombre de photos valides moyen par point d'observation en fonction de l'habitat.

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=4, fig.height=5}
# plot
nb_photo_valide_moy_habitat_plot <- ggplot(subset(nb_photo_dt, !is.na(habitat)), aes(habitat, nb_photo_valide)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(size = 1, fill = "white", shape = 21) +
  stat_summary(data = subset(nb_photo_dt, !is.na(habitat)), 
               aes(habitat, nb_photo_valide),
               fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1, color="red", fill="red") +
  theme_classic() +
  geom_signif(data = subset(nb_photo_dt, !is.na(habitat)), aes(x=habitat, y=nb_photo_valide),
              comparisons = list(c("Ripisylves", "Fourrés")),
              map_signif_level=TRUE,
              y_position = 57000, color = "black",
              test = "t.test") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Habitat", y = "Nombre de photo valide"); nb_photo_valide_moy_habitat_plot

# model
tab_model(lm(nb_photo_valide ~ habitat,
             data=transform(nb_photo_dt[!is.na(nb_photo_dt$habitat),], habitat=forcats::fct_relevel(habitat,"Fourrés"))), 
          title = "Nombre de photo valide en fonction de l'habitat (ref= Fourrés)")
```

### Pourcentage

Pourcentage de photos valides sur le nombre de photo total par point d'observation en fonction de l'habitat.

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=4, fig.height=5}
# plot
pourc_photo_valide_moy_habitat_plot <- ggplot(subset(nb_photo_dt, !is.na(habitat)), aes(habitat, pourcentage_photo_valide)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(size = 1, fill = "white", shape = 21) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1, color="red", fill="red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Habitat", y = "Pourcentage de photo valide"); pourc_photo_valide_moy_habitat_plot

# model
tab_model(lm(pourcentage_photo_valide ~ habitat,
             data=transform(nb_photo_dt[!is.na(nb_photo_dt$habitat),], habitat=forcats::fct_relevel(habitat,"Fourrés"))), 
          title = "Pourcentage de photo valide en fonction de l'habitat (ref= Fourrés)")
```

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=4, fig.height=4}
# plot
nb_photo_dt_2 <- nb_photo_dt[nb_photo_dt$habitat!="Absence de végétation" & 
                               nb_photo_dt$habitat!="Berge sous pont",]
table(nb_photo_dt_2$habitat)

# plot
pourc_photo_valide_moy_habitat_plot <- ggplot(subset(nb_photo_dt_2, !is.na(habitat)), aes(habitat, pourcentage_photo_valide)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(size = 1, fill = "white", shape = 21) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1, color="red", fill="red") +
  theme_classic() +
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Habitat", y = "Pourcentage de photo valide"); pourc_photo_valide_moy_habitat_plot

# model
tab_model(lm(pourcentage_photo_valide ~ habitat,
             data=transform(nb_photo_dt_2[!is.na(nb_photo_dt_2$habitat),], habitat=forcats::fct_relevel(habitat,"Fourrés"))), 
          title = "Pourcentage de photo valide en fonction de l'habitat (ref= Fourrés)")
```

## ~ distance à l'eau

### Nombre

Nombre de photos valides moyen par point d'observation en fonction de la distance à l'eau

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# data
# nb_photo_dt$distance_eau <- ntile(nb_photo_dt$distance_eau, 35)
# 
# nb_photo_valide_moy_distance_eau_dt <- nb_photo_dt %>%
#   select(ID_unique, distance_eau, nb_photo_valide, nb_photo_valide, pourcentage_photo_valide) %>% 
#   group_by(distance_eau) %>% 
#   mutate(mean_photo_valide = mean(nb_photo_valide)) %>% 
#   mutate(sd_photo_valide = sd(nb_photo_valide)) %>% 
#   mutate(mean_pourc_photo_valide = mean(pourcentage_photo_valide)) %>%
#   mutate(sd_pourc_photo_valide = sd(pourcentage_photo_valide)) %>% 
#   select(distance_eau, mean_photo_valide, sd_photo_valide, mean_pourc_photo_valide, sd_pourc_photo_valide) %>% 
#   distinct()
# 
# nb_photo_valide_moy_distance_eau_dt <- nb_photo_valide_moy_distance_eau_dt[!is.na(nb_photo_valide_moy_distance_eau_dt$distance_eau),]
```

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# plot
nb_photo_valide_moy_distance_eau_plot <- ggplot(subset(nb_photo_dt, !is.na(distance_eau)), aes(distance_eau, nb_photo_valide)) +
  geom_point(size = 4, fill = "grey", shape = 21) +
  geom_smooth(method = lm, formula = y ~ x) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Distance à l'eau", y = "Nombre de photo valide"); nb_photo_valide_moy_distance_eau_plot

# model
tab_model(lm(nb_photo_valide ~ distance_eau,
             data=nb_photo_dt[!is.na(nb_photo_dt$distance_eau),]),
          lm(nb_photo_valide ~ distance_eau + I(distance_eau^2),
             data=nb_photo_dt[!is.na(nb_photo_dt$distance_eau),]),
          title = "Nombre de photo valide en fonction de la distance à leau")
```

### Pourcentage

Pourcentage de photos valides sur le nombre de photo total par point d'observation en fonction de la distance à l'eau.

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# plot
pourc_photo_valide_moy_distance_eau_plot <- ggplot(subset(nb_photo_dt, !is.na(distance_eau)), aes(distance_eau, pourcentage_photo_valide)) +
  geom_point(size = 4, fill = "grey", shape = 21) +
  geom_smooth(method = lm, linetype = "dotted") +
  theme_classic() +
  labs(title="",
        x ="Distance à l'eau", y = "Pourcentage de photo valide"); pourc_photo_valide_moy_distance_eau_plot

# model
tab_model(lm(pourcentage_photo_valide ~ distance_eau,
             data=nb_photo_dt[!is.na(nb_photo_dt$distance_eau),]), 
          title = "Pourcentage de photo valide en fonction de la distance à l'eau")
```

## ~ semaine de pose

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# data
nb_photo_dt <- nb_photo_dt %>%
   mutate(week = week(date_pose))
# 
# nb_photo_valide_moy_week_dt <- nb_photo_dt %>%
#   select(ID_unique, week, nb_photo_valide, nb_photo_valide, pourcentage_photo_valide) %>% 
#   group_by(week) %>% 
#   mutate(mean_photo_valide = mean(nb_photo_valide)) %>% 
#   mutate(sd_photo_valide = sd(nb_photo_valide)) %>% 
#   mutate(mean_pourc_photo_valide = mean(pourcentage_photo_valide)) %>%
#   mutate(sd_pourc_photo_valide = sd(pourcentage_photo_valide)) %>% 
#   select(week, mean_photo_valide, sd_photo_valide, mean_pourc_photo_valide, sd_pourc_photo_valide) %>% 
#   distinct()
# 
# nb_photo_valide_moy_week_dt <- nb_photo_valide_moy_week_dt[!is.na(nb_photo_valide_moy_week_dt$week),]
```

### Nombre

Nombre de photo valide en fonction de la semaine de pose du piège photo.

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# plot
nb_photo_valide_moy_week_plot <- ggplot(subset(nb_photo_dt, !is.na(week)), aes(week, nb_photo_valide)) +
  geom_point(size = 4, fill = "grey", shape = 21) +
  geom_smooth(method = lm, formula = y ~ x, linetype = "dotted") +
  theme_classic() +
  labs(title="",
        x ="Semaine de pose", y = "Nombre de photo valide"); nb_photo_valide_moy_week_plot

# model
tab_model(lm(nb_photo_valide ~ week,
             data=nb_photo_dt[!is.na(nb_photo_dt$week),]), 
          title = "Nombre de photo valide en fonction de la semaine de pose du piège photo")
```

### Pourcentage

Pourcentage de photos valides sur le nombre de photo total par point d'observation en fonction de la distance à l'eau.

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# plot
pourc_photo_valide_moy_week_plot <- ggplot(subset(nb_photo_dt, !is.na(week)), aes(week, pourcentage_photo_valide)) +
  geom_point(size = 4, fill = "grey", shape = 21) +
  geom_smooth(method = lm, formula = y ~ x) +
  theme_classic() +
  labs(title="",
        x ="Semaine de pose", y = "Pourcentage de photo valide"); pourc_photo_valide_moy_week_plot

# model
tab_model(lm(pourcentage_photo_valide ~ week,
             data=nb_photo_dt[!is.na(nb_photo_dt$week),]), 
          title = "Pourcentage de photo valide en fonction de la semaine du pose du piège")
```

NEWNEWNEWNEWNEW

Abcisse en mois, de septembre à mars 

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=4, fig.height=5}
nb_photo_dt_new <- nb_photo_dt[!is.na(nb_photo_dt$date_pose),]
# nb_photo_dt_new$day_month <- substr(nb_photo_dt_new$date_pose, start = 6, stop = 10)
# nb_photo_dt_new$day_month_2 <- gsub('-','/', nb_photo_dt_new$day_month)
# nb_photo_dt_new$day_month_3 <- paste0(nb_photo_dt_new$day_month_2, "/24")
# nb_photo_dt_new$day_month_4 <- as.Date(nb_photo_dt_new$day_month_3, "%m/%d/%y")
# nb_photo_dt_new$day_month_5 <- mday(nb_photo_dt_new$day_month_4)
# start_date <- "2024-09-01"
# nb_photo_dt_new$date_diff <- difftime(nb_photo_dt_new$day_month_4, start_date)

nb_photo_dt_new$month <- substr(nb_photo_dt_new$date_pose, start = 6, stop = 7)
nb_photo_dt_new$month_2 <- as.numeric(nb_photo_dt_new$month)
nb_photo_dt_new$month_3 <- nb_photo_dt_new$month
nb_photo_dt_new$month_3[nb_photo_dt_new$month_3=="01"] <- "Janvier"
nb_photo_dt_new$month_3[nb_photo_dt_new$month_3=="02"] <- "Février"
nb_photo_dt_new$month_3[nb_photo_dt_new$month_3=="03"] <- "Mars"
nb_photo_dt_new$month_3[nb_photo_dt_new$month_3=="09"] <- "Septembre"
nb_photo_dt_new$month_3[nb_photo_dt_new$month_3=="10"] <- "Octobre"
nb_photo_dt_new$month_3[nb_photo_dt_new$month_3=="11"] <- "Novembre"
nb_photo_dt_new$month_3[nb_photo_dt_new$month_3=="12"] <- "Décembre"

nb_photo_dt_new$month_3 <- factor(nb_photo_dt_new$month_3, levels = c("Septembre", "Octobre", "Novembre",
                                                                       "Décembre", "Janvier", "Février", "Mars"))

# plot
pourc_photo_valide_moy_week_plot_new <- ggplot(nb_photo_dt_new, aes(month_3, pourcentage_photo_valide)) +
  geom_point(size = 2, fill = "grey", shape = 21) +
  stat_summary(data = nb_photo_dt_new, 
               aes(month_3, pourcentage_photo_valide),
               fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red") +
  stat_summary(data = nb_photo_dt_new,
               aes(month_3, pourcentage_photo_valide),
               fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x),
               fun.ymax = function(x) mean(x) + sd(x),
               geom = "linerange", shape=20, size=1, color="red", fill="red") +
  # geom_signif(data = nb_photo_dt_new,
  #              aes(month_3, pourcentage_photo_valide),
  #             comparisons = list(c("Septembre", "Janvier")),
  #             map_signif_level=TRUE,
  #             y_position = 130, color = "black",
  #             test = "t.test") +
  # geom_signif(data = nb_photo_dt_new,
  #             aes(month_3, pourcentage_photo_valide),
  #             comparisons = list(c("Septembre", "Février")),
  #             map_signif_level=TRUE,
  #             y_position = 115, color = "black",
  #             test = "t.test") +
  theme_classic() +
  # ylim(0, 135) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Mois de pose", y = "Pourcentage de photo valide"); pourc_photo_valide_moy_week_plot_new
```

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# model
tab_model(lm(pourcentage_photo_valide ~ month,
             data=nb_photo_dt_new), 
          title = "Pourcentage de photo valide en fonction du mois de pose (ref = Janvier)")
tab_model(lm(pourcentage_photo_valide ~ month_2,
             data=nb_photo_dt_new), 
          title = "Pourcentage de photo valide en fonction du mois de pose (ref = Janvier)")
tab_model(lm(pourcentage_photo_valide ~ month_2 + I(month_2^2),
             data=nb_photo_dt_new), 
          title = "Pourcentage de photo valide en fonction du mois de pose (ref = Janvier)")
tab_model(lm(pourcentage_photo_valide ~ month_3,
             data=nb_photo_dt_new), 
          title = "Pourcentage de photo valide en fonction du mois de pose (ref = Janvier)")
```

## ~ all

Ici j'ai fait de la "sélection de modèle" : j'ai testé les effets de toutes les covariables testées une à une précédemment en même temps.

Pour savoir quel est le meilleur modèle il faut regarder les AIC et delta AIC.

En résumé, l'AIC quantifie la qualité du modèle tout en la pondérant par le nombre de covariables qu'il faut inclure dans le modèle. Evidemment, meilleur est le modèle mieux c'est, mais c'est encore mieux si un petit nombre de covariables explicatives sont nécessaires pour avoir un bon modèle (c'est à dire un modèle qui prédit bien la variable à expliquer, ici par exemple le nombre de photos valides).

Le delta AIC est la différence entre l'AIC d'un modèle et l'AIC du modèle qui a le plus petit AIC. Un delta AIC de moins de 2 points signifit que les modèles sont équivalents pour ce qui est de leur qualité, leur capacité à expliquer la variable. 

Parmi les modèles avec un delta AIC < à 2, on choisira donc le modèle qui présent le moyen de covariable (en résumé, le plus petit nombre de df "degree of freedom").

### Nombre de photo valide

Liste de tous les modèles testés, avec différentes combinaisons de covariables

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=6, fig.height=6}
nb_photo_valide_dregde_dt <- nb_photo_dt %>% 
  select(nb_photo_valide, hauteur, habitat, distance_eau, support, week) %>% 
  na.omit()

options(na.action = "na.fail")
nb_photo_valide.fullmodel <- lm(nb_photo_valide ~., data = nb_photo_valide_dregde_dt)
nb_photo_valide.dredge <- dredge(nb_photo_valide.fullmodel, rank = "AIC")
nb_photo_valide.dredge
```

Liste des meilleurs modèles (avec un delta AIC < à 2)

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=6, fig.height=6}
list_best_model <- nb_photo_valide.dredge[nb_photo_valide.dredge$delta<2] ; list_best_model
```

Le plus simple des meilleurs modèles (parmi les meilleurs modèles, celui avec le plus petit df)

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=6, fig.height=6}
best_model <- list_best_model[list_best_model$df==min(list_best_model$df)] ; best_model
```

### Pourcentage de photo valide

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=6, fig.height=6}
pourc_photo_valide_dregde_dt <- nb_photo_dt %>% 
  select(pourcentage_photo_valide, hauteur, habitat, distance_eau, support, week) %>% 
  na.omit()

options(na.action = "na.fail")
pourc_photo_valide.fullmodel <- lm(pourcentage_photo_valide ~., data = pourc_photo_valide_dregde_dt)
pourc_photo_valide.dredge <- dredge(pourc_photo_valide.fullmodel, rank = "AIC")
pourc_photo_valide.dredge
```

Liste des meilleures modèles

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=6, fig.height=6}
list_best_model_pourc <- pourc_photo_valide.dredge[pourc_photo_valide.dredge$delta<2] ; list_best_model_pourc
```

Le plus simple des meilleurs modèles

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=6, fig.height=6}
best_model_pourc <- list_best_model_pourc[list_best_model_pourc$df==min(list_best_model_pourc$df)] ; best_model_pourc
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE, fig.width=3.5, fig.height=3.5}
## Graphique prédictions
### Nombre

nb_photo_valide_model_pred <- lm(nb_photo_valide ~ distance_eau, 
                 data = nb_photo_valide_dregde_dt) 

nb_photo_valide_pred_plot <- ggplot(nb_photo_valide_dregde_dt, 
                                       aes(predict(nb_photo_valide_model_pred), nb_photo_valide)) +
  geom_jitter(alpha = 0.2) +
  geom_smooth(method = lm, color = "green") +
  geom_abline(intercept = 0, slope = 1, color = "blue") +
  theme_classic() +
  labs(title="",
        x ="Nombre de photos valides prédit", y = "Nombre de photos valides observés"); nb_photo_valide_pred_plot
```

```{r, echo=FALSE,message=FALSE, warning=FALSE, include=FALSE, fig.width=3.5, fig.height=3.5}
## Graphique prédictions
### Pourcentage

pourc_photo_valide_model_pred <- lm(pourcentage_photo_valide ~ support + week, 
                 data = pourc_photo_valide_dregde_dt) 

pourc_photo_valide_pred_plot <- ggplot(pourc_photo_valide_dregde_dt, 
                                       aes(predict(pourc_photo_valide_model_pred), pourcentage_photo_valide)) +
  geom_jitter(alpha = 0.2) +
  geom_smooth(method = lm, color = "green") +
  geom_abline(intercept = 0, slope = 1, color = "blue") +
  theme_classic() +
  labs(title="",
        x ="Pourcentage de photos valides prédit", y = "Pourcentage de photos valides observés"); pourc_photo_valide_pred_plot
```

## Résumé résultats

Pour maximiser le nombre de photo valide moyen par piège et le pourcentage moyen de photo valide par piège il faut : 1) être proche de l'eau, 2) éviter les supports "piquet", et 3) poser les pièges photo plutôt en décembre  

# Nombre d'observation 

Nombre de point d'observation différent (= un même piege photo à un endroit donné) :

```{r, echo=FALSE}
nb_point_detection <- length(unique(data_1$ID_unique)) 
nb_point_detection
```

Nombre total d'observation, en prenant en compte l'ensemble des detections (y compris les detections multiples pour les espèces non focales) :

```{r, echo=FALSE}
nb_observation_all <- sum(data_1$nb_detection) 
nb_observation_all
```

Nombre total d'observation seulement pour les espèces de la liste ressérée (liste 3), en prenant en compte l'ensemble des detections (y compris les detections multiples pour les espèces non focales) :

```{r, echo=FALSE}
nb_observation_all_list_3 <- sum(data_4_list_3$nb_detection) 
nb_observation_all_list_3
```

## Nbv obs par espèce

Nombre d'observation par espèce pour chaque piège.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
nb_obs_esp_dt <- data_4 %>% 
  group_by(espece, ID_unique, list_1) %>%
  mutate(nb_obs_esp = sum(nb_detection)) %>% 
  select(espece, ID_unique, nb_obs_esp) %>% 
  distinct() %>% 
  arrange(list_1, espece)

nb_obs_esp_dt_shown <- nb_obs_esp_dt %>% 
  dplyr::rename(groupe = list_1, espèce = espece, "nombre d'observation" = nb_obs_esp,
                "point d'observation" = ID_unique)

# Click table
nb_obs_esp_dt_shown %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

ne prends pas en compter le nombre de détection supérieur à 1 (juste le nombre de lignes)

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=20}
nb_obs_esp_plot <- ggplot(data_4, aes(x=fct_infreq(espece))) + 
  geom_bar(aes(fill = list_1), stat = "count", position = position_stack(reverse = TRUE)) +
  theme_classic() +
  coord_flip() +
  theme(legend.position = "top") +
  scale_fill_manual(values=cols) +
  labs(title="Nombre d'observation par espèce",
        x ="Espèce", y = "Nombre d'observation", fill=""); nb_obs_esp_plot
```

NEWNEWNEWNEWNEW

Prends en compte toutes les détections 

```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.width=10, fig.height=10}
sum_dt_data_4 <- data_4 %>% 
  group_by(espece) %>% 
  mutate(nb_obs = sum(nb_detection)) %>% 
  select(espece, nb_obs) %>% 
  distinct()

data_4_plot_2 <- sum_dt_data_4 %>% 
  filter(espece!="Chien") %>%
  filter(espece!="Rougegorge familier") %>% 
  filter(espece!="Troglodyte mignon") %>%
  filter(espece!="Merle noir") %>%
  filter(espece!="Mésange charbonnière") %>%
  filter(espece!="Grive musicienne") %>%
  filter(espece!="Bouscarle de cetti") %>%
  filter(espece!="Pouillot véloce") %>%
  filter(espece!="Accenteur mouchet") %>%
  filter(espece!="Râle d'eau") %>%
  filter(espece!="Gallinule poule d'eau") %>%
  filter(espece!="Fauvette à tête noire") %>%
  filter(espece!="Pouillot fitis") %>%
  filter(espece!="Ragondin") %>%
  filter(espece!="Torcol fourmilier") %>%
  filter(espece!="Oiseau indéterminé") %>%
  filter(espece!="Phragmite des joncs") %>%
  filter(espece!="Bruant des roseaux") %>%
  filter(espece!="Gorgebleue à miroir") %>%
  filter(espece!="Grande aigrette") %>%
  filter(espece!="Héron cendré") %>%
  filter(espece!="Cygne tuberculé") %>%
  filter(espece!="Canard colvert") %>%
  filter(espece!="Pinson des arbres") %>%
  filter(espece!="Hibou moyen-duc") %>%
  filter(espece!="Epervier d'Europe") %>%
  filter(espece!="Tadorne de Belon") %>%
  filter(espece!="Pie bavarde") %>%
  filter(espece!="Fauvette grisette") %>%
  filter(espece!="Chat domestique") %>%
  filter(espece!="Rougequeue à front blanc") %>%
  filter(espece!="Mésange bleue") %>%
  filter(espece!="Cisticole des joncs") %>%
  filter(espece!="Etourneau sansonnet") %>%
  filter(espece!="Grand cormoran") %>%
  filter(espece!="Aigrette garzette") %>%
  filter(espece!="Martin-pêcheur d'Europe") %>%
  filter(espece!="Faisan de Colchide") %>%
  filter(espece!="Bécassine des marais") %>%
  filter(espece!="Bihoreau gris") %>%
  filter(espece!="Geai des chênes") %>%
  filter(espece!="Rossignol philomèle") %>%
  filter(espece!="Spatule blanche") %>%
  filter(espece!="Foulque macroule") %>%
  filter(espece!="Pigeon ramier") %>%
  filter(espece!="Grive mauvis") %>%
  filter(espece!="Pic épeiche") %>%
  filter(espece!="Chardonneret élégant") %>%
  filter(espece!="Rousserolle effarvatte") %>%
  filter(espece!="Mésange à longue queue") %>%
  filter(espece!="Faisan sp") %>%
  filter(espece!="Canard sp") %>%
  filter(espece!="Moineau domestique") %>%
  filter(espece!="Buse variable") %>%
  filter(espece!="Grive litorne") %>%
  filter(espece!="Chevalier culblanc") %>%
  filter(espece!="Sarcelle d'hiver") %>%
  filter(espece!="Tarier pâtre") %>%
  filter(espece!="Pic vert") %>%
  filter(espece!="Roitelet à triple bandeaux") %>%
  filter(espece!="Pipit farlouse") %>%
  filter(espece!="Canard pilet") %>%
  filter(espece!="Tourterelle des bois") %>%
  filter(espece!="Faucon crécerelle") %>%
  filter(espece!="Effraie des clochers") %>%
  filter(espece!="Chouette hulotte") %>%
  filter(espece!="Gros-bec casse-noyaux") %>%
  filter(espece!="Gobemouche noir") %>%
  filter(espece!="Bergeronnette des ruisseaux") %>%
  filter(espece!="Verdier d'Europe") %>%
  filter(espece!="Bergeronnette grise") %>%
  filter(espece!="Alouette des champs") %>%
  filter(espece!="Bruant zizi") %>%
  filter(espece!="Mouton") %>%
  filter(espece!="Chèvre") %>%
  filter(espece!="Perdrix rouge") %>%
  filter(espece!="Vache domestique") %>%
  filter(espece!="Merle à plastron") %>%
  filter(espece!="Tarin des aulnes") %>%
  filter(espece!="Traquet motteux") %>%
  filter(espece!="Indéterminé") %>%
  filter(espece!="Pigeon biset") %>%
  filter(espece!="Grimpereau des jardins") %>%
  filter(espece!="Cistude d'Europe") %>%
  filter(espece!="Grenouille verte indéterminée") %>%
  filter(espece!="Couleuvre sp") %>%
  filter(espece!="Lézard des murailles") %>%
  filter(espece!="Couleuvre verte et jaune") %>%
  filter(espece!="Amphibien sp") %>%
  filter(espece!="Lézard à deux raies") %>%
  filter(espece!="Lézard à deux raies") %>%
  filter(espece!="Couleuvre helvétique") %>%
  filter(espece!="Crapaud épineux") %>%
  filter(espece!="Urodèle sp") %>%
  filter(espece!="Serpent sp") 

unique(data_4_plot_2$espece)

# Click table
data_4_plot_2 %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

nb_obs_esp_list_3_plot_2 <- ggplot(data_4_plot_2, aes(x=reorder(espece, nb_obs), nb_obs)) + 
  geom_segment(aes(x=reorder(espece, nb_obs), xend=reorder(espece, nb_obs), y=0, yend=nb_obs),
               size = 3, color = "#D9C756") +
  geom_point(size = 4, shape = 21, color = "#D9C756", fill = "#E35205") + 
  theme_classic() +
  coord_flip() +
  theme(legend.position = "top") +
  # scale_fill_manual(values=cols) +
  labs(title="Nombre d'observation par espèce",
        x ="Espèce", y = "Nombre d'observation", fill=""); nb_obs_esp_list_3_plot_2


```

NEWNEWNEWNEWNEW

Sans mulot/souris et Rat surmulot car beaucoup trop d'observation

```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.width=10, fig.height=6}
nb_obs_esp_list_3_plot_3 <- ggplot(data_4_plot_2[data_4_plot_2$espece!="Mulot/souris" & data_4_plot_2$espece!="Rat surmulot",], aes(x=reorder(espece, nb_obs), nb_obs)) + 
  geom_segment(aes(x=reorder(espece, nb_obs), xend=reorder(espece, nb_obs), y=0, yend=nb_obs),
               size = 3, color = "#D9C756") +
  geom_point(size = 4, shape = 21, color = "#D9C756", fill = "#E35205") + 
  theme_classic() +
  coord_flip() +
  theme(legend.position = "top") +
  # scale_fill_manual(values=cols) +
  labs(title="Nombre d'observation par espèce",
        x ="Espèce", y = "Nombre d'observation", fill=""); nb_obs_esp_list_3_plot_3
```

Nombre d'observation par espèce pour chaque piège, uniquement pour les espèces d'intérêt de la liste 3.

```{r, message=FALSE, warning=FALSE, echo=FALSE}
nb_obs_esp_list_3_dt <- data_4_list_3 %>% 
  group_by(espece, ID_unique) %>%
  mutate(nb_obs_esp = sum(nb_detection)) %>% 
  select(espece, ID_unique, nb_obs_esp) %>% 
  distinct() %>% 
  arrange(espece)

nb_obs_esp_list_3_dt_shown <- nb_obs_esp_list_3_dt %>% 
  dplyr::rename(espèce = espece, "nombre d'observation" = nb_obs_esp,
                "point d'observation" = ID_unique)

# Click table
nb_obs_esp_list_3_dt_shown %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.width=5, fig.height=5}
nb_obs_esp_list_3_plot <- ggplot(data_4_list_3, aes(x=fct_infreq(espece))) + 
  geom_bar(stat = "count", position = position_stack(reverse = TRUE)) +
  theme_classic() +
  coord_flip() +
  theme(legend.position = "top") +
  scale_fill_manual(values=cols) +
  labs(title="Nombre d'observation par espèce",
        x ="Espèce", y = "Nombre d'observation", fill=""); nb_obs_esp_list_3_plot
```


NEWNEWNEWNEWNEW

Nombre d'observation mise à jour (en prenant bien le nombre total de détection, cf notre discussion avec Alexandra le 19/11/2024), et graphique associé

```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.width=5, fig.height=3}
sum_dt <- data_4_list_3 %>% 
  group_by(espece) %>% 
  mutate(nb_obs = sum(nb_detection)) %>% 
  select(espece, nb_obs) %>% 
  distinct()

# Click table
sum_dt %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

nb_obs_esp_list_3_plot_2 <- ggplot(sum_dt, aes(x=reorder(espece, nb_obs), nb_obs)) + 
  geom_segment(aes(x=reorder(espece, nb_obs), xend=reorder(espece, nb_obs), y=0, yend=nb_obs),
               size = 3, color = "#6CACE4") +
  geom_point(size = 4, shape = 21, color = "#6CACE4", fill = "#147bd1") + 
  theme_classic() +
  coord_flip() +
  theme(legend.position = "top") +
  # scale_fill_manual(values=cols) +
  labs(title="Nombre d'observation par espèce",
        x ="Espèce", y = "Nombre d'observation", fill=""); nb_obs_esp_list_3_plot_2
```


                                             
## Nb obs total /piege/jour

Nombre d'observation par piège en prenant en compte l'ensemble des detections (y compris les detections multiples pour les espèces non focales).

```{r, echo=FALSE}
nb_obs_dt <- data_4 %>%
  group_by(ID_unique) %>% 
  mutate(nb_obs_par_piege = sum(nb_detection)) %>%
  mutate(nb_obs_par_piege_par_jour = sum(nb_detection)/duree_obs) %>% 
  select(ID_unique, date_pose, date_retrait, distance_eau, hauteur, support, temp, DAC_interaction,
         coulee, habitat, date_fin_obs, duree_obs, hour_obs,
         nb_obs_par_piege, nb_obs_par_piege_par_jour,
         list_3) %>% 
  distinct() %>% 
  na.omit()

nb_obs_dt_shown <- nb_obs_dt %>% 
  select(ID_unique, nb_obs_par_piege, nb_obs_par_piege_par_jour) %>% 
  distinct() %>% 
  dplyr::rename("point d'observation" = ID_unique, 
                "nombre de détection" = nb_obs_par_piege, 
                "nombre de détection par jour d'observation" = nb_obs_par_piege_par_jour)

# Click table
nb_obs_dt_shown %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

## Nb obs par espèce /piège/jour

Nombre d'observation par espèce par piège en prenant en compte l'ensemble des detections (y compris les detections multiples pour les espèces non focales).

Seulement les espèces d'intérêt (liste 3).

```{r, echo=FALSE}
nb_obs_esp_dt <- data_4_list_3 %>%
  group_by(espece, ID_unique) %>% 
  mutate(nb_obs_esp_par_piege = sum(nb_detection)) %>%
  mutate(nb_obs_esp_par_piege_par_jour = sum(nb_detection)/duree_obs) %>% 
  select(espece,ID_unique,date_pose,date_retrait,distance_eau,hauteur,
         support,temp,DAC_interaction,coulee,habitat,date_fin_obs,duree_obs,hour_obs,
         nb_obs_esp_par_piege,nb_obs_esp_par_piege_par_jour,list_3) %>% 
  distinct() %>% 
  na.omit()

nb_obs_esp_dt_shown <- nb_obs_esp_dt %>% 
  select(espece, ID_unique, nb_obs_esp_par_piege, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  dplyr::rename("espèce" = espece,
                "point d'observation" = ID_unique, 
                "nombre de détection" = nb_obs_esp_par_piege, 
                "nombre de détection par jour d'observation" = nb_obs_esp_par_piege_par_jour)

# Click table
nb_obs_esp_dt_shown %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

## ~ hauteur 

### global

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# # data
# nb_obs_moy_hauteur_dt <- nb_obs_dt %>% 
#   group_by(hauteur) %>% 
#   mutate(mean_obs_par_jour = mean(nb_obs_par_piege_par_jour)) %>% 
#   mutate(sd_obs_par_jour = sd(nb_obs_par_piege_par_jour)) %>%
#   select(hauteur, mean_obs_par_jour, sd_obs_par_jour) %>% 
#   distinct() %>% 
#   na.omit()
```

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
nb_obs_hauteur_dt <- nb_obs_dt %>% 
  select(ID_unique, hauteur, nb_obs_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

nb_obs_moy_hauteur_plot2 <- ggplot(nb_obs_hauteur_dt, aes(hauteur, nb_obs_par_piege_par_jour)) +
  geom_point(shape = 21, fill = "grey", size = 4) +
  geom_smooth(method = lm, linetype = "dotted") +
  ylab("Nombre d'observation /piège/jour") + xlab("Hauteur") +
  theme_classic(); nb_obs_moy_hauteur_plot2

tab_model(lm(nb_obs_par_piege_par_jour ~ hauteur, data = nb_obs_hauteur_dt), 
          lm(nb_obs_par_piege_par_jour ~ hauteur + I(hauteur^2), data = nb_obs_hauteur_dt),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation")
```

### par espèce

Seulement les espèces d'intérêt (liste 3).

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}
nb_obs_esp_hauteur_dt <- nb_obs_esp_dt %>% 
  select(espece, ID_unique, hauteur, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

nb_obs_esp_moy_hauteur_plot <- ggplot(data = nb_obs_esp_hauteur_dt,
             aes(hauteur, nb_obs_esp_par_piege_par_jour)) +
  geom_point(size = 4, shape = 21, fill = "grey") +
  geom_smooth(method = lm, linetype = "dotted") +
  facet_wrap(~ espece, ncol = 5) +
  ylab("Nombre d'observation /piège/jour") + xlab("Hauteur") +
  theme_classic() ; nb_obs_esp_moy_hauteur_plot
```

Modèles pour chaque espèce séparemment :

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}
tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hauteur, 
             data = nb_obs_esp_hauteur_dt[nb_obs_esp_hauteur_dt$espece=="Belette d'Europe",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Belette d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hauteur, 
             data = nb_obs_esp_hauteur_dt[nb_obs_esp_hauteur_dt$espece=="Blaireau européen",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Blaireau européen)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hauteur, 
             data = nb_obs_esp_hauteur_dt[nb_obs_esp_hauteur_dt$espece=="Fouine",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Fouine)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hauteur, 
             data = nb_obs_esp_hauteur_dt[nb_obs_esp_hauteur_dt$espece=="Fouine/Martre",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Fouine/Martre)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hauteur, 
             data = nb_obs_esp_hauteur_dt[nb_obs_esp_hauteur_dt$espece=="Genette commune",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Genette commune)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hauteur, 
             data = nb_obs_esp_hauteur_dt[nb_obs_esp_hauteur_dt$espece=="Loutre d’Europe",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Loutre d’Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hauteur, 
             data = nb_obs_esp_hauteur_dt[nb_obs_esp_hauteur_dt$espece=="Martre des Pins",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Martre des Pins)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hauteur, 
             data = nb_obs_esp_hauteur_dt[nb_obs_esp_hauteur_dt$espece=="Putois d'Europe",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Putois d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hauteur, 
             data = nb_obs_esp_hauteur_dt[nb_obs_esp_hauteur_dt$espece=="Raton laveur",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Raton laveur)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hauteur, 
             data = nb_obs_esp_hauteur_dt[nb_obs_esp_hauteur_dt$espece=="Renard roux",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Renard roux)")
```

## ~ support 

### global

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=4, fig.height=4}
# data
nb_obs_support_dt <- nb_obs_dt %>% 
  select(ID_unique, support, nb_obs_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

# plot
nb_obs_support_plot <- ggplot(nb_obs_support_dt, aes(support, nb_obs_par_piege_par_jour)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(width = 0.2, height = 0.2, size = 1, fill = "white", shape = 21) +
  stat_summary(data = nb_obs_support_dt, 
               aes(support, nb_obs_par_piege_par_jour),
               fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red") +
  stat_summary(data = nb_obs_support_dt, 
               aes(support, nb_obs_par_piege_par_jour),
               fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1.5, color="red", fill="red") +
  geom_signif(data = nb_obs_support_dt, aes(x=support, y=nb_obs_par_piege_par_jour),
              comparisons = list(c("Arbre", "Piquet")),
              map_signif_level=TRUE,
              y_position = 37, color = "black",
              test = "t.test") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Support", y = "Nombre de photo valide"); nb_obs_support_plot

# model
tab_model(lm(nb_obs_par_piege_par_jour ~ support, data = nb_obs_support_dt), 
          title = "Nombre d'observation /piège/jour en fonction du support d'installation (ref = Arbre)")
```

### par espèce

Seulement les espèces d'intérêt (liste 3).

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}
# data
nb_obs_esp_support_dt <- nb_obs_esp_dt %>% 
  select(espece, ID_unique, support, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

# plot
nb_obs_support_plot <- ggplot(nb_obs_esp_support_dt, aes(support, nb_obs_esp_par_piege_par_jour)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(width = 0.2, height = 0.2, size = 1, fill = "white", shape = 21) +
  stat_summary(data = nb_obs_esp_support_dt, 
               aes(support, nb_obs_esp_par_piege_par_jour),
               fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red") +
  stat_summary(data = nb_obs_esp_support_dt, 
               aes(support, nb_obs_esp_par_piege_par_jour),
               fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1.5, color="red", fill="red") +
  geom_signif(data = nb_obs_esp_support_dt, aes(x=support, y=nb_obs_esp_par_piege_par_jour),
              comparisons = list(c("Arbre", "Piquet")),
              map_signif_level=TRUE,
              y_position = 2.8, color = "black",
              test = "t.test") +
  facet_wrap(~ espece, ncol = 5) +
  theme_classic() +
  ylim(-0.3, 3.2) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Support", y = "Nombre de photo valide"); nb_obs_support_plot

# model
tab_model(lm(nb_obs_par_piege_par_jour ~ support, data = nb_obs_support_dt), 
          title = "Nombre d'observation /piège/jour en fonction du support d'installation (ref = Arbre)")
```

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}
tab_model(lm(nb_obs_esp_par_piege_par_jour ~ support, 
             data = nb_obs_esp_support_dt[nb_obs_esp_support_dt$espece=="Belette d'Europe",]),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Belette d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ support, 
             data = nb_obs_esp_support_dt[nb_obs_esp_support_dt$espece=="Blaireau européen",]),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Blaireau européen)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ support, 
             data = nb_obs_esp_support_dt[nb_obs_esp_support_dt$espece=="Fouine",]),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Fouine)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ support, 
             data = nb_obs_esp_support_dt[nb_obs_esp_support_dt$espece=="Fouine/Martre",]),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Fouine/Martre)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ support, 
             data = nb_obs_esp_support_dt[nb_obs_esp_support_dt$espece=="Genette commune",]),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Genette commune)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ support, 
             data = nb_obs_esp_support_dt[nb_obs_esp_support_dt$espece=="Loutre d’Europe",]),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Loutre d’Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ support, 
             data = nb_obs_esp_support_dt[nb_obs_esp_support_dt$espece=="Martre des Pins",]),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Martre des Pins)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ support, 
             data = nb_obs_esp_support_dt[nb_obs_esp_support_dt$espece=="Putois d'Europe",]),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Putois d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ support, 
             data = nb_obs_esp_support_dt[nb_obs_esp_support_dt$espece=="Raton laveur",]),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Raton laveur)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ support, 
             data = nb_obs_esp_support_dt[nb_obs_esp_support_dt$espece=="Renard roux",]),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Renard roux)")
```

## ~ habitat 

### global

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=6, fig.height=6}
# data
nb_obs_habitat_dt <- nb_obs_dt %>% 
  select(ID_unique, habitat, nb_obs_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

# plot
nb_obs_habitat_plot <- ggplot(nb_obs_habitat_dt, aes(habitat, nb_obs_par_piege_par_jour)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(width = 0.2, height = 0.2, size = 1, fill = "white", shape = 21) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1.5, color="red", fill="red") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Habitat", y = "Nombre d'observation /piège/jour"); nb_obs_habitat_plot

# model
tab_model(lm(nb_obs_par_piege_par_jour ~ habitat, 
             data = nb_obs_habitat_dt, habitat=forcats::fct_relevel(habitat,"Fourrés")), 
          title = "Nombre d'observation /piège/jour en fonction de l'habitat (ref= Fourrés)")
```

NEWNEWNEWNEWNEW

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=4, fig.height=4}
# data
nb_obs_habitat_dt <- nb_obs_dt %>% 
  select(ID_unique, habitat, nb_obs_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

nb_obs_habitat_dt_2 <- nb_obs_habitat_dt[nb_obs_habitat_dt$habitat!="Absence de végétation" & 
                                           nb_obs_habitat_dt$habitat!="Berge sous pont",]

table(nb_obs_habitat_dt_2$habitat)

# plot
nb_obs_habitat_plot <- ggplot(nb_obs_habitat_dt_2, aes(habitat, nb_obs_par_piege_par_jour)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(width = 0.2, height = 0.2, size = 1, fill = "white", shape = 21) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1.5, color="red", fill="red") +
  theme_classic() +
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Habitat", y = "Nombre d'observation /piège/jour"); nb_obs_habitat_plot

# model
tab_model(lm(nb_obs_par_piege_par_jour ~ habitat, 
             data = nb_obs_habitat_dt_2, habitat=forcats::fct_relevel(habitat,"Fourrés")), 
          title = "Nombre d'observation /piège/jour en fonction de l'habitat (ref= Fourrés)")
```

### par espèce

Seulement les espèces d'intérêt (liste 3).

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}
# data
nb_obs_esp_habitat_dt <- nb_obs_esp_dt %>% 
  select(espece, ID_unique, habitat, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

# plot
nb_obs_habitat_plot <- ggplot(nb_obs_esp_habitat_dt, aes(habitat, nb_obs_esp_par_piege_par_jour)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(width = 0.2, height = 0.2, size = 1, fill = "white", shape = 21) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1, color="red", fill="red") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1, color="red", fill="red") +
  theme_classic() +
  facet_wrap(~ espece, ncol = 5) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Habitat", y = "Nombre d'observation /piège/jour"); nb_obs_habitat_plot
```

Modèles pour chaque espèce séparemment :

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt[nb_obs_esp_habitat_dt$espece=="Belette d'Europe",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Belette d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt[nb_obs_esp_habitat_dt$espece=="Blaireau européen",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Blaireau européen)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt[nb_obs_esp_habitat_dt$espece=="Fouine",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Fouine)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt[nb_obs_esp_habitat_dt$espece=="Fouine/Martre",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Fouine/Martre)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt[nb_obs_esp_habitat_dt$espece=="Genette commune",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Genette commune)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt[nb_obs_esp_habitat_dt$espece=="Loutre d’Europe",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Loutre d’Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt[nb_obs_esp_habitat_dt$espece=="Martre des Pins",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Martre des Pins)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt[nb_obs_esp_habitat_dt$espece=="Putois d'Europe",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Putois d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt[nb_obs_esp_habitat_dt$espece=="Raton laveur",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Raton laveur)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt[nb_obs_esp_habitat_dt$espece=="Renard roux",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Renard roux)")
```



NEWNEWNEWNEW

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=8, fig.height=5}
# data
nb_obs_esp_habitat_dt <- nb_obs_esp_dt %>% 
  select(espece, ID_unique, habitat, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

nb_obs_esp_habitat_dt_new <- nb_obs_esp_habitat_dt[nb_obs_esp_habitat_dt$habitat!="Berge sous pont" &
                                                     nb_obs_esp_habitat_dt$habitat!="Absence de végétation",]

# plot
nb_obs_habitat_plot <- ggplot(nb_obs_esp_habitat_dt_new, aes(habitat, nb_obs_esp_par_piege_par_jour)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(width = 0.2, height = 0.2, size = 1, fill = "white", shape = 21) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=0.5, color="red", fill="red") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1, color="red", fill="red") +
  theme_classic() +
  facet_wrap(~ espece, ncol = 5) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Habitat", y = "Nombre d'observation /piège/jour"); nb_obs_habitat_plot
```

NEWNEWNEWNEW 

Modèles pour chaque espèce séparemment :

Pour la Genette commune : plus d'obs en "Ripisylves" qu'en "fourrés"

Pour la Loutre d’Europe : plus d'obs en "Roselières" qu'en "fourrés"

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt_new[nb_obs_esp_habitat_dt_new$espece=="Belette d'Europe",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Belette d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt_new[nb_obs_esp_habitat_dt_new$espece=="Blaireau européen",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Blaireau européen)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt_new[nb_obs_esp_habitat_dt_new$espece=="Fouine",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Fouine)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt_new[nb_obs_esp_habitat_dt_new$espece=="Fouine/Martre",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Fouine/Martre)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt_new[nb_obs_esp_habitat_dt_new$espece=="Genette commune",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Genette commune)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt_new[nb_obs_esp_habitat_dt_new$espece=="Loutre d’Europe",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Loutre d’Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt_new[nb_obs_esp_habitat_dt_new$espece=="Martre des Pins",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Martre des Pins)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt_new[nb_obs_esp_habitat_dt_new$espece=="Putois d'Europe",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Putois d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt_new[nb_obs_esp_habitat_dt_new$espece=="Raton laveur",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Raton laveur)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_esp_habitat_dt_new[nb_obs_esp_habitat_dt_new$espece=="Renard roux",],
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Renard roux)")
```



## ~ distance à l'eau 

### global

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
nb_obs_distance_eau_dt <- nb_obs_dt %>% 
  select(ID_unique, distance_eau, nb_obs_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

nb_obs_moy_distance_eau_plot2 <- ggplot(nb_obs_distance_eau_dt, aes(distance_eau, nb_obs_par_piege_par_jour)) +
  geom_point(shape = 21, fill = "grey", size = 4) +
  geom_smooth(method = lm, linetype = "dotted") +
  ylab("Nombre d'observation /piège/jour") + xlab("Distance à l'eau") +
  theme_classic(); nb_obs_moy_distance_eau_plot2

tab_model(lm(nb_obs_par_piege_par_jour ~ distance_eau, data = nb_obs_distance_eau_dt), 
          lm(nb_obs_par_piege_par_jour ~ distance_eau + I(distance_eau^2), data = nb_obs_distance_eau_dt),
          title = "Nombre d'observation /piège/jour en fonction de la distance à l'eau")
```

### par espèce

Seulement les espèces d'intérêt (liste 3).

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=6}
nb_obs_esp_distance_eau_dt <- nb_obs_esp_dt %>% 
  select(espece, ID_unique, distance_eau, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

nb_obs_esp_distance_eau_dt$sign <- "non"

nb_obs_esp_distance_eau_dt$sign[nb_obs_esp_distance_eau_dt$espece=="Blaireau européen"|
                                  nb_obs_esp_distance_eau_dt$espece=="Fouine"|
                                  nb_obs_esp_distance_eau_dt$espece=="Renard roux"] <- "oui"

nb_obs_esp_moy_distance_eau_plot <- ggplot(data = nb_obs_esp_distance_eau_dt,
             aes(distance_eau, nb_obs_esp_par_piege_par_jour, linetype = sign)) +
  geom_point(size = 4, shape = 21, fill = "grey") +
  geom_smooth(method = lm) +
  scale_linetype_manual(values = c("dotted", "solid")) +
  facet_wrap(~ espece, ncol = 5) +
  ylab("Nombre d'observation /piège/jour") + xlab("Distance à l'eau") +
  theme_classic() ; nb_obs_esp_moy_distance_eau_plot
```

Modèles pour chaque espèce séparemment :

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ distance_eau, 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Belette d'Europe",]),
          lm(nb_obs_esp_par_piege_par_jour ~ distance_eau + I(distance_eau^2), 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Belette d'Europe",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Belette d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ distance_eau, 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Blaireau européen",]),
          lm(nb_obs_esp_par_piege_par_jour ~ distance_eau + I(distance_eau^2), 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Blaireau européen",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Blaireau européen)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ distance_eau, 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Fouine",]),
          lm(nb_obs_esp_par_piege_par_jour ~ distance_eau + I(distance_eau^2), 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Fouine",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Fouine)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ distance_eau, 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Fouine/Martre",]),
          lm(nb_obs_esp_par_piege_par_jour ~ distance_eau + I(distance_eau^2), 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Fouine/Martre",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Fouine/Martre)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ distance_eau, 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Genette commune",]),
          lm(nb_obs_esp_par_piege_par_jour ~ distance_eau + I(distance_eau^2), 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Genette commune",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Genette commune)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ distance_eau, 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Loutre d’Europe",]),
          lm(nb_obs_esp_par_piege_par_jour ~ distance_eau + I(distance_eau^2), 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Loutre d’Europe",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Loutre d’Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ distance_eau, 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Martre des Pins",]),
          lm(nb_obs_esp_par_piege_par_jour ~ distance_eau + I(distance_eau^2), 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Martre des Pins",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Martre des Pins)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ distance_eau, 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Putois d'Europe",]),
          lm(nb_obs_esp_par_piege_par_jour ~ distance_eau + I(distance_eau^2), 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Putois d'Europe",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Putois d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ distance_eau, 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Raton laveur",]),
          lm(nb_obs_esp_par_piege_par_jour ~ distance_eau + I(distance_eau^2), 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Raton laveur",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Raton laveur)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ distance_eau, 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Renard roux",]),
          lm(nb_obs_esp_par_piege_par_jour ~ distance_eau + I(distance_eau^2), 
             data = nb_obs_esp_distance_eau_dt[nb_obs_esp_distance_eau_dt$espece=="Renard roux",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Renard roux)")
```

## ~ semaine de pose 

### global

Nombre d'observation /piège/jour d'observation en fonction de la semaine de pose du piège photo.

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
nb_obs_dt <- nb_obs_dt %>% 
   mutate(week = week(date_pose))

nb_obs_week_dt <- nb_obs_dt %>% 
  select(ID_unique, week, nb_obs_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

nb_obs_moy_week_plot2 <- ggplot(nb_obs_week_dt, aes(week, nb_obs_par_piege_par_jour)) +
  geom_point(shape = 21, fill = "grey", size = 4) +
  geom_smooth(method = lm, linetype = "dotted") +
  ylab("Nombre d'observation /piège/jour") + xlab("Semaine") +
  theme_classic(); nb_obs_moy_week_plot2

tab_model(lm(nb_obs_par_piege_par_jour ~ week, data = nb_obs_week_dt), 
          lm(nb_obs_par_piege_par_jour ~ week + I(week^2), data = nb_obs_week_dt),
          title = "Nombre d'observation /piège/jour en fonction de la semaine de l'année")
```

### par espèce

Seulement les espèces d'intérêt (liste 3).

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}
nb_obs_esp_dt <- nb_obs_esp_dt %>% 
   mutate(week = week(date_pose))

nb_obs_esp_week_dt <- nb_obs_esp_dt %>% 
  select(espece, ID_unique, week, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

nb_obs_esp_moy_week_plot <- ggplot(data = nb_obs_esp_week_dt,
             aes(week, nb_obs_esp_par_piege_par_jour)) +
  geom_point(size = 4, shape = 21, fill = "grey") +
  geom_smooth(method = lm, linetype = "dotted") +
  facet_wrap(~ espece, ncol = 5) +
  ylab("Nombre d'observation /piège/jour") + xlab("Semaine de pose") +
  theme_classic() ; nb_obs_esp_moy_week_plot
```

Modèles pour chaque espèce séparemment :

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=7}

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ week,
             data = nb_obs_esp_week_dt[nb_obs_esp_week_dt$espece=="Belette d'Europe",]),
          title = "Nombre d'observation/piège/jour en fonction de la hauteur de la semaine de l'année (Belette d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ week, 
             data = nb_obs_esp_week_dt[nb_obs_esp_week_dt$espece=="Blaireau européen",]),
          title = "Nombre d'observation/piège/jour en fonction de la hauteur de la semaine de l'année (Blaireau européen)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ week, 
             data = nb_obs_esp_week_dt[nb_obs_esp_week_dt$espece=="Fouine",]),
          title = "Nombre d'observation/piège/jour en fonction de la hauteur de la semaine de l'année (Fouine)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ week, 
             data = nb_obs_esp_week_dt[nb_obs_esp_week_dt$espece=="Fouine/Martre",]),
          title = "Nombre d'observation/piège/jour en fonction de la hauteur de la semaine de l'année (Fouine/Martre)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ week, 
             data = nb_obs_esp_week_dt[nb_obs_esp_week_dt$espece=="Genette commune",]),
          title = "Nombre d'observation/piège/jour en fonction de la hauteur de la semaine de l'année (Genette commune)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ week, 
             data = nb_obs_esp_week_dt[nb_obs_esp_week_dt$espece=="Loutre d’Europe",]),
          title = "Nombre d'observation/piège/jour en fonction de la hauteur de la semaine de l'année (Loutre d’Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ week, 
             data = nb_obs_esp_week_dt[nb_obs_esp_week_dt$espece=="Martre des Pins",]),
          title = "Nombre d'observation/piège/jour en fonction de la hauteur de la semaine de l'année (Martre des Pins)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ week, 
             data = nb_obs_esp_week_dt[nb_obs_esp_week_dt$espece=="Putois d'Europe",]),
          title = "Nombre d'observation/piège/jour en fonction de la hauteur de la semaine de l'année (Putois d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ week, 
             data = nb_obs_esp_week_dt[nb_obs_esp_week_dt$espece=="Raton laveur",]),
          title = "Nombre d'observation/piège/jour en fonction de la hauteur de la semaine de l'année (Raton laveur)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ week, 
             data = nb_obs_esp_week_dt[nb_obs_esp_week_dt$espece=="Renard roux",]),
          title = "Nombre d'observation/piège/jour en fonction de la hauteur de la semaine de l'année (Renard roux)")
```

## ~ DAC interaction 

Seulement les espèces d'intérêt (liste 3).

### global

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# data
nb_obs_esp_DAC_dt <- nb_obs_esp_dt %>% 
  select(ID_unique, DAC_interaction, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

# plot
nb_obs_DAC_plot2 <- ggplot(nb_obs_esp_DAC_dt, aes(DAC_interaction, nb_obs_esp_par_piege_par_jour)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(width = 0.2, height = 0.2, size = 1, fill = "white", shape = 21) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1.5, color="red", fill="red") +
  geom_signif(comparisons = list(c("oui", "non")),
              map_signif_level=TRUE,
              y_position = 3, color = "black",
              test = "t.test") +
  ylim(-0.3, 3.3) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Intéraction avec le DAC", y = "Nombre d'observation /piège/jour"); nb_obs_DAC_plot2

# model
tab_model(lm(nb_obs_esp_par_piege_par_jour ~ DAC_interaction, data = nb_obs_esp_DAC_dt), 
          title = "Nombre d'observation /piège/jour en fonction d'une intéraction avec le DAC")
```

### par espèce

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}
# data
nb_obs_esp_DAC_dt <- nb_obs_esp_dt %>% 
  select(ID_unique, DAC_interaction, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

# plot
nb_obs_DAC_plot2 <- ggplot(nb_obs_esp_DAC_dt, aes(DAC_interaction, nb_obs_esp_par_piege_par_jour)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(width = 0.2, height = 0.2, size = 1, fill = "white", shape = 21) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1.5, color="red", fill="red") +
  geom_signif(comparisons = list(c("oui", "non")),
              map_signif_level=TRUE,
              y_position = 3, color = "black",
              test = "t.test") +
  facet_wrap(~ espece, ncol = 5) +
  ylim(-0.3, 3.3) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Intéraction avec le DAC", y = "Nombre d'observation /piège/jour"); nb_obs_DAC_plot2
```

## ~ coulée 

Seulement pour les espèces de la liste 3.

### global

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# data
nb_obs_esp_coulee_dt <- nb_obs_esp_dt %>% 
  select(espece, ID_unique, coulee, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

# plot
nb_obs_moy_coulee_plot <- ggplot(data = nb_obs_esp_coulee_dt, aes(x = coulee, y=nb_obs_esp_par_piege_par_jour)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(shape = 21, color= "black", fill = "white", width = 0.3, height = 0.1) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red", aes(width=5)) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1.5, color="red", fill="red", size = 2) +
  geom_signif(data = nb_obs_esp_dt, aes(x=coulee, y=nb_obs_esp_par_piege_par_jour),
              comparisons = list(c("oui", "non")),
              map_signif_level=TRUE,
              y_position = 2.8, color = "black",
              test = "t.test") +
  theme_classic() +
  labs(title="Nombre d'observation /piège/jour 
en fonction de la présence d'une coulée 
(espèces liste 3 seulement)",
        x ="Coulée", y = "Nombre d'observation 
par piège par jour d'observation", fill=""); nb_obs_moy_coulee_plot

# model
tab_model(lm(nb_obs_esp_par_piege_par_jour ~ coulee, 
             data = nb_obs_esp_coulee_dt),
             title = "Nombre d'observation /piège/jour en fonction de la présence d'une coulée (espèces liste 3 seulement)")
```

### par espèce

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}
# data
nb_obs_esp_coulee_dt <- nb_obs_esp_dt %>% 
  select(espece, ID_unique, coulee, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

nb_obs_esp_moy_coulee_plot <- ggplot(data = nb_obs_esp_coulee_dt, aes(coulee, nb_obs_esp_par_piege_par_jour)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(width = 0.2, height = 0.2,
             color = "black", fill = "white", shape = 21, size = 1) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1.5, color="red", fill="red", size = 2) +
  geom_signif(comparisons = list(c("oui", "non")),
              map_signif_level=TRUE,
              y_position = 2.6, color = "black",
              test = "t.test") +
  facet_wrap(~ espece, ncol = 5) +
  ylab("Nombre d'observation /piège/jour") + xlab("Coulée à proximité") +
  theme_classic() +
  ylim(-0.3, 3) ; nb_obs_esp_moy_coulee_plot
```

Modèles pour chaque espéce séparemment :

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=7}
tab_model(lm(nb_obs_esp_par_piege_par_jour ~ coulee, 
             data = nb_obs_esp_coulee_dt[nb_obs_esp_coulee_dt$espece=="Belette d'Europe",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Belette d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ coulee, 
             data = nb_obs_esp_coulee_dt[nb_obs_esp_coulee_dt$espece=="Blaireau européen",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Blaireau européen)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ coulee, 
             data = nb_obs_esp_coulee_dt[nb_obs_esp_coulee_dt$espece=="Fouine",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Fouine)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ coulee, 
             data = nb_obs_esp_coulee_dt[nb_obs_esp_coulee_dt$espece=="Fouine/Martre",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Fouine/Martre)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ coulee, 
             data = nb_obs_esp_coulee_dt[nb_obs_esp_coulee_dt$espece=="Genette commune",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Genette commune)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ coulee, 
             data = nb_obs_esp_coulee_dt[nb_obs_esp_coulee_dt$espece=="Loutre d’Europe",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Loutre d’Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ coulee, 
             data = nb_obs_esp_coulee_dt[nb_obs_esp_coulee_dt$espece=="Martre des Pins",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Martre des Pins)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ coulee, 
             data = nb_obs_esp_coulee_dt[nb_obs_esp_coulee_dt$espece=="Putois d'Europe",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Putois d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ coulee, 
             data = nb_obs_esp_coulee_dt[nb_obs_esp_coulee_dt$espece=="Raton laveur",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Raton laveur)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ coulee, 
             data = nb_obs_esp_coulee_dt[nb_obs_esp_coulee_dt$espece=="Renard roux",]),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Renard roux)")
```

## ~ heure 

Seulement pour les espèces de la liste 3.

### global

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
nb_obs_esp_hour_obs_dt <- nb_obs_esp_dt %>% 
  select(espece, ID_unique, hour_obs, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

# plot
nb_obs_moy_heure_plot <- ggplot(data = nb_obs_esp_hour_obs_dt, aes(x = hour_obs, y=nb_obs_esp_par_piege_par_jour)) +
  # geom_smooth(method = lm, formula = y ~ x + I(x^2), linetype = "dotted") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=21, size=1, color="black", fill="red") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=.5, color="red", fill="red") +
  geom_jitter(shape = 21, fill = "grey", size = 1, width = 0.1, height = 0.1) +
  theme_classic() +
  labs(title="Nombre d'observation /piège/jour 
en fonction de l'heure
(espèces liste 3 seulement)",
        x ="Heure", y = "Nombre d'observation 
par piège par jour d'observation", fill=""); nb_obs_moy_heure_plot

# model
tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hour_obs, data = nb_obs_esp_hour_obs_dt),
          lm(nb_obs_esp_par_piege_par_jour ~ hour_obs + I(hour_obs^2), data = nb_obs_esp_hour_obs_dt),
             title = "Nombre d'observation /piège/jour en fonction de l'heure (espèces liste 3 seulement)")
```

Test de comparaison de moyenne entre le nombre d'observation /piège/jour la journée (entre 8h et 17h) et la nuit (avant 7h, après 18h) :

Différence significative entre le jour et la nuit.

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
aa_nuit <- nb_obs_esp_hour_obs_dt[nb_obs_esp_hour_obs_dt$hour_obs<=7 | nb_obs_esp_hour_obs_dt$hour_obs>=18,]
aa_jour <- nb_obs_esp_hour_obs_dt[nb_obs_esp_hour_obs_dt$hour_obs>=8 & nb_obs_esp_hour_obs_dt$hour_obs<=17,]

t.test(aa_nuit$nb_obs_esp_par_piege_par_jour, aa_jour$nb_obs_esp_par_piege_par_jour)
```

### par espèce

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=12, fig.height=8}
nb_obs_esp_hour_obs_dt <- nb_obs_esp_dt %>% 
  select(espece, ID_unique, hour_obs, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

nb_obs_esp_moy_hour_obs_plot2 <- ggplot(data = nb_obs_esp_hour_obs_dt, aes(x = hour_obs, y=nb_obs_esp_par_piege_par_jour)) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=21, size=1, color="black", fill="red") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=.5, color="red", fill="red") +
  geom_jitter(shape = 21, fill = "grey", size = 1, width = 0.2, height = 0.2) +
  theme_classic() +
  facet_wrap(~ espece, ncol = 5) +
  labs(title="Nombre d'observation /piège/jour 
en fonction de l'heure
(espèces liste 3 seulement)",
        x ="Heure", y = "Nombre d'observation 
par piège par jour d'observation", fill=""); nb_obs_esp_moy_hour_obs_plot2
```

NEWNEWNEWNEWNEW

Ici c'est bien juste la somme des détections pour chaque espèce et par heure, tout simplement.

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=12, fig.height=8}
dt_heure_new <- data_4_list_3 %>%
  group_by(espece, hour_obs) %>% 
  mutate(Activity = sum(nb_detection)) %>% 
  select(espece,Activity,hour_obs) %>% 
  distinct() %>% 
  na.omit()

# Click table
dt_heure_new %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))



nb_obs_esp_moy_hour_obs_plot2_new <- ggplot(data = dt_heure_new, aes(x = hour_obs, y = Activity), 
                                            colour = as.numeric(Activity), fill = as.numeric(Activity)) +
  geom_segment(aes(x=hour_obs, xend=hour_obs, 
                   y=0, yend=Activity, colour=Activity),
               size = 2) +
  geom_point(shape = 21, size = 2, width = 0.2, height = 0.2, aes(fill = Activity)) +
  scale_color_gradient2(midpoint = 45, low = "#147bd1", mid = "#D9C756", high = "#E35205") +
  scale_fill_gradient2(midpoint = 45, low = "#147bd1", mid = "#D9C756", high = "#E35205") +
  theme_classic() +
  facet_wrap(~ espece, ncol = 5) +
  labs(title="Nombre d'observation en fonction de l'heure",
        x ="Heure", y = "Nombre d'observation", fill="Nb obs", color = "Nb obs"); nb_obs_esp_moy_hour_obs_plot2_new
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=7}
# tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hour_obs + I(hour_obs^2), 
#              data = nb_obs_esp_dt[nb_obs_esp_dt$espece=="Belette d'Europe",]),
#           title = "Nombre d'observation moyen 
#           par piège par jour en fonction de la hauteur d'installation
#           (Belette d'Europe)")
# 
# tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hour_obs + I(hour_obs^2), 
#              data = nb_obs_esp_dt[nb_obs_esp_dt$espece=="Blaireau européen",]),
#           title = "Nombre d'observation moyen 
#           par piège par jour en fonction de la hauteur d'installation
#           (Blaireau européen)")
# 
# tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hour_obs + I(hour_obs^2), 
#              data = nb_obs_esp_dt[nb_obs_esp_dt$espece=="Fouine",]),
#           title = "Nombre d'observation moyen 
#           par piège par jour en fonction de la hauteur d'installation
#           (Fouine)")
# 
# tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hour_obs + I(hour_obs^2), 
#              data = nb_obs_esp_dt[nb_obs_esp_dt$espece=="Fouine/Martre",]),
#           title = "Nombre d'observation moyen 
#           par piège par jour en fonction de la hauteur d'installation
#           (Fouine/Martre)")
# 
# tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hour_obs + I(hour_obs^2), 
#              data = nb_obs_esp_dt[nb_obs_esp_dt$espece=="Genette commune",]),
#           title = "Nombre d'observation moyen 
#           par piège par jour en fonction de la hauteur d'installation
#           (Genette commune)")
# 
# tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hour_obs + I(hour_obs^2), 
#              data = nb_obs_esp_dt[nb_obs_esp_dt$espece=="Loutre d’Europe",]),
#           title = "Nombre d'observation moyen 
#           par piège par jour en fonction de la hauteur d'installation
#           (Loutre d’Europe)")
# 
# tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hour_obs + I(hour_obs^2), 
#              data = nb_obs_esp_dt[nb_obs_esp_dt$espece=="Martre des Pins",]),
#           title = "Nombre d'observation moyen 
#           par piège par jour en fonction de la hauteur d'installation
#           (Martre des Pins)")
# 
# tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hour_obs + I(hour_obs^2), 
#              data = nb_obs_esp_dt[nb_obs_esp_dt$espece=="Putois d'Europe",]),
#           title = "Nombre d'observation moyen 
#           par piège par jour en fonction de la hauteur d'installation
#           (Putois d'Europe)")
# 
# tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hour_obs + I(hour_obs^2), 
#              data = nb_obs_esp_dt[nb_obs_esp_dt$espece=="Raton laveur",]),
#           title = "Nombre d'observation moyen 
#           par piège par jour en fonction de la hauteur d'installation
#           (Raton laveur)")
# 
# tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hour_obs + I(hour_obs^2), 
#              data = nb_obs_esp_dt[nb_obs_esp_dt$espece=="Renard roux",]),
#           title = "Nombre d'observation moyen 
#           par piège par jour en fonction de la hauteur d'installation
#           (Renard roux)")
```


## ~ temperature 

Seulement pour les espèces de la liste 3.

### global

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
nb_obs_esp_temp_dt <- nb_obs_esp_dt %>% 
  select(espece, ID_unique, temp, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

nb_obs_moy_temp_plot <- ggplot(nb_obs_esp_temp_dt, 
                               aes(temp, nb_obs_esp_par_piege_par_jour)) +
  geom_jitter(width = 0.2, height = 0.2, shape = 21, fill = "grey", color = "black") +
  geom_smooth(method = lm, formula = y ~ x + I(x^2)) +
  ylab("Nombre d'observation moyen 
par piège par jour d'observation 
(seulement espèces liste 3)") + xlab("Température") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)); nb_obs_moy_temp_plot

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ temp, 
             data = nb_obs_esp_temp_dt),
          lm(nb_obs_esp_par_piege_par_jour ~ temp + I(temp^2), 
             data = nb_obs_esp_temp_dt),
             title = "Nombre d'observation /piège/jour en fonction de la distance à l'eau")
```

### par espèce

Seulement les espèces d'intérêt (liste 3).

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=5}
nb_obs_esp_temp_dt <- nb_obs_esp_dt %>% 
  select(espece, ID_unique, temp, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

nb_obs_esp_temp_dt$sign_temp <- "non"
nb_obs_esp_temp_dt$sign_temp[nb_obs_esp_temp_dt$espece=="Belette d'Europe" |
                        nb_obs_esp_temp_dt$espece=="Fouine" |
                        nb_obs_esp_temp_dt$espece=="Loutre d’Europe" |
                        nb_obs_esp_temp_dt$espece=="Renard roux"] <- "oui"

nb_obs_moy_temp_esp_plot <- ggplot(nb_obs_esp_temp_dt, 
                               aes(temp, nb_obs_esp_par_piege_par_jour, linetype = sign_temp)) +
  geom_jitter(width = 0.2, height = 0.2, shape = 21, fill = "grey", color = "black") +
  geom_smooth(method = lm) +
  scale_linetype_manual(values = c("dotted", "solid")) +
  facet_wrap(~ espece, ncol = 5) +
  ylab("Nombre d'observation /piège/jour 
(seulement espèces liste 3") + xlab("Température") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)); nb_obs_moy_temp_esp_plot
```

Modèle pour chaque espèce séparemment :

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}
tab_model(lm(nb_obs_esp_par_piege_par_jour ~ temp, 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Belette d'Europe",]),
          lm(nb_obs_esp_par_piege_par_jour ~ temp + I(temp^2), 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Belette d'Europe",]),
          title = "Nombre d'observation /piège/jour en fonction de la température (Belette d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ temp, 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Blaireau européen",]),
          lm(nb_obs_esp_par_piege_par_jour ~ temp + I(temp^2), 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Blaireau européen",]),
          title = "Nombre d'observation /piège/jour en fonction de la température (Blaireau européen)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ temp, 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Fouine",]),
          lm(nb_obs_esp_par_piege_par_jour ~ temp + I(temp^2), 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Fouine",]),
          title = "Nombre d'observation /piège/jour en fonction de la température (Fouine)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ temp, 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Fouine/Martre",]),
          lm(nb_obs_esp_par_piege_par_jour ~ temp + I(temp^2), 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Fouine/Martre",]),
          title = "Nombre d'observation /piège/jour en fonction de la température (Fouine/Martre)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ temp, 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Genette commune",]),
          lm(nb_obs_esp_par_piege_par_jour ~ temp + I(temp^2), 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Genette commune",]),
          title = "Nombre d'observation /piège/jour en fonction de la température (Genette commune)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ temp, 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Loutre d’Europe",]),
          lm(nb_obs_esp_par_piege_par_jour ~ temp + I(temp^2), 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Loutre d’Europe",]),
          title = "Nombre d'observation /piège/jour en fonction de la température (Loutre d’Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ temp, 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Martre des Pins",]),
          lm(nb_obs_esp_par_piege_par_jour ~ temp + I(temp^2), 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Martre des Pins",]),
          title = "Nombre d'observation /piège/jour en fonction de la température (Martre des Pins)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ temp, 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Putois d'Europe",]),
          lm(nb_obs_esp_par_piege_par_jour ~ temp + I(temp^2), 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Putois d'Europe",]),
          title = "Nombre d'observation /piège/jour en fonction de la température (Putois d'Europe)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ temp, 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Raton laveur",]),
          lm(nb_obs_esp_par_piege_par_jour ~ temp + I(temp^2), 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Raton laveur",]),
          title = "Nombre d'observation /piège/jour en fonction de la température (Raton laveur)")

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ temp, 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Renard roux",]),
          lm(nb_obs_esp_par_piege_par_jour ~ temp + I(temp^2), 
             data = nb_obs_esp_temp_dt[nb_obs_esp_temp_dt$espece=="Renard roux",]),
          title = "Nombre d'observation /piège/jour en fonction de la température (Renard roux)")
```

## ~ all covariables 

### global 

#### modelès

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=6, fig.height=6}
nb_obs_dregde_dt <- nb_obs_dt %>% 
  select(nb_obs_par_piege_par_jour, hauteur, support, habitat, distance_eau, week, DAC_interaction) %>% 
  na.omit()

nb_obs_dregde_dt <- nb_obs_dregde_dt[,c(2:7)]

options(na.action = "na.fail")
nb_obs.fullmodel <- lm(nb_obs_par_piege_par_jour ~., data = nb_obs_dregde_dt)
nb_obs.dredge <- dredge(nb_obs.fullmodel, rank = "AIC")
nb_obs.dredge
```

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=6, fig.height=6}
print("Liste des meilleures modèles")
list_best_model <- nb_obs.dredge[nb_obs.dredge$delta<2] ; list_best_model
```

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=6, fig.height=6}
print("Le plus simple des meilleurs modèles")
best_model <- list_best_model[list_best_model$df==min(list_best_model$df)] ; best_model
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE, fig.width=3.5, fig.height=3.5}
#### prédictions 

model_pred <- lm(nb_obs_par_piege_par_jour ~ distance_eau + habitat + hauteur + support + week, 
                 data = nb_obs_dt) 

nb_obs_pred_plot <- ggplot(nb_obs_dregde_dt, aes(predict(model_pred), nb_obs_par_piege_par_jour)) +
  geom_jitter(alpha = 0.2) +
  geom_smooth(method = lm, color = "green") +
  geom_abline(intercept = 0, slope = 1, color = "blue") +
  theme_classic(); nb_obs_pred_plot
```

#### en résumé

Pour maximiser le nombre d'observation /piège/jour d'observation il faut : 1) être proche de l'eau, 2) éviter les habitats herbacés, berge sous pont et abscence de végétation, 3) privilégier les support "arbre", et 4) poser les pièges photo plutôt fin novembre / début décembre.  

### par espèce 

#### modèles

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=6, fig.height=6}
# table(nb_obs_esp_dt$espece)

# Belette d'Europe
nb_obs_esp_dregde_BEL_dt <- nb_obs_esp_dt[nb_obs_esp_dt$espece=="Belette d'Europe",] %>% 
  select(nb_obs_esp_par_piege_par_jour, 
         hauteur, support, habitat, 
         distance_eau, week, DAC_interaction) %>% 
  na.omit()

nb_obs_esp_dregde_BEL_dt <- nb_obs_esp_dregde_BEL_dt[,c(3:7)]
options(na.action = "na.fail")
nb_obs.fullmodel <- lm(nb_obs_esp_par_piege_par_jour ~., data = nb_obs_esp_dregde_BEL_dt)
nb_obs.dredge <- dredge(nb_obs.fullmodel, rank = "AIC")
print("Belette d'Europe")
print("Le plus simple des meilleurs modèles")
list_best_model <- nb_obs.dredge[nb_obs.dredge$delta<2]
best_model <- list_best_model[list_best_model$df==min(list_best_model$df)] ; best_model

# Blaireau européen
nb_obs_esp_dregde_BLA_dt <- nb_obs_esp_dt[nb_obs_esp_dt$espece=="Blaireau européen",] %>% 
  select(nb_obs_esp_par_piege_par_jour, 
         hauteur, support, habitat, 
         distance_eau, week, DAC_interaction) %>% 
  na.omit()

nb_obs_esp_dregde_BLA_dt <- nb_obs_esp_dregde_BLA_dt[,c(3:7)]
options(na.action = "na.fail")
nb_obs.fullmodel <- lm(nb_obs_esp_par_piege_par_jour ~., data = nb_obs_esp_dregde_BLA_dt)
nb_obs.dredge <- dredge(nb_obs.fullmodel, rank = "AIC")
print("Blaireau européen")
print("Le plus simple des meilleurs modèles")
list_best_model <- nb_obs.dredge[nb_obs.dredge$delta<2]
best_model <- list_best_model[list_best_model$df==min(list_best_model$df)] ; best_model

# Fouine
nb_obs_esp_dregde_FOU_dt <- nb_obs_esp_dt[nb_obs_esp_dt$espece=="Fouine",] %>% 
  select(nb_obs_esp_par_piege_par_jour, 
         hauteur, support, habitat, 
         distance_eau, week, DAC_interaction) %>% 
  na.omit()

nb_obs_esp_dregde_FOU_dt <- nb_obs_esp_dregde_FOU_dt[,c(3:7)]
options(na.action = "na.fail")
nb_obs.fullmodel <- lm(nb_obs_esp_par_piege_par_jour ~., data = nb_obs_esp_dregde_FOU_dt)
nb_obs.dredge <- dredge(nb_obs.fullmodel, rank = "AIC")
print("Fouine")
print("Le plus simple des meilleurs modèles")
list_best_model <- nb_obs.dredge[nb_obs.dredge$delta<2]
best_model <- list_best_model[list_best_model$df==min(list_best_model$df)] ; best_model

# Genette commune
nb_obs_esp_dregde_GEN_dt <- nb_obs_esp_dt[nb_obs_esp_dt$espece=="Genette commune",] %>% 
  select(nb_obs_esp_par_piege_par_jour, 
         hauteur, support, habitat, 
         distance_eau, week, DAC_interaction) %>% 
  na.omit()

nb_obs_esp_dregde_GEN_dt <- nb_obs_esp_dregde_GEN_dt[,c(3:7)]
options(na.action = "na.fail")
nb_obs.fullmodel <- lm(nb_obs_esp_par_piege_par_jour ~., data = nb_obs_esp_dregde_GEN_dt)
nb_obs.dredge <- dredge(nb_obs.fullmodel, rank = "AIC")
print("Genette commune")
print("Le plus simple des meilleurs modèles")
list_best_model <- nb_obs.dredge[nb_obs.dredge$delta<2]
best_model <- list_best_model[list_best_model$df==min(list_best_model$df)] ; best_model

# Loutre d’Europe
nb_obs_esp_dregde_LOU_dt <- nb_obs_esp_dt[nb_obs_esp_dt$espece=="Loutre d’Europe",] %>% 
  select(nb_obs_esp_par_piege_par_jour, 
         hauteur, support, habitat, 
         distance_eau, week, DAC_interaction) %>% 
  na.omit()

nb_obs_esp_dregde_LOU_dt <- nb_obs_esp_dregde_LOU_dt[,c(3:7)]
options(na.action = "na.fail")
nb_obs.fullmodel <- lm(nb_obs_esp_par_piege_par_jour ~., data = nb_obs_esp_dregde_LOU_dt)
nb_obs.dredge <- dredge(nb_obs.fullmodel, rank = "AIC")
print("Loutre d’Europe")
print("Le plus simple des meilleurs modèles")
list_best_model <- nb_obs.dredge[nb_obs.dredge$delta<2]
best_model <- list_best_model[list_best_model$df==min(list_best_model$df)] ; best_model

# Martre des Pins
nb_obs_esp_dregde_MAR_dt <- nb_obs_esp_dt[nb_obs_esp_dt$espece=="Martre des Pins",] %>% 
  select(nb_obs_esp_par_piege_par_jour, 
         hauteur, support, habitat, 
         distance_eau, week, DAC_interaction) %>% 
  na.omit()

nb_obs_esp_dregde_MAR_dt <- nb_obs_esp_dregde_MAR_dt[,c(3:7)]
options(na.action = "na.fail")
nb_obs.fullmodel <- lm(nb_obs_esp_par_piege_par_jour ~., data = nb_obs_esp_dregde_MAR_dt)
nb_obs.dredge <- dredge(nb_obs.fullmodel, rank = "AIC")
print("Martre des Pins")
print("Le plus simple des meilleurs modèles")
list_best_model <- nb_obs.dredge[nb_obs.dredge$delta<2]
best_model <- list_best_model[list_best_model$df==min(list_best_model$df)] ; best_model

# Putois d'Europe
nb_obs_esp_dregde_PUT_dt <- nb_obs_esp_dt[nb_obs_esp_dt$espece=="Putois d'Europe",] %>% 
  select(nb_obs_esp_par_piege_par_jour, 
         hauteur, support, habitat, 
         distance_eau, week, DAC_interaction) %>% 
  na.omit()

nb_obs_esp_dregde_PUT_dt <- nb_obs_esp_dregde_PUT_dt[,c(3:7)]
options(na.action = "na.fail")
nb_obs.fullmodel <- lm(nb_obs_esp_par_piege_par_jour ~., data = nb_obs_esp_dregde_PUT_dt)
nb_obs.dredge <- dredge(nb_obs.fullmodel, rank = "AIC")
print("Putois d'Europe")
print("Le plus simple des meilleurs modèles")
list_best_model <- nb_obs.dredge[nb_obs.dredge$delta<2]
best_model <- list_best_model[list_best_model$df==min(list_best_model$df)] ; best_model

# Raton laveur
nb_obs_esp_dregde_RAT_dt <- nb_obs_esp_dt[nb_obs_esp_dt$espece=="Raton laveur",] %>% 
  select(nb_obs_esp_par_piege_par_jour, 
         hauteur, support, habitat, 
         distance_eau, week, DAC_interaction) %>% 
  na.omit()

nb_obs_esp_dregde_RAT_dt <- nb_obs_esp_dregde_RAT_dt[,c(3:7)]
options(na.action = "na.fail")
nb_obs.fullmodel <- lm(nb_obs_esp_par_piege_par_jour ~., data = nb_obs_esp_dregde_RAT_dt)
nb_obs.dredge <- dredge(nb_obs.fullmodel, rank = "AIC")
print("Raton laveur")
print("Le plus simple des meilleurs modèles")
list_best_model <- nb_obs.dredge[nb_obs.dredge$delta<2]
best_model <- list_best_model[list_best_model$df==min(list_best_model$df)] ; best_model

# Renard roux
nb_obs_esp_dregde_REN_dt <- nb_obs_esp_dt[nb_obs_esp_dt$espece=="Renard roux",] %>% 
  select(nb_obs_esp_par_piege_par_jour, 
         hauteur, support, habitat, 
         distance_eau, week, DAC_interaction) %>% 
  na.omit()

nb_obs_esp_dregde_REN_dt <- nb_obs_esp_dregde_REN_dt[,c(3:7)]
options(na.action = "na.fail")
nb_obs.fullmodel <- lm(nb_obs_esp_par_piege_par_jour ~., data = nb_obs_esp_dregde_REN_dt)
nb_obs.dredge <- dredge(nb_obs.fullmodel, rank = "AIC")
print("Renard roux")
print("Le plus simple des meilleurs modèles")
list_best_model <- nb_obs.dredge[nb_obs.dredge$delta<2]
best_model <- list_best_model[list_best_model$df==min(list_best_model$df)] ; best_model
```

#### en résumé

A fin de maximiser le nombre d'observation /piège/jour il faut (voir le plus simple des meilleurs modèles et les résultats covariable par covariable, parties 9.3 à 9.11 pour chaque espèce):

Pour la Belette d'Europe : s'éloigner de l'eau, éviter les habitat "abscence de végétation" et "berges sous pont", privilégier le support "arbre". 

Pour le Blaireau européen : être proche de l'eau, privilégier les habitats "fourrés" et "ripisylves".

Pour le Renard roux : être proche de l'eau, être en hauteur, éviter les habitats "berges sous pont", éviter le suport "sous pont". 

... Même logique pour les autres espèces.

!!! ATTENTION !!!
Pour la plupart des espèces et des covariables, le nombre d'observation n'est a priori pas suffissant pour avoir des résultats très robustes... Ex : Il y a souvent très peu d'observation en dehors des arbres, dans des habitats non fourrés ou ripisylves... ces résultats sont donc à prendre "avec des pincettes" !

# Délai de détection par espèce 

## Toutes les espèces

Délai de détection moyen par piège par espèce.

Délai de détection = date de 1er observation de l'espèce - date de pose du piège photo (en jours).

```{r, message=FALSE, warning=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
detect_dt <- data_4 %>% 
  select(ID_unique, espece, date_pose, date_obs, list_1) %>% 
  group_by(espece, ID_unique) %>% 
  mutate(date_detect = min(date_obs)) %>% 
  select(espece, ID_unique, date_pose, date_detect, list_1) %>% 
  distinct()

detect_dt_2 <- detect_dt %>% 
  mutate(difftime_detect = as.numeric(difftime(ymd(date_detect),ymd(date_pose), units = "days")))

detect_dt_3 <- detect_dt_2 %>% 
  group_by(espece) %>% 
  mutate(mean_delai_detect = mean(difftime_detect, na.rm=T)) %>% 
  mutate(sd_delai_detect = sd(difftime_detect, na.rm=T)) %>% 
  select(espece, mean_delai_detect, sd_delai_detect, list_1) %>% 
  distinct()

detect_dt_3_shown <- detect_dt_3 %>% 
  dplyr::rename("espèce" = espece, "groupe" = list_1,
                "délai de detection moyen" = mean_delai_detect,
                "écart-type délai de detection moyen" = sd_delai_detect)

# Click table
detect_dt_3_shown %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.width=10, fig.height=20}
delai_esp_plot <- ggplot(detect_dt_3, 
                         aes(reorder(espece, mean_delai_detect), mean_delai_detect, 
                             color = list_1)) +
  geom_errorbar(aes(ymin= ifelse(mean_delai_detect - sd_delai_detect < 0, 0, 
                                       mean_delai_detect - sd_delai_detect),
                    ymax=mean_delai_detect+sd_delai_detect),
                width=0, color="grey") +
  geom_point(size = 4) +
  coord_flip() +
  scale_color_manual(values=cols) +
  theme_classic() +
  theme(legend.position = "top") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="Delai de détection moyen par espèce",
        x ="Espèce", y = "Delai de détection moyen (en jours)", fill=""); delai_esp_plot
```

NEWNEWNEWNEWNEW

Toutes les espèces, sauf celles sont barres d'erreur (observées qu'une seule fois)

```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.width=10, fig.height=20}
detect_dt_v2 <- detect_dt_3 %>% 
  na.omit() %>% 
  filter(sd_delai_detect > 0)

delai_esp_plot <- ggplot(detect_dt_v2, 
                         aes(reorder(espece, mean_delai_detect), mean_delai_detect, 
                             color = list_1)) +
  geom_errorbar(aes(ymin= ifelse(mean_delai_detect - sd_delai_detect < 0, 0, 
                                       mean_delai_detect - sd_delai_detect),
                    ymax=mean_delai_detect+sd_delai_detect),
                width=0, color="grey") +
  geom_point(size = 4) +
  coord_flip() +
  scale_color_manual(values=cols) +
  theme_classic() +
  theme(legend.position = "top") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="Delai de détection moyen par espèce",
        x ="Espèce", y = "Delai de détection moyen (en jours)", fill=""); delai_esp_plot
```

NEWNEWNEWNEWNEW

Toutes les espèces, sans les oiseaux (nidicoles et nidifuges) ni les espèces domestiques

```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.width=7, fig.height=7}
detect_dt_v2 <- detect_dt_3 %>% 
  na.omit() %>% 
  filter(sd_delai_detect > 0)

detect_dt_v3 <- detect_dt_v2 %>% 
  filter(espece!="Chien") %>%
  filter(espece!="Rougegorge familier") %>% 
  filter(espece!="Troglodyte mignon") %>%
  filter(espece!="Merle noir") %>%
  filter(espece!="Mésange charbonnière") %>%
  filter(espece!="Grive musicienne") %>%
  filter(espece!="Bouscarle de cetti") %>%
  filter(espece!="Pouillot véloce") %>%
  filter(espece!="Accenteur mouchet") %>%
  filter(espece!="Râle d'eau") %>%
  filter(espece!="Gallinule poule d'eau") %>%
  filter(espece!="Fauvette à tête noire") %>%
  filter(espece!="Pouillot fitis") %>%
  filter(espece!="Ragondin") %>%
  filter(espece!="Torcol fourmilier") %>%
  filter(espece!="Oiseau indéterminé") %>%
  filter(espece!="Phragmite des joncs") %>%
  filter(espece!="Bruant des roseaux") %>%
  filter(espece!="Gorgebleue à miroir") %>%
  filter(espece!="Grande aigrette") %>%
  filter(espece!="Héron cendré") %>%
  filter(espece!="Cygne tuberculé") %>%
  filter(espece!="Canard colvert") %>%
  filter(espece!="Pinson des arbres") %>%
  filter(espece!="Hibou moyen-duc") %>%
  filter(espece!="Epervier d'Europe") %>%
  filter(espece!="Tadorne de Belon") %>%
  filter(espece!="Pie bavarde") %>%
  filter(espece!="Fauvette grisette") %>%
  filter(espece!="Chat domestique") %>%
  filter(espece!="Rougequeue à front blanc") %>%
  filter(espece!="Mésange bleue") %>%
  filter(espece!="Cisticole des joncs") %>%
  filter(espece!="Etourneau sansonnet") %>%
  filter(espece!="Grand cormoran") %>%
  filter(espece!="Aigrette garzette") %>%
  filter(espece!="Martin-pêcheur d'Europe") %>%
  filter(espece!="Faisan de Colchide") %>%
  filter(espece!="Bécassine des marais") %>%
  filter(espece!="Bihoreau gris") %>%
  filter(espece!="Geai des chênes") %>%
  filter(espece!="Rossignol philomèle") %>%
  filter(espece!="Spatule blanche") %>%
  filter(espece!="Foulque macroule") %>%
  filter(espece!="Pigeon ramier") %>%
  filter(espece!="Grive mauvis") %>%
  filter(espece!="Pic épeiche") %>%
  filter(espece!="Chardonneret élégant") %>%
  filter(espece!="Rousserolle effarvatte") %>%
  filter(espece!="Mésange à longue queue") %>%
  filter(espece!="Faisan sp") %>%
  filter(espece!="Canard sp") %>%
  filter(espece!="Moineau domestique") %>%
  filter(espece!="Buse variable") %>%
  filter(espece!="Grive litorne") %>%
  filter(espece!="Chevalier culblanc") %>%
  filter(espece!="Sarcelle d'hiver") %>%
  filter(espece!="Tarier pâtre") %>%
  filter(espece!="Pic vert") %>%
  filter(espece!="Roitelet à triple bandeaux") %>%
  filter(espece!="Pipit farlouse") 

unique(detect_dt_v3$espece)

delai_esp_plot <- ggplot(detect_dt_v3, 
                         aes(reorder(espece, mean_delai_detect), mean_delai_detect, 
                             color = list_1)) +
  geom_errorbar(aes(ymin= ifelse(mean_delai_detect - sd_delai_detect < 0, 0, 
                                       mean_delai_detect - sd_delai_detect),
                    ymax=mean_delai_detect+sd_delai_detect),
                width=0, color="grey") +
  geom_point(size = 4) +
  coord_flip() +
  scale_color_manual(values=c("#2f6f7a","#E4002B", "#D9C756")) +
  theme_classic() +
  theme(legend.position = "top") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="Delai de détection moyen par espèce",
        x ="Espèce", y = "Delai de détection moyen (en jours)", color=""); delai_esp_plot
```


```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.width=7, fig.height=5}
detect_dt_v4 <- detect_dt_v3[detect_dt_v3$list_1!="Amphibiens/Reptiles",]

delai_esp_plot_v4 <- ggplot(detect_dt_v4, 
                         aes(reorder(espece, mean_delai_detect), mean_delai_detect, 
                             color = list_1)) +
  geom_errorbar(aes(ymin= ifelse(mean_delai_detect - sd_delai_detect < 0, 0, 
                                       mean_delai_detect - sd_delai_detect),
                    ymax=mean_delai_detect+sd_delai_detect),
                width=0, color="grey") +
  geom_point(size = 4) +
  coord_flip() +
  scale_color_manual(values=c("#E4002B", "#D9C756")) +
  theme_classic() +
  theme(legend.position = "top") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="Delai de détection moyen par espèce",
        x ="Espèce", y = "Delai de détection moyen (en jours)", color=""); delai_esp_plot_v4
```

## Espèces d'intérêt

Seulement espèces de la liste 3.

Délai de détection moyen par piège par espèce.

Délai de détection = date de 1er observation de l'espèce - date de pose du piège photo (en jours).

!!!!!!!!!!!!!

```{r, echo=FALSE, message=FALSE, warning=FALSE}
detect_list_3_dt <- data_4_list_3 %>% 
  select(ID_unique, espece, date_pose, date_obs) %>% 
  group_by(espece, ID_unique) %>% 
  mutate(date_detect = min(date_obs)) %>% 
  select(espece, ID_unique, date_pose, date_detect) %>% 
  distinct()

detect_list_3_dt_2 <- detect_list_3_dt %>% 
  mutate(difftime_detect = as.numeric(difftime(ymd(date_detect),ymd(date_pose), units = "days")))

detect_list_3_dt_3 <- detect_list_3_dt_2 %>% 
  group_by(espece) %>% 
  mutate(mean_delai_detect = mean(difftime_detect, na.rm=T)) %>% 
  mutate(sd_delai_detect = sd(difftime_detect, na.rm=T)) %>% 
  select(espece, mean_delai_detect, sd_delai_detect) %>% 
  distinct()

detect_list_3_dt_3_shown <- detect_list_3_dt_3 %>% 
  dplyr::rename("espèce" = espece, 
                "délai de detection moyen" = mean_delai_detect,
                "écart-type délai de detection moyen" = sd_delai_detect)

# Click table
detect_list_3_dt_3_shown %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=3.5}
delai_esp_list_3_plot <- ggplot(detect_list_3_dt_3, 
                         aes(reorder(espece, mean_delai_detect), mean_delai_detect)) +
  geom_errorbar(aes(ymin= ifelse(mean_delai_detect - sd_delai_detect < 0, 0, 
                                       mean_delai_detect - sd_delai_detect),
                    ymax=mean_delai_detect+sd_delai_detect),
                width=0, color="grey") +
  geom_point(size = 4) +
  coord_flip() +
  scale_color_manual(values=cols) +
  theme_classic() +
  theme(legend.position = "top") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="Delai de détection moyen par espèce",
        x ="Espèce", y = "Delai de détection moyen (en jours)", fill=""); delai_esp_list_3_plot
```

# Richesse spécifique Cumulative 

Richesse spéficique cumulative en fonction du délai d'observation.

Traitement martre et fouine :

"Martre des Pins", "Fouine, "Martre/fouine"

Si présence "Martre des Pins" ou "Fouine" sur un piège photo avant -> "Martre/fouine" transformée en "Martre de Pins" ou "Fouine" en fonction de ce qui a été observé par le piège photo.

## Toutes les espèces  

Toutes les espèces détectées sur l'ensemble des pièges photos en même temps.

```{r include=FALSE}
rich_esp_delai_all <- data_4 %>% 
  select(espece, date_obs, date_pose) %>%
  mutate(difftime_pose_obs = as.numeric(difftime(ymd(date_obs),ymd(date_pose), units = "days"))) %>%
  distinct() %>%
  na.omit()

# rich_esp_delai_all <- rich_esp_delai_all[rich_esp_delai_all$difftime_pose_obs>=0,]

rich_esp_delai_all_2 <- rich_esp_delai_all %>%
  select(espece, difftime_pose_obs) %>% 
  distinct()

rich_esp_delai_all_2 <- rich_esp_delai_all_2 %>% 
  arrange(difftime_pose_obs)

old_esp_all = c("start")
old_new_esp_delai_all = NULL
for (i in unique(rich_esp_delai_all_2$difftime_pose_obs)) {
  # print (i)
  esp_i <- unique(rich_esp_delai_all_2$espece[rich_esp_delai_all_2$difftime_pose_obs==i]) #; esp_i
  for (s in esp_i) {
    # print(s)
    is_new_esp <- str_detect(s, old_esp_all) #; is_new_esp
      if (length(is_new_esp[is_new_esp == TRUE]>0)) { 
        info_i_s_old <- c(i, s, "old") #; info_i_s
        old_new_esp_delai_all <- rbind(old_new_esp_delai_all, info_i_s_old)} else {
        info_i_s_new <- c(i, s, "new") #; info_i_s
        old_new_esp_delai_all <- rbind(old_new_esp_delai_all, info_i_s_new) }
        old_new_esp_delai_all <- as.data.frame(old_new_esp_delai_all)
      
        old_esp_all <- old_new_esp_delai_all$V2[old_new_esp_delai_all$V3=="new"]
  }
}

old_new_esp_delai_all_2 <- old_new_esp_delai_all %>%
  group_by(V1) %>% 
  mutate(nb_new_delai = length(V3[V3=="new"])) 

old_new_esp_delai_all_3 <- old_new_esp_delai_all_2 %>% 
  select(V1,nb_new_delai) %>% 
  distinct()

old_new_esp_delai_all_3$cum_nb_new_delai <- cumsum(old_new_esp_delai_all_3$nb_new_delai)

old_new_esp_delai_all_3$V1 <- as.numeric(old_new_esp_delai_all_3$V1)
```

```{r, echo=FALSE, message=FALSE, fig.width=10, fig.height=5}
cum_spe_all_plot <- ggplot(old_new_esp_delai_all_3, aes(as.numeric(V1), cum_nb_new_delai, fill = cum_nb_new_delai)) +
  geom_line(size = 1) +
  geom_vline(xintercept = 82, color = "red", size = 1, linetype = "longdash") +
  geom_point(shape = 21, size = 4) +
  theme_classic() +
  scale_x_continuous(breaks=seq(0, 94, 2)) +
  scale_fill_gradient2(midpoint = 85, low = "#147bd1", mid = "#D9C756", high = "#E35205") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="Richesse spécifique cumulative (toutes les espèces)",
        x ="Délai d'observation (jours)", y = "Nombre cummulé de nouvelles espèces détectées",
       fill = "richesse specifique"); cum_spe_all_plot
```

## Espèces d'interêt seulement

Seulement les espèce de la liste 3 (Belette d'Europe, Blaireau européen, Fouine, Fouine/Martre, Genette commune, 
Loutre d’Europe, Martre des Pins, Putois d'Europe, Raton laveur, Renard roux).

### global

Toutes les espèces de la liste 3 détectées sur l'ensemble des pièges photos en même temps. 

```{r, echo=FALSE, include=FALSE}
rich_esp_delai <- data_4_list_3 %>% 
  select(espece, date_obs, date_pose) %>%
  mutate(difftime_pose_obs = as.numeric(difftime(ymd(date_obs),ymd(date_pose), units = "days"))) %>%
  distinct() %>%
  na.omit()

rich_esp_delai <- rich_esp_delai[rich_esp_delai$difftime_pose_obs>=0,]

rich_esp_delai_2 <- rich_esp_delai %>%
  select(espece, difftime_pose_obs) %>% 
  distinct()

rich_esp_delai_2 <- rich_esp_delai_2 %>% 
  arrange(difftime_pose_obs)

old_esp = c("start")
old_new_esp_delai = NULL
for (i in unique(rich_esp_delai_2$difftime_pose_obs)) {
  # print (i)
  esp_i <- unique(rich_esp_delai_2$espece[rich_esp_delai_2$difftime_pose_obs==i]) #; esp_i
  for (s in esp_i) {
    # print(s)
    is_new_esp <- str_detect(s, old_esp) #; is_new_esp
      if (length(is_new_esp[is_new_esp == TRUE]>0)) { 
        info_i_s_old <- c(i, s, "old") #; info_i_s
        old_new_esp_delai <- rbind(old_new_esp_delai, info_i_s_old)} else {
        info_i_s_new <- c(i, s, "new") #; info_i_s
        old_new_esp_delai <- rbind(old_new_esp_delai, info_i_s_new) }
        old_new_esp_delai <- as.data.frame(old_new_esp_delai)
      
        old_esp <- old_new_esp_delai$V2[old_new_esp_delai$V3=="new"]
  }
}

old_new_esp_delai_2 <- old_new_esp_delai %>%
  group_by(V1) %>% 
  mutate(nb_new_delai = length(V3[V3=="new"])) 

old_new_esp_delai_3 <- old_new_esp_delai_2 %>% 
  select(V1,nb_new_delai) %>% 
  distinct()

old_new_esp_delai_3$cum_nb_new_delai <- cumsum(old_new_esp_delai_3$nb_new_delai)

old_new_esp_delai_3$V1 <- as.numeric(old_new_esp_delai_3$V1)
```

```{r, echo=FALSE, message=FALSE, fig.width=10, fig.height=5}
cum_spe_plot <- ggplot(old_new_esp_delai_3, aes(as.numeric(V1), cum_nb_new_delai, fill = cum_nb_new_delai)) +
  geom_line(size = 1) +
  geom_vline(xintercept = 4, color = "red", size = 1, linetype = "longdash") +
  geom_point(shape = 21, size = 4) +
  theme_classic() +
  scale_x_continuous(breaks=seq(0, 94, 2)) +
  scale_fill_gradient2(midpoint = 9, low = "#147bd1", mid = "#D9C756", high = "#E35205") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="Richesse spécifique cumulative (espèces d'intérêt)",
        x ="Délai d'observation (jours)", y = "Nombre cummulé de nouvelles espèces détectées",
       fill = "richesse specifique"); cum_spe_plot
```

NEWNEWNEWNEWNEW

Nouvelle liste, sans les oiseaux ni les espèces domestiques 

```{r, echo=FALSE, message=FALSE, fig.width=10, fig.height=5}
dt_cum_new_list <- data_4 %>% 
  filter(espece!="Chien") %>%
  filter(espece!="Rougegorge familier") %>% 
  filter(espece!="Troglodyte mignon") %>%
  filter(espece!="Merle noir") %>%
  filter(espece!="Mésange charbonnière") %>%
  filter(espece!="Grive musicienne") %>%
  filter(espece!="Bouscarle de cetti") %>%
  filter(espece!="Pouillot véloce") %>%
  filter(espece!="Accenteur mouchet") %>%
  filter(espece!="Râle d'eau") %>%
  filter(espece!="Gallinule poule d'eau") %>%
  filter(espece!="Fauvette à tête noire") %>%
  filter(espece!="Pouillot fitis") %>%
  filter(espece!="Ragondin") %>%
  filter(espece!="Torcol fourmilier") %>%
  filter(espece!="Oiseau indéterminé") %>%
  filter(espece!="Phragmite des joncs") %>%
  filter(espece!="Bruant des roseaux") %>%
  filter(espece!="Gorgebleue à miroir") %>%
  filter(espece!="Grande aigrette") %>%
  filter(espece!="Héron cendré") %>%
  filter(espece!="Cygne tuberculé") %>%
  filter(espece!="Canard colvert") %>%
  filter(espece!="Pinson des arbres") %>%
  filter(espece!="Hibou moyen-duc") %>%
  filter(espece!="Epervier d'Europe") %>%
  filter(espece!="Tadorne de Belon") %>%
  filter(espece!="Pie bavarde") %>%
  filter(espece!="Fauvette grisette") %>%
  filter(espece!="Chat domestique") %>%
  filter(espece!="Rougequeue à front blanc") %>%
  filter(espece!="Mésange bleue") %>%
  filter(espece!="Cisticole des joncs") %>%
  filter(espece!="Etourneau sansonnet") %>%
  filter(espece!="Grand cormoran") %>%
  filter(espece!="Aigrette garzette") %>%
  filter(espece!="Martin-pêcheur d'Europe") %>%
  filter(espece!="Faisan de Colchide") %>%
  filter(espece!="Bécassine des marais") %>%
  filter(espece!="Bihoreau gris") %>%
  filter(espece!="Geai des chênes") %>%
  filter(espece!="Rossignol philomèle") %>%
  filter(espece!="Spatule blanche") %>%
  filter(espece!="Foulque macroule") %>%
  filter(espece!="Pigeon ramier") %>%
  filter(espece!="Grive mauvis") %>%
  filter(espece!="Pic épeiche") %>%
  filter(espece!="Chardonneret élégant") %>%
  filter(espece!="Rousserolle effarvatte") %>%
  filter(espece!="Mésange à longue queue") %>%
  filter(espece!="Faisan sp") %>%
  filter(espece!="Canard sp") %>%
  filter(espece!="Moineau domestique") %>%
  filter(espece!="Buse variable") %>%
  filter(espece!="Grive litorne") %>%
  filter(espece!="Chevalier culblanc") %>%
  filter(espece!="Sarcelle d'hiver") %>%
  filter(espece!="Tarier pâtre") %>%
  filter(espece!="Pic vert") %>%
  filter(espece!="Roitelet à triple bandeaux") %>%
  filter(espece!="Pipit farlouse") %>%
  filter(espece!="Canard pilet") %>%
  filter(espece!="Tourterelle des bois") %>%
  filter(espece!="Faucon crécerelle") %>%
  filter(espece!="Effraie des clochers") %>%
  filter(espece!="Chouette hulotte") %>%
  filter(espece!="Gros-bec casse-noyaux") %>%
  filter(espece!="Gobemouche noir") %>%
  filter(espece!="Bergeronnette des ruisseaux") %>%
  filter(espece!="Verdier d'Europe") %>%
  filter(espece!="Bergeronnette grise") %>%
  filter(espece!="Alouette des champs") %>%
  filter(espece!="Bruant zizi") %>%
  filter(espece!="Mouton") %>%
  filter(espece!="Chèvre") %>%
  filter(espece!="Perdrix rouge") %>%
  filter(espece!="Vache domestique") %>%
  filter(espece!="Merle à plastron") %>%
  filter(espece!="Tarin des aulnes") %>%
  filter(espece!="Traquet motteux") %>%
  filter(espece!="Indéterminé") %>%
  filter(espece!="Pigeon biset") %>%
  filter(espece!="Grimpereau des jardins") %>%
  filter(espece!="Cistude d'Europe") %>%
  filter(espece!="Grenouille verte indéterminée") %>%
  filter(espece!="Couleuvre sp") %>%
  filter(espece!="Lézard des murailles") %>%
  filter(espece!="Couleuvre verte et jaune") %>%
  filter(espece!="Amphibien sp") %>%
  filter(espece!="Lézard à deux raies") %>%
  filter(espece!="Lézard à deux raies") %>%
  filter(espece!="Couleuvre helvétique") %>%
  filter(espece!="Crapaud épineux") %>%
  filter(espece!="Urodèle sp") %>%
  filter(espece!="Serpent sp")  

unique(dt_cum_new_list$espece)
```

```{r include=FALSE}
rich_esp_delai_all <- dt_cum_new_list %>% 
  select(espece, date_obs, date_pose) %>%
  mutate(difftime_pose_obs = as.numeric(difftime(ymd(date_obs),ymd(date_pose), units = "days"))) %>%
  distinct() %>%
  na.omit()

# rich_esp_delai_all <- rich_esp_delai_all[rich_esp_delai_all$difftime_pose_obs>=0,]

rich_esp_delai_all_2 <- rich_esp_delai_all %>%
  select(espece, difftime_pose_obs) %>% 
  distinct()

rich_esp_delai_all_2 <- rich_esp_delai_all_2 %>% 
  arrange(difftime_pose_obs)

old_esp_all = c("start")
old_new_esp_delai_all = NULL
for (i in unique(rich_esp_delai_all_2$difftime_pose_obs)) {
  # print (i)
  esp_i <- unique(rich_esp_delai_all_2$espece[rich_esp_delai_all_2$difftime_pose_obs==i]) #; esp_i
  for (s in esp_i) {
    # print(s)
    is_new_esp <- str_detect(s, old_esp_all) #; is_new_esp
      if (length(is_new_esp[is_new_esp == TRUE]>0)) { 
        info_i_s_old <- c(i, s, "old") #; info_i_s
        old_new_esp_delai_all <- rbind(old_new_esp_delai_all, info_i_s_old)} else {
        info_i_s_new <- c(i, s, "new") #; info_i_s
        old_new_esp_delai_all <- rbind(old_new_esp_delai_all, info_i_s_new) }
        old_new_esp_delai_all <- as.data.frame(old_new_esp_delai_all)
      
        old_esp_all <- old_new_esp_delai_all$V2[old_new_esp_delai_all$V3=="new"]
  }
}

old_new_esp_delai_all_2 <- old_new_esp_delai_all %>%
  group_by(V1) %>% 
  mutate(nb_new_delai = length(V3[V3=="new"])) 

old_new_esp_delai_all_3 <- old_new_esp_delai_all_2 %>% 
  select(V1,nb_new_delai) %>% 
  distinct()

old_new_esp_delai_all_3$cum_nb_new_delai <- cumsum(old_new_esp_delai_all_3$nb_new_delai)

old_new_esp_delai_all_3$V1 <- as.numeric(old_new_esp_delai_all_3$V1)
```

NEWNEWNEWNEWNEW

```{r, echo=FALSE, message=FALSE, fig.width=10, fig.height=5}
cum_spe_all_plot <- ggplot(old_new_esp_delai_all_3, aes(as.numeric(V1), cum_nb_new_delai, fill = cum_nb_new_delai)) +
  geom_line(size = 1) +
  geom_vline(xintercept = 49, color = "red", size = 1, linetype = "longdash") +
  geom_point(shape = 21, size = 4) +
  theme_classic() +
  scale_x_continuous(breaks=seq(0, 94, 2)) +
  scale_fill_gradient2(midpoint = 23, low = "#147bd1", mid = "#D9C756", high = "#E35205") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="Richesse spécifique cumulative (toutes les espèces, sauf oiseaux, reptiles, amphibiens ni animaux domestiques)",
        x ="Délai d'observation (jours)", y = "Nombre cummulé de nouvelles espèces détectées",
       fill = "richesse specifique"); cum_spe_all_plot
```









### échantillonnage alétoire 

J'ai échantillonné aléatoirement 30 fois n (= 10, 30, 50, 100, 200, 250) nombre de piège photos parmi le jeu de données, et j'ai tracé la richesse spécifique cumulative moyenne obtenu.

Chaque couleur correspond un nombre n de pièges photos échantillonné aléatoirement.

Chaque ligne pleine est la richesse cumulative moyenne obtenu sur les 30 tirages aléatoires (+/- écart-type).

La ligne en pointillé noir est le seuil de détection total de 9 espèces : Belette d'Europe, Blaireau européen, Fouine et/ou Fouine/Martre et/ou Martre des Pins, Genette commune, Loutre d’Europe, Putois d'Europe, Raton laveur, Renard roux.

Les lignes en pointillé coloré correspond au délai d'observation nécessaire en moyenne pour détecter toutes les espèces.

```{r eval=FALSE, include=FALSE}
rich_esp_delai <- data_4 %>%
  select(ID_unique, espece, date_obs, date_pose) %>%
  mutate(difftime_pose_obs = as.numeric(difftime(ymd(date_obs), ymd(date_pose), units = "days"))) %>%
  distinct() %>%
  na.omit()

# rich_esp_delai <- rich_esp_delai[rich_esp_delai$difftime_pose_obs>=0,]

rich_esp_delai_2 <- rich_esp_delai %>%
  select(ID_unique, espece, difftime_pose_obs) %>%
  distinct()

rich_esp_delai_2 <- rich_esp_delai_2 %>%
  arrange(difftime_pose_obs)

list_all_piege <- unique(rich_esp_delai_2$ID_unique) ; list_all_piege
old_esp = c("start")
old_new_esp_delai = NULL

# t = 2
# nb_piege = 30

for (t in 1:100){

  print(t)

  # old_esp = c("start")
  # old_new_esp_delai = NULL

  for (nb_piege in c(10, 30, 50, 100, 200, 250)){

    # old_esp = c("start")
    # old_new_esp_delai = NULL

    print(nb_piege)

    ID_unique <- as.data.frame(sample(list_all_piege, nb_piege))
    names(ID_unique)[1] <- "ID_unique"
    rich_esp_delai_3 <- left_join(ID_unique, rich_esp_delai_2)
    length(table(rich_esp_delai_3$ID_unique))
    rich_esp_delai_4 <- cbind(rich_esp_delai_3, nb_piege)
    rich_esp_delai_5 <- cbind(rich_esp_delai_4, t)

      for (i in unique(rich_esp_delai_5$difftime_pose_obs)) {
        # print (i)
        esp_i <- unique(rich_esp_delai_5$espece[rich_esp_delai_5$difftime_pose_obs==i &
                                                  rich_esp_delai_5$nb_piege==nb_piege &
                                                  rich_esp_delai_5$t==t]) #; esp_i

        for (s in esp_i) {
          # print(s)
          is_new_esp <- str_detect(s, old_esp) #; is_new_esp

          if (length(is_new_esp[is_new_esp == TRUE]>0)) {
              info_i_s_old <- c(t, nb_piege, i, s, "old") #; info_i_s
              old_new_esp_delai <- rbind(old_new_esp_delai, info_i_s_old)} else {
              info_i_s_new <- c(t, nb_piege, i, s, "new") #; info_i_s
              old_new_esp_delai <- rbind(old_new_esp_delai, info_i_s_new) }
              old_new_esp_delai <- as.data.frame(old_new_esp_delai)

              old_esp <- old_new_esp_delai$V4[old_new_esp_delai$V5=="new" &
                                                old_new_esp_delai$V1==t &
                                                old_new_esp_delai$V2==nb_piege]
      }
    }
  }
}

old_new_esp_delai_list_3 <- old_new_esp_delai %>%
  filter(V4 == "Belette d'Europe" |
         V4 == "Blaireau européen" |
         V4 == "Fouine" |
         V4 == "Genette commune" |
         V4 == "Loutre d’Europe" |
         V4 == "Martre des Pins" |
         V4 == "Putois d'Europe" |
         V4 == "Raton laveur" |
         V4 == "Renard roux")

# table(old_new_esp_delai_list_3$V4)

old_new_esp_delai_2 <- old_new_esp_delai_list_3 %>%
  group_by(V1, V2, V3) %>%
  mutate(nb_new_delai = length(V5[V5=="new"]))

old_new_esp_delai_2$V3 <- as.numeric(old_new_esp_delai_2$V3)

old_new_esp_delai_3 <- old_new_esp_delai_2 %>%
  select(V1, V2, V3, nb_new_delai) %>%
  distinct()

old_new_esp_delai_3$V3 <- as.numeric(old_new_esp_delai_3$V3)

old_new_esp_delai_4 <- old_new_esp_delai_3 %>%
  group_by(V1, V2) %>%
  arrange(V1, V2, V3) %>%
  dplyr::mutate(cum_nb_new_delai = cumsum(nb_new_delai))

# old_new_esp_delai_3$cum_nb_new_delai <- cumsum(old_new_esp_delai_3$nb_new_delai)

old_new_esp_delai_5 <- old_new_esp_delai_4 %>%
  dplyr::rename(sampling = V1, nb_piege = V2, delai = V3)

old_new_esp_delai_5$group <- paste0(old_new_esp_delai_5$nb_piege,"_", old_new_esp_delai_5$sampling)

write.table(old_new_esp_delai_5, file = "old_new_esp_delai_5_new2.txt", sep = ",", col.names = NA, qmethod = "double")
```

```{r, echo=FALSE, message=FALSE, fig.width=10, fig.height=5}
old_new_esp_delai_5 <- read.table("old_new_esp_delai_5_new2.txt", sep=",", header = T)

mean_sim_dt <- old_new_esp_delai_5 %>% 
  group_by(nb_piege, delai) %>% 
  mutate(mean_sim = mean(cum_nb_new_delai))%>% 
  mutate(sd_sim = sd(cum_nb_new_delai))

mean_sim_dt_2 <- mean_sim_dt %>% 
  select(nb_piege, delai, mean_sim, sd_sim) %>% 
  arrange(desc(as.numeric(nb_piege))) %>% 
  distinct()
```

```{r, echo=FALSE, message=FALSE, warning=FALSE,fig.width=10, fig.height=5}
# mean_sim_dt_2$nb_piege <- as.numeric(as.character(mean_sim_dt_2$nb_piege))

# mean_sim_dt_2 <- mean_sim_dt_2 %>%
#   mutate(nb_piege = fct_reorder(nb_piege, desc(nb_piege)))
# data %>%
#   mutate(name = fct_reorder(name, val)) %>%
#   ggplot( aes(x=name, y=val)) +
#     geom_bar(stat="identity", fill="#f68060", alpha=.6, width=.4) +
#     coord_flip() +
#     xlab("") +
#     theme_bw()

mean_sim_dt_2$nb_piege <- factor(mean_sim_dt_2$nb_piege, levels = c("10", "30", "50", "100", "200", "250"))

min_delai_10spe_250 = min(mean_sim_dt_2$delai[mean_sim_dt_2$mean_sim ==9 &
                                                      mean_sim_dt_2$nb_piege==250])
min_delai_10spe_200 = min(mean_sim_dt_2$delai[mean_sim_dt_2$mean_sim==9 &
                                                      mean_sim_dt_2$nb_piege==200])
min_delai_10spe_100 = min(mean_sim_dt_2$delai[mean_sim_dt_2$mean_sim==9 &
                                                      mean_sim_dt_2$nb_piege==100])
min_delai_10spe_50 = min(mean_sim_dt_2$delai[mean_sim_dt_2$mean_sim==9 &
                                                      mean_sim_dt_2$nb_piege==50])
min_delai_10spe_30 = min(mean_sim_dt_2$delai[mean_sim_dt_2$mean_sim==9 &
                                                      mean_sim_dt_2$nb_piege==30])
min_delai_10spe_10 = min(mean_sim_dt_2$delai[mean_sim_dt_2$mean_sim==9 &
                                                      mean_sim_dt_2$nb_piege==10])


  
cum_spe_plot <- ggplot(mean_sim_dt_2, aes(as.numeric(delai), mean_sim, 
                                          group = nb_piege, color = nb_piege)) +
  geom_errorbar(aes(ymin = mean_sim - sd_sim, ymax = mean_sim + sd_sim), width = 0) +   
  geom_line(size = 1) +
  geom_hline(yintercept = 9, color = "black", size = 2, linetype = "longdash") +
  geom_vline(xintercept = min_delai_10spe_250, color = "#659157", size = 1, linetype = "dotted") +
  geom_vline(xintercept = min_delai_10spe_200, color = "#147bd1", size = 1, linetype = "dotted") +
  # geom_vline(xintercept = min_delai_10spe_100, color = "#D9C756", size = 1, linetype = "dotted") +
  # geom_vline(xintercept = min_delai_10spe_50, color = "#C6893F", size = 1, linetype = "dotted") +
  # geom_vline(xintercept = min_delai_10spe_30, color = "#F7AEF8", size = 1, linetype = "dotted") +
  # geom_vline(xintercept = min_delai_10spe_10, color = "#E4002B", size = 1, linetype = "dotted") +
  # geom_point(shape = 21, size = 4, fill = "white") +
  theme_classic() +
  # scale_x_continuous(breaks=seq(0, 94, 2)) +
  scale_y_continuous(breaks=seq(0, 10, 1)) +
  # scale_color_gradient2(midpoint = 120, low = "#147bd1", mid = "#D9C756", high = "#E35205") +
  scale_color_manual(values = c("#E4002B","#F7AEF8","#C6893F","#D9C756","#147bd1","#659157")) +
  # scale_fill_manual(values = c("#AAFAC8","#5E0035")) +
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="Richesse spécifique cumulative pour différente quantité de piège photo échantillonné aléatoirement
(espèces focales seulement)",
        x ="Délai d'observation (jours)", y = "Nombre cummulé de nouvelles espèces détectées",
       color = "nb piège photo"); cum_spe_plot
```

Résultats : 

L'utilisation de seulement 10 pièges photos aurait été clairement insuffisante.

A partir de 100 pièges photos, toutes les espèces observées sont détectées, avec en moyenne un délai de détection "total" de 44 jours minimum.

### par point d'observation

```{r, echo=FALSE, include=FALSE, message=FALSE, warning=FALSE}
rich_esp_delai_piege <- data_4_list_3 %>% 
  select(espece, ID_unique, date_obs, date_pose) %>%
  mutate(difftime_pose_obs = as.numeric(difftime(ymd(date_obs),ymd(date_pose), units = "days"))) %>%
  distinct() %>%
  na.omit()

rich_esp_delai_piege_2 <- rich_esp_delai_piege %>%
  select(espece, ID_unique, difftime_pose_obs) %>% 
  distinct()

rich_esp_delai_piege_2 <- rich_esp_delai_piege_2 %>% 
  arrange(difftime_pose_obs)

# estimation richesse cumulative par piège photo :

# p = NA
# old_esp_p = NULL
# les_p <- unique(rich_esp_delai_piege_2$ID_unique) ; les_p
# les_NA <- matrix(data=NA,nrow=length(les_p),ncol=15) ; les_NA
# old_esp_piege <- as.data.frame(cbind(les_p, les_NA)) ; old_esp_piege
# old_esp_piege <- old_esp_piege %>% 
#   rename(ID_unique = les_p)


p = "start"
old_esp = "start"
old_esp_all = as.data.frame(cbind(p, old_esp))
old_new_esp_delai_piege = NULL


for (p in unique(rich_esp_delai_piege_2$ID_unique)) { 
  print("piège :") ; print(p)
  del_p <- unique(rich_esp_delai_piege_2$difftime_pose_obs[rich_esp_delai_piege_2$ID_unique==p]) ; del_p
  
    # for (i in c(0:max(rich_esp_delai_piege_2$difftime_pose_obs))) {  
    for (i in del_p) {    

      # print("délai :") ; print (i)
      esp_p_i <- unique(rich_esp_delai_piege_2$espece[rich_esp_delai_piege_2$difftime_pose_obs==i &
                                                      rich_esp_delai_piege_2$ID_unique==p]) ; esp_p_i
    
        for (s in esp_p_i) {
          # print("espèce :") ; print(s)
          old_esp_p <- old_esp_all$old_esp[old_esp_all$p==p] ; old_esp_p
          is_new_esp <- str_detect(s, old_esp_p) ; is_new_esp
          
            if (length(is_new_esp[is_new_esp == TRUE]>0)) { 
              info_i_s_old <- c(p, i, s, "old") #; info_i_s
              old_new_esp_delai_piege <- rbind(old_new_esp_delai_piege, info_i_s_old)} else {
              info_i_s_new <- c(p, i, s, "new") #; info_i_s
              old_new_esp_delai_piege <- rbind(old_new_esp_delai_piege, info_i_s_new) }
              old_new_esp_delai_piege <- as.data.frame(old_new_esp_delai_piege)
              
              old_esp <- old_new_esp_delai_piege$V3[old_new_esp_delai_piege$V4=="new"&
                                                    old_new_esp_delai_piege$V1==p]
              
              old_esp_avec_p <- as.data.frame(cbind(p, old_esp))
              
              old_esp_all <- rbind(old_esp_all, old_esp_avec_p)
              
    }
    
  }
  
}

old_new_esp_delai_piege$V1 <- as.numeric(old_new_esp_delai_piege$V1)
old_new_esp_delai_piege$V2 <- as.numeric(old_new_esp_delai_piege$V2)


old_new_esp_delai_piege <- old_new_esp_delai_piege %>% 
  dplyr::rename(ID_unique = V1, delai = V2, espece = V3, old_new = V4)

old_new_esp_delai_piege_2 <- old_new_esp_delai_piege %>%
  group_by(ID_unique, delai) %>% 
  mutate(nb_new_delai = length(old_new[old_new=="new"])) 

old_new_esp_delai_piege_2 <- old_new_esp_delai_piege_2 %>% 
  select(ID_unique, delai, nb_new_delai) %>% 
  distinct()

old_new_esp_delai_piege_3 <- old_new_esp_delai_piege_2 %>%
  select(ID_unique, delai, nb_new_delai) %>%
  group_by(ID_unique) %>%
  # mutate(cum_nb_new_delai_piege = cumsum(nb_new_delai)) %>%
  distinct()

# expand 0 pour tous les delai qui ne sont pas dans le jeu de données 

all_delai <- old_new_esp_delai_piege_3 %>% 
  group_by(ID_unique) %>%
  tidyr::expand(delai = 0:100)

old_new_esp_delai_piege_3 <- na.omit(old_new_esp_delai_piege_3)

old_new_esp_delai_piege_4 <- left_join(all_delai, old_new_esp_delai_piege_3)
  
old_new_esp_delai_piege_5 <- old_new_esp_delai_piege_4

old_new_esp_delai_piege_5[is.na(old_new_esp_delai_piege_5)] <- 0

# delai d'observation max par piège 

# max_del_dt <- old_new_esp_delai_piege_3 %>% 
#   group_by(ID_unique) %>% 
#   mutate(max_delai_piege = max(delai)) %>% 
#   select(ID_unique, max_delai_piege) %>% 
#   distinct()

# old_new_esp_delai_piege_6 <- left_join(old_new_esp_delai_piege_5, max_del_dt)

# limiter le delai max pour chaque piège a la durée d'obs 

duree_obs_piege <- data_4 %>% 
  select(ID_unique, duree_obs) %>% 
  distinct()

old_new_esp_delai_piege_6 <- left_join(old_new_esp_delai_piege_5, duree_obs_piege)


old_new_esp_delai_piege_7 <- old_new_esp_delai_piege_6 %>%
  group_by(ID_unique) %>% 
  filter(delai <= duree_obs)

old_new_esp_delai_piege_7 <- old_new_esp_delai_piege_7 %>% 
  # select(ID_unique, delai, nb_new_delai) %>% 
  group_by(ID_unique) %>% 
  mutate(cum_nb_new_delai_piege = cumsum(nb_new_delai)) %>% 
  distinct()

```

En noir : moyenne du nombre d'espèce cummulées observées chaque jour par piège
En couleur : nombre d'espèce cummulées chaque jour par piège
En rouge: délai d'observation moyen (+/- écart-type) pour atteinde le nombre d'espèce observées maximal par piège  

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=5}
# old_new_esp_delai_piege_3 <- old_new_esp_delai_piege_3 %>% 
#   group_by(ID_unique) %>% 
#   mutate(max_cum = max(cum_nb_new_delai_piege))
# 
# mean_plateau_dt <- old_new_esp_delai_piege_3[old_new_esp_delai_piege_3$cum_nb_new_delai_piege==old_new_esp_delai_piege_3$max_cum,]
# 
# mean_plateau_dt_2 <- mean_plateau_dt %>% 
#   group_by(ID_unique) %>% 
#   filter(delai == min(delai))
#   
# mean_delai_plateau <- mean(mean_plateau_dt_2$delai) 
# sd_delai_plateau <- sd(mean_plateau_dt_2$delai) 
# 
# mean_cum <- mean(mean_plateau_dt_2$cum_nb_new_delai_piege)
# 
# mean_richesse_cum_dt <- old_new_esp_delai_piege_3 %>% 
#   group_by(delai) %>% 
#   mutate(mean_cum = mean(cum_nb_new_delai_piege)) %>% 
#   mutate(sd_cum = sd(cum_nb_new_delai_piege)) %>% 
#   select(delai, mean_cum, sd_cum) %>% 
#   distinct()
# 
# mean_richesse_cum_dt <- mean_richesse_cum_dt[mean_richesse_cum_dt$delai<=75,]
# 
# # plot
# cum_spe_piege_plot <- ggplot() +
#   annotate("rect", xmin=mean_delai_plateau - sd_delai_plateau, 
#                    xmax=mean_delai_plateau + sd_delai_plateau, 
#            ymin=1, ymax=Inf, alpha=0.1, fill="red") +
#   geom_line(data = old_new_esp_delai_piege_3, aes(delai, cum_nb_new_delai_piege,
#                                                             group = as.factor(ID_unique),
#                                                             color = cum_nb_new_delai_piege,
#                                                             fill = cum_nb_new_delai_piege),
#             size = 1) +
#   geom_point(shape = 21, size = 4, color = "black") +
#   geom_line(data = mean_richesse_cum_dt, aes(delai, mean_cum),
#             size = 2, color = "black") +
#   geom_errorbar(data = mean_richesse_cum_dt, aes(delai, mean_cum, 
#                                                  ymin = mean_cum - sd_cum, ymax = mean_cum + sd_cum), width = 0) +
#   geom_vline(xintercept = mean_delai_plateau, color = "red", size = 1, linetype = "longdash") +
#   theme_classic() +
#   scale_x_continuous(breaks=seq(0, 94, 2)) +
#   scale_y_continuous(breaks=seq(0, 94, 1)) +
#   scale_color_gradient2(midpoint = 4, low = "#147bd1", mid = "#D9C756", high = "#E35205") +
#   # scale_fill_gradient2(midpoint = 6.5, low = "#147bd1", mid = "#D9C756", high = "#E35205") +
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
#   # theme(legend.position="none") +
#   labs(title="Richesse spécifique cumulative (espèces d'intérêt)",
#         x ="Délai d'observation (jours)", y = "Nombre cummulé de nouvelles espèces détectées",
#        color = "richesse specifique"); cum_spe_piege_plot
```

```{r, echo=FALSE, message=FALSE,warning=FALSE, fig.width=10, fig.height=4}
old_new_esp_delai_piege_7 <- old_new_esp_delai_piege_7 %>% 
  group_by(ID_unique) %>% 
  mutate(max_cum = max(cum_nb_new_delai_piege))

mean_plateau_dt <- old_new_esp_delai_piege_7[old_new_esp_delai_piege_7$cum_nb_new_delai_piege==old_new_esp_delai_piege_7$max_cum,]

mean_plateau_dt_2 <- mean_plateau_dt %>% 
  group_by(ID_unique) %>% 
  filter(delai == min(delai))
  
mean_delai_plateau <- mean(mean_plateau_dt_2$delai) 
sd_delai_plateau <- sd(mean_plateau_dt_2$delai) 

mean_cum <- mean(mean_plateau_dt_2$cum_nb_new_delai_piege)

mean_richesse_cum_dt <- old_new_esp_delai_piege_7 %>% 
  group_by(delai) %>% 
  mutate(mean_cum = mean(cum_nb_new_delai_piege)) %>% 
  mutate(sd_cum = sd(cum_nb_new_delai_piege)) %>% 
  select(delai, mean_cum, sd_cum) %>% 
  distinct()

mean_richesse_cum_dt <- mean_richesse_cum_dt[mean_richesse_cum_dt$delai<=75,]

# plot
cum_spe_piege_plot <- ggplot() +
  annotate("rect", xmin=mean_delai_plateau - sd_delai_plateau, 
                   xmax=mean_delai_plateau + sd_delai_plateau, 
           ymin=-Inf, ymax=Inf, alpha=0.1, fill="red") +
  geom_line(data = old_new_esp_delai_piege_7, aes(delai, cum_nb_new_delai_piege,
                                                            group = as.factor(ID_unique),
                                                            color = cum_nb_new_delai_piege,
                                                            fill = cum_nb_new_delai_piege),
            size = 1) +
  geom_point(shape = 21, size = 4, color = "black") +
  geom_line(data = mean_richesse_cum_dt, aes(delai, mean_cum),
            size = 2, color = "black") +
  geom_errorbar(data = mean_richesse_cum_dt, aes(delai, mean_cum, 
                                                 ymin = mean_cum - sd_cum, ymax = mean_cum + sd_cum), width = 0) +
  geom_vline(xintercept = mean_delai_plateau, color = "red", size = 1, linetype = "longdash") +
  theme_classic() +
  scale_x_continuous(breaks=seq(0, 94, 2)) +
  scale_y_continuous(breaks=seq(0, 94, 1)) +
  scale_color_gradient2(midpoint = 4, low = "#147bd1", mid = "#D9C756", high = "#E35205") +
  # scale_fill_gradient2(midpoint = 6.5, low = "#147bd1", mid = "#D9C756", high = "#E35205") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  # theme(legend.position="none") +
  labs(title="Richesse spécifique cumulative (espèces d'intérêt)",
        x ="Délai d'observation (jours)", y = "Nombre cummulé de nouvelles espèces détectées",
       color = "Richesse 
specifique"); cum_spe_piege_plot
```

#### ~ coulée

Délai d'observation par piège pour atteindre la richesse maximale observée en fonction de la présence d'une coulée à proximité ou non.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=3.5, fig.height=3.5}
rich_piege_covariable_dt <- old_new_esp_delai_piege_7 %>% 
  group_by(ID_unique) %>% 
  filter(cum_nb_new_delai_piege == max_cum) %>% 
  filter(delai == min(delai)) %>%
  select(ID_unique, delai)

rich_piege_covariable_dt_2 <- left_join(rich_piege_covariable_dt, piege_5)
```

```{r, echo=FALSE,message=FALSE, warning=FALSE, fig.width=3.5, fig.height=3.5}
rich_coulee_plot <- ggplot(data = rich_piege_covariable_dt_2, aes(x = coulee, y = delai)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(shape = 21, size = 1, fill = "white") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red", aes(width=5)) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1.5, color="red", fill="red", size = 2) +
               ylab("Délai d'observation par piège pour 
atteindre la richesse maximale observée") + xlab("Coulée à proximité") +
  theme_classic() ; rich_coulee_plot

tab_model(lm(delai ~ coulee, 
             data = rich_piege_covariable_dt_2),
             title = "Délai d'observation par piège pour atteindre la richesse maximale observée en fonction de la présence d'une coulée à proximité")

t.test(rich_piege_covariable_dt_2$delai ~ rich_piege_covariable_dt_2$coulee)
```

#### ~ support

Délai d'observation par piège pour atteindre la richesse maximale observée en fonction de la présence du support de pose du piège photo.

```{r, echo=FALSE,message=FALSE, warning=FALSE, fig.width=4, fig.height=5}
rich_support_plot <- ggplot(data = rich_piege_covariable_dt_2, aes(x = support, y = delai)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(shape = 21, size = 1, fill = "white") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red", aes(width=5)) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1.5, color="red", fill="red", size = 2) +
               ylab("Délai d'observation par piège pour 
atteindre la richesse maximale observée") + xlab("Support") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) ; rich_support_plot

tab_model(lm(delai ~ support, 
             data = rich_piege_covariable_dt_2),
             title = "Délai d'observation par piège pour atteindre la richesse maximale observée en fonction du support")
```

#### ~ habitat

Délai d'observation par piège pour atteindre la richesse maximale observée en fonction de l'habitat.

```{r, echo=FALSE,message=FALSE, warning=FALSE, fig.width=4, fig.height=5}
rich_habitat_plot <- ggplot(data = rich_piege_covariable_dt_2[!is.na(rich_piege_covariable_dt_2$habitat),], aes(x = habitat, y = delai)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(shape = 21, size = 1, fill = "white") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red", aes(width=5)) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1.5, color="red", fill="red", size = 2) +
               ylab("Délai d'observation par piège pour 
atteindre la richesse maximale observée") + xlab("Habitat") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) ; rich_habitat_plot

tab_model(lm(delai ~ habitat, 
             data = rich_piege_covariable_dt_2[!is.na(rich_piege_covariable_dt_2$habitat),]),
             title = "Délai d'observation par piège pour atteindre la richesse maximale observée en fonction de l'habitat")
```

#### ~ DAC piege

Délai d'observation par piège pour atteindre la richesse maximale observée en fonction de la mise en place d'un DAC ou non.

```{r, echo=FALSE,message=FALSE, warning=FALSE, fig.width=3.5, fig.height=3.5}
rich_DAC_piege_plot <- ggplot(data = rich_piege_covariable_dt_2, aes(x = DAC_piege, y = delai)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(shape = 21, size = 1, fill = "white") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red", aes(width=5)) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1.5, color="red", fill="red", size = 2) +
               ylab("Délai d'observation par piège pour 
atteindre la richesse maximale observée") + xlab("Habitat") +
  theme_classic() ; rich_DAC_piege_plot

tab_model(lm(delai ~ DAC_piege, 
             data = rich_piege_covariable_dt_2),
             title = "Délai d'observation par piège pour atteindre la richesse maximale observée en fonction de l'instalation d'un DAC")
```

#### ~ all covariables

Sélection de modèle.

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=6, fig.height=6}
rich_piege_covariable_dregde_dt <- rich_piege_covariable_dt_2 %>% 
  select(delai, coulee, support, habitat, DAC_piege) %>% 
  na.omit()

rich_piege_covariable_dregde_dt <- rich_piege_covariable_dregde_dt[,c(2:6)]

options(na.action = "na.fail")
rich.fullmodel <- lm(delai ~., data = rich_piege_covariable_dregde_dt)
rich.dredge <- dredge(rich.fullmodel, rank = "AIC")
rich.dredge

print("Liste des meilleures modèles")
list_best_model <- rich.dredge[rich.dredge$delta<2] ; list_best_model

print("Le plus simple des meilleurs modèles")
best_model <- list_best_model[list_best_model$df==min(list_best_model$df)] ; best_model
```

## Proportion de piège avec x espèce détection au delai moyen

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! a repenser 
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! a repenser 
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! a repenser 
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! a repenser 
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! a repenser 
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! a repenser 
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! a repenser 
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! a repenser 
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! a repenser 
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! a repenser 

prop_nb_esp_10_dt <- old_new_esp_delai_piege_7 %>%
  filter(delai == 10) %>%
  group_by(ID_unique) %>% 
  mutate(cum_esp_10 = max(cum_nb_new_delai_piege)) %>% 
  select(ID_unique, cum_esp_10) %>%
  distinct()

prop_nb_esp_30_dt <- old_new_esp_delai_piege_7 %>%
  filter(delai == 30) %>%
  group_by(ID_unique) %>% 
  mutate(cum_esp_30 = max(cum_nb_new_delai_piege)) %>% 
  select(ID_unique, cum_esp_30) %>%
  distinct()

prop_nb_esp_60_dt <- old_new_esp_delai_piege_7 %>%
  filter(delai == 60) %>%
  group_by(ID_unique) %>% 
  mutate(cum_esp_60 = max(cum_nb_new_delai_piege)) %>% 
  select(ID_unique, cum_esp_60) %>%
  distinct()

prop_nb_esp_90_dt <- old_new_esp_delai_piege_7 %>%
  filter(delai == 90) %>%
  group_by(ID_unique) %>% 
  mutate(cum_esp_90 = max(cum_nb_new_delai_piege)) %>% 
  select(ID_unique, cum_esp_90) %>%
  distinct()

prop_nb_esp_ALL_dt <- left_join(prop_nb_esp_10_dt, prop_nb_esp_30_dt)
prop_nb_esp_ALL_dt <- left_join(prop_nb_esp_ALL_dt, prop_nb_esp_60_dt)
prop_nb_esp_ALL_dt <- left_join(prop_nb_esp_ALL_dt, prop_nb_esp_90_dt)

nb_piege_x_esp_delai_10 <- as.data.frame(table(prop_nb_esp_ALL_dt$cum_esp_10))
nb_piege_x_esp_delai_10 <- nb_piege_x_esp_delai_10 %>% 
  dplyr::rename(nb_esp_obs = Var1, nb_piege_delai_10 = Freq)
nb_piege_x_esp_delai_30 <- as.data.frame(table(prop_nb_esp_ALL_dt$cum_esp_30))
nb_piege_x_esp_delai_30 <- nb_piege_x_esp_delai_30 %>% 
  dplyr::rename(nb_esp_obs = Var1, nb_piege_delai_30 = Freq)
nb_piege_x_esp_delai_60 <- as.data.frame(table(prop_nb_esp_ALL_dt$cum_esp_60))
nb_piege_x_esp_delai_60 <- nb_piege_x_esp_delai_60 %>% 
  dplyr::rename(nb_esp_obs = Var1, nb_piege_delai_60 = Freq)
nb_piege_x_esp_delai_90 <- as.data.frame(table(prop_nb_esp_ALL_dt$cum_esp_90))
nb_piege_x_esp_delai_90 <- nb_piege_x_esp_delai_90 %>% 
  dplyr::rename(nb_esp_obs = Var1, nb_piege_delai_90 = Freq)

nb_piege_x_esp_delai_all <- left_join(nb_piege_x_esp_delai_60, nb_piege_x_esp_delai_90)
nb_piege_x_esp_delai_all <- left_join(nb_piege_x_esp_delai_all, nb_piege_x_esp_delai_30)
nb_piege_x_esp_delai_all <- left_join(nb_piege_x_esp_delai_all, nb_piege_x_esp_delai_10)

nb_piege_x_esp_delai_all_melt <- melt(nb_piege_x_esp_delai_all, id = c("nb_esp_obs"))

ggplot(data=nb_piege_x_esp_delai_all_melt, aes(x=nb_esp_obs, y=value, fill=variable)) +
geom_bar(stat="identity", position=position_dodge())

ggplot(data=nb_piege_x_esp_delai_all_melt, aes(x=variable, y=value, fill=nb_esp_obs)) +
geom_bar(stat="identity", position=position_dodge())
```

# Naïve occupancy

From Rovero & Zimmermann 2016 :
 
Naïve (or observed) occupancy is simply the proportion of camera trap stations where the species has been captured relative to the total number of camera stations sampled.

Ranging from 0 to 1.

Provide an indication of the extent of species’ presence across the area sampled. The closer the value is to 1, the larger the proportion of sites where the species occur. This may in turn indicate wider distribution of a species, especially if the camera sites are sufficient in number to cover a representative sample of the target area.

Naïve occupancy provides information on where the species is more or less likely to be detected rather than an estimate of true occupancy.

## Toutes les espèces

```{r, echo=FALSE}
naive_occ_dt <- data_4 %>% 
  select(ID_unique, espece,list_1)

nb_piege <- length(unique(naive_occ_dt$ID_unique)) ; nb_piege

naive_occ_dt <- naive_occ_dt %>% 
  group_by(espece) %>% 
  mutate(nb_pige_esp = length(unique(ID_unique))) %>% 
  mutate(naive_occ = nb_pige_esp/nb_piege) %>% 
  arrange(desc(naive_occ))

naive_occ_dt_shown <- naive_occ_dt %>% 
  select(espece, list_1, naive_occ) %>% 
  distinct() %>% 
  dplyr::rename("Espèce" = espece, "naïve occupency" = naive_occ, groupe = list_1) 

# Click table
naive_occ_dt_shown %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

```

```{r, echo=FALSE, fig.width=10, fig.height=20}
naive_occ_plot <- ggplot(naive_occ_dt, aes(x=reorder(espece,naive_occ), y=naive_occ)) + 
  geom_point(aes(fill = list_1), shape = 21, size = 4) +
  theme_classic() +
  coord_flip() +
  theme(legend.position = "top") +
  scale_fill_manual(values=cols) +
  labs(title="",
        x ="Espèce", y = "Naïve occupency", fill=""); naive_occ_plot
```

## Espèces d'intérêt

!!!!!!!!!

```{r, echo=FALSE}
naive_occ_list_3_dt <- data_4_list_3 %>% 
  select(ID_unique, espece)

nb_piege <- length(unique(naive_occ_list_3_dt$ID_unique)) ; nb_piege

naive_occ_list_3_dt <- naive_occ_list_3_dt %>% 
  group_by(espece) %>% 
  mutate(nb_pige_esp = length(unique(ID_unique))) %>% 
  mutate(naive_occ = nb_pige_esp/nb_piege) %>% 
  arrange(desc(naive_occ))

naive_occ_list_3_dt_shown <- naive_occ_list_3_dt %>% 
  select(espece, naive_occ) %>% 
  distinct() %>% 
  dplyr::rename("Espèce" = espece, "naïve occupency" = naive_occ) 

# Click table
naive_occ_list_3_dt_shown %>%
  datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

```

```{r, echo=FALSE,warning=FALSE, fig.width=10, fig.height=3.5}
naive_occ_list_3_plot <- ggplot(naive_occ_list_3_dt, aes(x=reorder(espece,naive_occ), y=naive_occ)) + 
  geom_point(shape = 19, size = 4) +
  theme_classic() +
  coord_flip() +
  theme(legend.position = "top") +
  scale_fill_manual(values=cols) +
  labs(title="",
        x ="Espèce", y = "Naïve occupency", fill=""); naive_occ_list_3_plot
```

# Zoom ragondin

```{r, echo=FALSE}
nb_obs_rag_dt <- data_4 %>%
  filter(espece == "Ragondin") %>% 
  group_by(ID_unique) %>% 
  mutate(nb_obs_esp_par_piege = sum(nb_detection)) %>%
  mutate(nb_obs_esp_par_piege_par_jour = sum(nb_detection)/duree_obs) %>% 
  select(espece,ID_unique,date_pose,date_retrait,distance_eau,hauteur,
         support,temp,DAC_interaction,coulee,habitat,date_fin_obs,duree_obs,hour_obs,
         nb_obs_esp_par_piege,nb_obs_esp_par_piege_par_jour,list_3) %>% 
  distinct() %>% 
  na.omit()

# nb_obs_rag_dt_shown <- nb_obs_rag_dt %>% 
#   select(ID_unique, nb_obs_esp_par_piege, nb_obs_esp_par_piege_par_jour) %>% 
#   distinct() %>% 
#   dplyr::rename("point d'observation" = ID_unique, 
#                 "nombre de détection" = nb_obs_esp_par_piege, 
#                 "nombre de détection par jour d'observation" = nb_obs_esp_par_piege_par_jour)
# 
# # Click table
# nb_obs_esp_dt_shown %>%
#   datatable(extensions = 'Buttons',
#             options = list(dom = 'Blfrtip',
#                            buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
#                            lengthMenu = list(c(10,25,50,-1),
#                                              c(10,25,50,"All"))))
```

## Nombre d'observation

### ~ hauteur 

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
nb_obs_rag_hauteur_dt <- nb_obs_rag_dt %>% 
  select(espece,ID_unique, hauteur, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

nb_obs_rag_moy_hauteur_plot <- ggplot(data = nb_obs_rag_hauteur_dt,
             aes(hauteur, nb_obs_esp_par_piege_par_jour)) +
  geom_point(size = 4, shape = 21, fill = "grey") +
  geom_smooth(method = lm, linetype = "dotted") +
  facet_wrap(~ espece, ncol = 5) +
  ylab("Nombre d'observation /piège/jour") + xlab("Hauteur") +
  theme_classic() ; nb_obs_rag_moy_hauteur_plot
```

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}
tab_model(lm(nb_obs_esp_par_piege_par_jour ~ hauteur, 
             data = nb_obs_rag_hauteur_dt),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Ragondin)")
```

### ~ support 

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# data
nb_obs_rag_support_dt <- nb_obs_rag_dt %>% 
  select(espece, ID_unique, support, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

# plot
rag_nb_obs_support_plot <- ggplot(nb_obs_rag_support_dt, aes(support, nb_obs_esp_par_piege_par_jour)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(width = 0.2, height = 0.2, size = 1, fill = "white", shape = 21) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1.5, color="red", fill="red") +
  # geom_signif(data = nb_obs_rag_support_dt, aes(x=support, y=nb_obs_esp_par_piege_par_jour),
  #             comparisons = list(c("Arbre", "Piquet")),
  #             map_signif_level=TRUE,
  #             y_position = 2, color = "black",
  #             test = "t.test") +
  facet_wrap(~ espece, ncol = 5) +
  theme_classic() +
  ylim(-0.3, 3.2) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Support", y = "Nombre de photo valide"); rag_nb_obs_support_plot

# model
tab_model(lm(nb_obs_esp_par_piege_par_jour ~ support, data = nb_obs_rag_support_dt), 
          title = "Nombre d'observation /piège/jour en fonction du support d'installation (ref = Arbre)")
```

### ~ habitat 

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# data
nb_obs_rag_habitat_dt <- nb_obs_rag_dt %>% 
  select(espece, ID_unique, habitat, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

# plot
rag_nb_obs_habitat_plot <- ggplot(nb_obs_rag_habitat_dt, aes(habitat, nb_obs_esp_par_piege_par_jour)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(width = 0.2, height = 0.2, size = 1, fill = "white", shape = 21) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1, color="red", fill="red") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1, color="red", fill="red") +
  theme_classic() +
  facet_wrap(~ espece, ncol = 5) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Habitat", y = "Nombre d'observation /piège/jour"); rag_nb_obs_habitat_plot
```

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}
tab_model(lm(nb_obs_esp_par_piege_par_jour ~ habitat, 
             data = nb_obs_rag_habitat_dt,
          habitat = forcats::fct_relevel(habitat,"Fourrés")),
          title = "Nombre d'observation moyen 
          par piège par jour en fonction de la hauteur d'installation
          (Ragondin)")
```

### ~ distance à l'eau 

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
nb_obs_rag_distance_eau_dt <- nb_obs_rag_dt %>% 
  select(espece, ID_unique, distance_eau, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

rag_nb_obs_esp_moy_distance_eau_plot <- ggplot(data = nb_obs_rag_distance_eau_dt,
             aes(distance_eau, nb_obs_esp_par_piege_par_jour)) +
  geom_point(size = 4, shape = 21, fill = "grey") +
  geom_smooth(method = lm, linetype = "dotted") +
  # scale_linetype_manual(values = c("dotted", "solid")) +
  facet_wrap(~ espece, ncol = 5) +
  ylab("Nombre d'observation /piège/jour") + xlab("Distance à l'eau") +
  theme_classic() ; rag_nb_obs_esp_moy_distance_eau_plot
```

Modèles pour chaque espèce séparemment :

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ distance_eau, 
             data = nb_obs_rag_distance_eau_dt),
          lm(nb_obs_esp_par_piege_par_jour ~ distance_eau + I(distance_eau^2), 
             data = nb_obs_rag_distance_eau_dt),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Ragondin)")
```

### ~ semaine de pose 

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
nb_obs_rag_dt <- nb_obs_rag_dt %>% 
   mutate(week = week(date_pose))

nb_obs_rag_week_dt <- nb_obs_rag_dt %>% 
  select(espece, ID_unique, week, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

rag_nb_obs_esp_moy_week_plot <- ggplot(data = nb_obs_rag_week_dt,
             aes(week, nb_obs_esp_par_piege_par_jour)) +
  geom_point(size = 4, shape = 21, fill = "grey") +
  geom_smooth(method = lm, linetype = "dotted") +
  facet_wrap(~ espece, ncol = 5) +
  ylab("Nombre d'observation /piège/jour") + xlab("Semaine de pose") +
  theme_classic() ; rag_nb_obs_esp_moy_week_plot
```

Modèles pour chaque espèce séparemment :

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=7}

tab_model(lm(nb_obs_esp_par_piege_par_jour ~ week,
             data = nb_obs_rag_week_dt),
          title = "Nombre d'observation/piège/jour en fonction de la hauteur de la semaine de l'année (Ragondin)")
```

### ~ DAC interaction 

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# data
nb_obs_rag_DAC_dt <- nb_obs_rag_dt %>% 
  select(ID_unique, DAC_interaction, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

# plot
rag_nb_obs_DAC_plot2 <- ggplot(nb_obs_rag_DAC_dt, aes(DAC_interaction, nb_obs_esp_par_piege_par_jour)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(width = 0.2, height = 0.2, size = 1, fill = "white", shape = 21) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1.5, color="red", fill="red") +
  geom_signif(comparisons = list(c("oui", "non")),
              map_signif_level=TRUE,
              y_position = 3, color = "black",
              test = "t.test") +
  ylim(-0.3, 4) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(title="",
        x ="Intéraction avec le DAC", y = "Nombre d'observation /piège/jour"); rag_nb_obs_DAC_plot2
```

### ~ coulée 

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
# data
nb_obs_rag_coulee_dt <- nb_obs_rag_dt %>% 
  select(espece, ID_unique, coulee, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

rag_nb_obs_esp_moy_coulee_plot <- ggplot(data = nb_obs_rag_coulee_dt, aes(coulee, nb_obs_esp_par_piege_par_jour)) +
  geom_boxplot(fill = "grey", outliers = FALSE) +
  geom_jitter(width = 0.2, height = 0.2,
             color = "black", fill = "white", shape = 21, size = 1) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=20, size=1.5, color="red", fill="red") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=1.5, color="red", fill="red", size = 2) +
  geom_signif(comparisons = list(c("oui", "non")),
              map_signif_level=TRUE,
              y_position = 3.5, color = "black",
              test = "t.test") +
  ylab("Nombre d'observation /piège/jour") + xlab("Coulée à proximité") +
  theme_classic() +
  ylim(-0.3, 4.5) ; rag_nb_obs_esp_moy_coulee_plot
```

Modèles pour chaque espéce séparemment :

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=7}
tab_model(lm(nb_obs_esp_par_piege_par_jour ~ coulee, 
             data = nb_obs_rag_coulee_dt),
          title = "Nombre d'observation /piège/jour en fonction de la hauteur d'installation (Ragondin)")
```

### ~ heure 

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=5, fig.height=5}
nb_obs_rag_hour_obs_dt <- nb_obs_rag_dt %>% 
  select(espece, ID_unique, hour_obs, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

rag_nb_obs_esp_moy_hour_obs_plot2 <- ggplot(data = nb_obs_rag_hour_obs_dt, aes(x = hour_obs, y=nb_obs_esp_par_piege_par_jour)) +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "pointrange", shape=21, size=1, color="black", fill="red") +
  stat_summary(fun.y = mean,
               fun.ymin = function(x) mean(x) - sd(x), 
               fun.ymax = function(x) mean(x) + sd(x), 
               geom = "linerange", shape=20, size=.5, color="red", fill="red") +
  geom_jitter(shape = 21, fill = "grey", size = 1, width = 0.2, height = 0.2) +
  theme_classic() +
  facet_wrap(~ espece, ncol = 5) +
  labs(title="Nombre d'observation /piège/jour 
en fonction de l'heure",
        x ="Heure", y = "Nombre d'observation 
par piège par jour d'observation", fill=""); rag_nb_obs_esp_moy_hour_obs_plot2
```

### ~ temperature 

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=3.5, fig.height=3.5}
nb_obs_rag_temp_dt <- nb_obs_rag_dt %>% 
  select(espece, ID_unique, temp, nb_obs_esp_par_piege_par_jour) %>% 
  distinct() %>% 
  na.omit()

rag_nb_obs_moy_temp_esp_plot <- ggplot(nb_obs_rag_temp_dt, 
                               aes(temp, nb_obs_esp_par_piege_par_jour)) +
  geom_jitter(width = 0.2, height = 0.2, shape = 21, fill = "grey", color = "black") +
  geom_smooth(method = lm, linetype = "dotted") +
  facet_wrap(~ espece, ncol = 5) +
  ylab("Nombre d'observation /piège/jour") + xlab("Température") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)); rag_nb_obs_moy_temp_esp_plot
```

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=10, fig.height=7}
tab_model(lm(nb_obs_esp_par_piege_par_jour ~ temp, 
             data = nb_obs_rag_temp_dt),
          lm(nb_obs_esp_par_piege_par_jour ~ temp + I(temp^2), 
             data = nb_obs_rag_temp_dt),
          title = "Nombre d'observation /piège/jour en fonction de la température (Ragondin)")
```

### ~ all covariables 

```{r, echo=FALSE,message=FALSE, warning=FALSE,fig.width=6, fig.height=6}
# table(nb_obs_esp_dt$espece)

# Belette d'Europe
rag_nb_obs_esp_dregde_BEL_dt <- nb_obs_rag_dt %>% 
  select(nb_obs_esp_par_piege_par_jour, 
         hauteur, support, habitat, 
         distance_eau, week, DAC_interaction) %>% 
  na.omit()

rag_nb_obs_esp_dregde_BEL_dt <- rag_nb_obs_esp_dregde_BEL_dt[,c(2:7)]
options(na.action = "na.fail")
rag_nb_obs.fullmodel <- lm(nb_obs_esp_par_piege_par_jour ~., data = rag_nb_obs_esp_dregde_BEL_dt)
rag_nb_obs.dredge <- dredge(rag_nb_obs.fullmodel, rank = "AIC")
print("Ragondin")
print("Le plus simple des meilleurs modèles")
rag_list_best_model <- rag_nb_obs.dredge[rag_nb_obs.dredge$delta<2]
rag_best_model <- rag_list_best_model[rag_list_best_model$df==min(rag_list_best_model$df)] ; rag_best_model
```

## Naive occupancy

```{r, echo=FALSE}
rag_naive_occ_dt <- data_4 %>% 
  filter(espece == "Ragondin") %>% 
  select(espece, ID_unique, espece, list_1)

nb_piege <- length(unique(naive_occ_dt$ID_unique))

rag_naive_occ_dt <- rag_naive_occ_dt %>% 
  group_by(espece) %>% 
  mutate(nb_pige_esp = length(unique(ID_unique))) %>% 
  mutate(naive_occ = nb_pige_esp/nb_piege) %>% 
  distinct()
```

Naïce occupancy du ragondin : 

```{r, echo=FALSE}
unique(rag_naive_occ_dt$naive_occ)
```

```{r, echo=FALSE}
```


